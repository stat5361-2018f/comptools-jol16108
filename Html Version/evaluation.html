<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Advanced R</title>
  <meta name="description" content="The book is designed primarily for R users who want to improve their programming skills and understanding of the language. It should also be useful for programmers coming to R from other languages, as it explains some of R’s quirks and shows how some parts that seem horrible do have a positive side.">
  <meta name="generator" content="bookdown 0.7 and GitBook 2.6.7">

  <meta property="og:title" content="Advanced R" />
  <meta property="og:type" content="book" />
  <meta property="og:url" content="https://adv-r.hadley.nz/" />
  <meta property="og:image" content="https://adv-r.hadley.nz/cover.png" />
  <meta property="og:description" content="The book is designed primarily for R users who want to improve their programming skills and understanding of the language. It should also be useful for programmers coming to R from other languages, as it explains some of R’s quirks and shows how some parts that seem horrible do have a positive side." />
  <meta name="github-repo" content="hadley/adv-r" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Advanced R" />
  <meta name="twitter:site" content="@hadley" />
  <meta name="twitter:description" content="The book is designed primarily for R users who want to improve their programming skills and understanding of the language. It should also be useful for programmers coming to R from other languages, as it explains some of R’s quirks and shows how some parts that seem horrible do have a positive side." />
  <meta name="twitter:image" content="https://adv-r.hadley.nz/cover.png" />

<meta name="author" content="Hadley Wickham">



  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="quasiquotation.html">
<link rel="next" href="translation.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="adv-r.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">Advanced R</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#other-books"><i class="fa fa-check"></i>Other books</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="preface.html"><a href="preface.html"><i class="fa fa-check"></i><b>1</b> Preface</a><ul>
<li class="chapter" data-level="1.1" data-path="preface.html"><a href="preface.html#rlang"><i class="fa fa-check"></i><b>1.1</b> rlang</a></li>
<li class="chapter" data-level="1.2" data-path="preface.html"><a href="preface.html#foundations"><i class="fa fa-check"></i><b>1.2</b> Foundations</a></li>
<li class="chapter" data-level="1.3" data-path="preface.html"><a href="preface.html#programming-paradigms"><i class="fa fa-check"></i><b>1.3</b> Programming paradigms</a></li>
<li class="chapter" data-level="1.4" data-path="preface.html"><a href="preface.html#techniques"><i class="fa fa-check"></i><b>1.4</b> Techniques</a></li>
<li class="chapter" data-level="1.5" data-path="preface.html"><a href="preface.html#removals"><i class="fa fa-check"></i><b>1.5</b> Removals</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>2</b> Introduction</a><ul>
<li class="chapter" data-level="2.1" data-path="introduction.html"><a href="introduction.html#who-should-read"><i class="fa fa-check"></i><b>2.1</b> Who should read this book</a></li>
<li class="chapter" data-level="2.2" data-path="introduction.html"><a href="introduction.html#related-work"><i class="fa fa-check"></i><b>2.2</b> Related work</a></li>
<li class="chapter" data-level="2.3" data-path="introduction.html"><a href="introduction.html#what-you-will-get"><i class="fa fa-check"></i><b>2.3</b> What you will get out of this book</a></li>
<li class="chapter" data-level="2.4" data-path="introduction.html"><a href="introduction.html#meta-techniques"><i class="fa fa-check"></i><b>2.4</b> Meta-techniques</a></li>
<li class="chapter" data-level="2.5" data-path="introduction.html"><a href="introduction.html#recommended-reading"><i class="fa fa-check"></i><b>2.5</b> Recommended reading</a></li>
<li class="chapter" data-level="2.6" data-path="introduction.html"><a href="introduction.html#getting-help"><i class="fa fa-check"></i><b>2.6</b> Getting help</a></li>
<li class="chapter" data-level="2.7" data-path="introduction.html"><a href="introduction.html#intro-ack"><i class="fa fa-check"></i><b>2.7</b> Acknowledgments</a></li>
<li class="chapter" data-level="2.8" data-path="introduction.html"><a href="introduction.html#conventions"><i class="fa fa-check"></i><b>2.8</b> Conventions</a></li>
<li class="chapter" data-level="2.9" data-path="introduction.html"><a href="introduction.html#colophon"><i class="fa fa-check"></i><b>2.9</b> Colophon</a></li>
</ul></li>
<li class="part"><span><b>I Foundations</b></span></li>
<li class="chapter" data-level="" data-path="foundations-intro.html"><a href="foundations-intro.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="3" data-path="names-values.html"><a href="names-values.html"><i class="fa fa-check"></i><b>3</b> Names and values</a><ul>
<li class="chapter" data-level="3.1" data-path="names-values.html"><a href="names-values.html#introduction-1"><i class="fa fa-check"></i><b>3.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="names-values.html"><a href="names-values.html#quiz"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="names-values.html"><a href="names-values.html#outline"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="names-values.html"><a href="names-values.html#prerequisites"><i class="fa fa-check"></i>Prerequisites</a></li>
<li class="chapter" data-level="" data-path="names-values.html"><a href="names-values.html#sources"><i class="fa fa-check"></i>Sources</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="names-values.html"><a href="names-values.html#binding-basics"><i class="fa fa-check"></i><b>3.2</b> Binding basics</a><ul>
<li class="chapter" data-level="3.2.1" data-path="names-values.html"><a href="names-values.html#non-syntactic"><i class="fa fa-check"></i><b>3.2.1</b> Non-syntactic names</a></li>
<li class="chapter" data-level="3.2.2" data-path="names-values.html"><a href="names-values.html#exercises"><i class="fa fa-check"></i><b>3.2.2</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="names-values.html"><a href="names-values.html#copy-on-modify"><i class="fa fa-check"></i><b>3.3</b> Copy-on-modify</a><ul>
<li class="chapter" data-level="3.3.1" data-path="names-values.html"><a href="names-values.html#tracemem"><i class="fa fa-check"></i><b>3.3.1</b> <code>tracemem()</code></a></li>
<li class="chapter" data-level="3.3.2" data-path="names-values.html"><a href="names-values.html#function-calls"><i class="fa fa-check"></i><b>3.3.2</b> Function calls</a></li>
<li class="chapter" data-level="3.3.3" data-path="names-values.html"><a href="names-values.html#list-references"><i class="fa fa-check"></i><b>3.3.3</b> Lists</a></li>
<li class="chapter" data-level="3.3.4" data-path="names-values.html"><a href="names-values.html#df-modify"><i class="fa fa-check"></i><b>3.3.4</b> Data frames</a></li>
<li class="chapter" data-level="3.3.5" data-path="names-values.html"><a href="names-values.html#character-vectors"><i class="fa fa-check"></i><b>3.3.5</b> Character vectors</a></li>
<li class="chapter" data-level="3.3.6" data-path="names-values.html"><a href="names-values.html#exercises-1"><i class="fa fa-check"></i><b>3.3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="names-values.html"><a href="names-values.html#object-size"><i class="fa fa-check"></i><b>3.4</b> Object size</a><ul>
<li class="chapter" data-level="3.4.1" data-path="names-values.html"><a href="names-values.html#exercises-2"><i class="fa fa-check"></i><b>3.4.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.5" data-path="names-values.html"><a href="names-values.html#modify-in-place"><i class="fa fa-check"></i><b>3.5</b> Modify-in-place</a><ul>
<li class="chapter" data-level="3.5.1" data-path="names-values.html"><a href="names-values.html#single-binding"><i class="fa fa-check"></i><b>3.5.1</b> Objects with a single binding</a></li>
<li class="chapter" data-level="3.5.2" data-path="names-values.html"><a href="names-values.html#env-modify"><i class="fa fa-check"></i><b>3.5.2</b> Environments</a></li>
<li class="chapter" data-level="3.5.3" data-path="names-values.html"><a href="names-values.html#exercises-3"><i class="fa fa-check"></i><b>3.5.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="names-values.html"><a href="names-values.html#gc"><i class="fa fa-check"></i><b>3.6</b> Unbinding and the garbage collector</a></li>
<li class="chapter" data-level="3.7" data-path="names-values.html"><a href="names-values.html#names-values-answers"><i class="fa fa-check"></i><b>3.7</b> Answers</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="vectors-chap.html"><a href="vectors-chap.html"><i class="fa fa-check"></i><b>4</b> Vectors</a><ul>
<li class="chapter" data-level="4.1" data-path="vectors-chap.html"><a href="vectors-chap.html#introduction-2"><i class="fa fa-check"></i><b>4.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="vectors-chap.html"><a href="vectors-chap.html#quiz-1"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="vectors-chap.html"><a href="vectors-chap.html#outline-1"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="vectors-chap.html"><a href="vectors-chap.html#atomic-vectors"><i class="fa fa-check"></i><b>4.2</b> Atomic vectors</a><ul>
<li class="chapter" data-level="4.2.1" data-path="vectors-chap.html"><a href="vectors-chap.html#scalars"><i class="fa fa-check"></i><b>4.2.1</b> Scalars</a></li>
<li class="chapter" data-level="4.2.2" data-path="vectors-chap.html"><a href="vectors-chap.html#atomic-constructing"><i class="fa fa-check"></i><b>4.2.2</b> Making longer vectors with <code>c()</code></a></li>
<li class="chapter" data-level="4.2.3" data-path="vectors-chap.html"><a href="vectors-chap.html#testing-and-coercing"><i class="fa fa-check"></i><b>4.2.3</b> Testing and coercing</a></li>
<li class="chapter" data-level="4.2.4" data-path="vectors-chap.html"><a href="vectors-chap.html#exercises-4"><i class="fa fa-check"></i><b>4.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="vectors-chap.html"><a href="vectors-chap.html#attributes"><i class="fa fa-check"></i><b>4.3</b> Attributes</a><ul>
<li class="chapter" data-level="4.3.1" data-path="vectors-chap.html"><a href="vectors-chap.html#getting-and-setting"><i class="fa fa-check"></i><b>4.3.1</b> Getting and setting</a></li>
<li class="chapter" data-level="4.3.2" data-path="vectors-chap.html"><a href="vectors-chap.html#attr-names"><i class="fa fa-check"></i><b>4.3.2</b> Names</a></li>
<li class="chapter" data-level="4.3.3" data-path="vectors-chap.html"><a href="vectors-chap.html#attr-dims"><i class="fa fa-check"></i><b>4.3.3</b> Dimensions</a></li>
<li class="chapter" data-level="4.3.4" data-path="vectors-chap.html"><a href="vectors-chap.html#exercises-5"><i class="fa fa-check"></i><b>4.3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="vectors-chap.html"><a href="vectors-chap.html#s3-atomic-vectors"><i class="fa fa-check"></i><b>4.4</b> S3 atomic vectors</a><ul>
<li class="chapter" data-level="4.4.1" data-path="vectors-chap.html"><a href="vectors-chap.html#factors"><i class="fa fa-check"></i><b>4.4.1</b> Factors</a></li>
<li class="chapter" data-level="4.4.2" data-path="vectors-chap.html"><a href="vectors-chap.html#dates"><i class="fa fa-check"></i><b>4.4.2</b> Dates</a></li>
<li class="chapter" data-level="4.4.3" data-path="vectors-chap.html"><a href="vectors-chap.html#date-times"><i class="fa fa-check"></i><b>4.4.3</b> Date-times</a></li>
<li class="chapter" data-level="4.4.4" data-path="vectors-chap.html"><a href="vectors-chap.html#exercises-6"><i class="fa fa-check"></i><b>4.4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="vectors-chap.html"><a href="vectors-chap.html#lists"><i class="fa fa-check"></i><b>4.5</b> Lists</a><ul>
<li class="chapter" data-level="4.5.1" data-path="vectors-chap.html"><a href="vectors-chap.html#list-creating"><i class="fa fa-check"></i><b>4.5.1</b> Creating</a></li>
<li class="chapter" data-level="4.5.2" data-path="vectors-chap.html"><a href="vectors-chap.html#list-types"><i class="fa fa-check"></i><b>4.5.2</b> Testing and coercing</a></li>
<li class="chapter" data-level="4.5.3" data-path="vectors-chap.html"><a href="vectors-chap.html#list-array"><i class="fa fa-check"></i><b>4.5.3</b> Matrices and arrays</a></li>
<li class="chapter" data-level="4.5.4" data-path="vectors-chap.html"><a href="vectors-chap.html#exercises-7"><i class="fa fa-check"></i><b>4.5.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.6" data-path="vectors-chap.html"><a href="vectors-chap.html#tibble"><i class="fa fa-check"></i><b>4.6</b> Data frames and tibbles</a><ul>
<li class="chapter" data-level="4.6.1" data-path="vectors-chap.html"><a href="vectors-chap.html#df-create"><i class="fa fa-check"></i><b>4.6.1</b> Creating</a></li>
<li class="chapter" data-level="4.6.2" data-path="vectors-chap.html"><a href="vectors-chap.html#rownames"><i class="fa fa-check"></i><b>4.6.2</b> Row names</a></li>
<li class="chapter" data-level="4.6.3" data-path="vectors-chap.html"><a href="vectors-chap.html#printing"><i class="fa fa-check"></i><b>4.6.3</b> Printing</a></li>
<li class="chapter" data-level="4.6.4" data-path="vectors-chap.html"><a href="vectors-chap.html#safe-subsetting"><i class="fa fa-check"></i><b>4.6.4</b> Subsetting</a></li>
<li class="chapter" data-level="4.6.5" data-path="vectors-chap.html"><a href="vectors-chap.html#df-test-coerce"><i class="fa fa-check"></i><b>4.6.5</b> Testing and coercing</a></li>
<li class="chapter" data-level="4.6.6" data-path="vectors-chap.html"><a href="vectors-chap.html#list-columns"><i class="fa fa-check"></i><b>4.6.6</b> List columns</a></li>
<li class="chapter" data-level="4.6.7" data-path="vectors-chap.html"><a href="vectors-chap.html#matrix-and-data-frame-columns"><i class="fa fa-check"></i><b>4.6.7</b> Matrix and data frame columns</a></li>
<li class="chapter" data-level="4.6.8" data-path="vectors-chap.html"><a href="vectors-chap.html#exercises-8"><i class="fa fa-check"></i><b>4.6.8</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="4.7" data-path="vectors-chap.html"><a href="vectors-chap.html#null"><i class="fa fa-check"></i><b>4.7</b> <code>NULL</code></a></li>
<li class="chapter" data-level="4.8" data-path="vectors-chap.html"><a href="vectors-chap.html#data-structure-answers"><i class="fa fa-check"></i><b>4.8</b> Answers</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="subsetting.html"><a href="subsetting.html"><i class="fa fa-check"></i><b>5</b> Subsetting</a><ul>
<li class="chapter" data-level="5.1" data-path="subsetting.html"><a href="subsetting.html#introduction-3"><i class="fa fa-check"></i><b>5.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#quiz-2"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#outline-2"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="subsetting.html"><a href="subsetting.html#subset-multiple"><i class="fa fa-check"></i><b>5.2</b> Selecting multiple elements</a><ul>
<li class="chapter" data-level="5.2.1" data-path="subsetting.html"><a href="subsetting.html#atomic-vectors-1"><i class="fa fa-check"></i><b>5.2.1</b> Atomic vectors</a></li>
<li class="chapter" data-level="5.2.2" data-path="subsetting.html"><a href="subsetting.html#lists-1"><i class="fa fa-check"></i><b>5.2.2</b> Lists</a></li>
<li class="chapter" data-level="5.2.3" data-path="subsetting.html"><a href="subsetting.html#matrix-subsetting"><i class="fa fa-check"></i><b>5.2.3</b> Matrices and arrays</a></li>
<li class="chapter" data-level="5.2.4" data-path="subsetting.html"><a href="subsetting.html#df-subsetting"><i class="fa fa-check"></i><b>5.2.4</b> Data frames and tibbles</a></li>
<li class="chapter" data-level="5.2.5" data-path="subsetting.html"><a href="subsetting.html#simplify-preserve"><i class="fa fa-check"></i><b>5.2.5</b> Preserving dimensionality</a></li>
<li class="chapter" data-level="5.2.6" data-path="subsetting.html"><a href="subsetting.html#exercises-9"><i class="fa fa-check"></i><b>5.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="subsetting.html"><a href="subsetting.html#subset-single"><i class="fa fa-check"></i><b>5.3</b> Selecting a single element</a><ul>
<li class="chapter" data-level="5.3.1" data-path="subsetting.html"><a href="subsetting.html#section"><i class="fa fa-check"></i><b>5.3.1</b> <code>[[</code></a></li>
<li class="chapter" data-level="5.3.2" data-path="subsetting.html"><a href="subsetting.html#section-1"><i class="fa fa-check"></i><b>5.3.2</b> <code>$</code></a></li>
<li class="chapter" data-level="5.3.3" data-path="subsetting.html"><a href="subsetting.html#missingout-of-bounds-indices"><i class="fa fa-check"></i><b>5.3.3</b> Missing/out of bounds indices</a></li>
<li class="chapter" data-level="5.3.4" data-path="subsetting.html"><a href="subsetting.html#and-slot"><i class="fa fa-check"></i><b>5.3.4</b> <code>@</code> and <code>slot()</code></a></li>
<li class="chapter" data-level="5.3.5" data-path="subsetting.html"><a href="subsetting.html#exercises-10"><i class="fa fa-check"></i><b>5.3.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.4" data-path="subsetting.html"><a href="subsetting.html#subassignment"><i class="fa fa-check"></i><b>5.4</b> Subsetting and assignment</a></li>
<li class="chapter" data-level="5.5" data-path="subsetting.html"><a href="subsetting.html#applications"><i class="fa fa-check"></i><b>5.5</b> Applications</a><ul>
<li class="chapter" data-level="5.5.1" data-path="subsetting.html"><a href="subsetting.html#lookup-tables"><i class="fa fa-check"></i><b>5.5.1</b> Lookup tables (character subsetting)</a></li>
<li class="chapter" data-level="5.5.2" data-path="subsetting.html"><a href="subsetting.html#matching-merging"><i class="fa fa-check"></i><b>5.5.2</b> Matching and merging by hand (integer subsetting)</a></li>
<li class="chapter" data-level="5.5.3" data-path="subsetting.html"><a href="subsetting.html#random-samplesbootstraps-integer-subsetting"><i class="fa fa-check"></i><b>5.5.3</b> Random samples/bootstraps (integer subsetting)</a></li>
<li class="chapter" data-level="5.5.4" data-path="subsetting.html"><a href="subsetting.html#ordering-integer-subsetting"><i class="fa fa-check"></i><b>5.5.4</b> Ordering (integer subsetting)</a></li>
<li class="chapter" data-level="5.5.5" data-path="subsetting.html"><a href="subsetting.html#expanding-aggregated-counts-integer-subsetting"><i class="fa fa-check"></i><b>5.5.5</b> Expanding aggregated counts (integer subsetting)</a></li>
<li class="chapter" data-level="5.5.6" data-path="subsetting.html"><a href="subsetting.html#removing-columns-from-data-frames-character-subsetting"><i class="fa fa-check"></i><b>5.5.6</b> Removing columns from data frames (character subsetting)</a></li>
<li class="chapter" data-level="5.5.7" data-path="subsetting.html"><a href="subsetting.html#selecting-rows-based-on-a-condition-logical-subsetting"><i class="fa fa-check"></i><b>5.5.7</b> Selecting rows based on a condition (logical subsetting)</a></li>
<li class="chapter" data-level="5.5.8" data-path="subsetting.html"><a href="subsetting.html#boolean-algebra-vs.sets-logical-integer-subsetting"><i class="fa fa-check"></i><b>5.5.8</b> Boolean algebra vs. sets (logical &amp; integer subsetting)</a></li>
<li class="chapter" data-level="5.5.9" data-path="subsetting.html"><a href="subsetting.html#exercises-11"><i class="fa fa-check"></i><b>5.5.9</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="5.6" data-path="subsetting.html"><a href="subsetting.html#subsetting-answers"><i class="fa fa-check"></i><b>5.6</b> Answers</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>6</b> Functions</a><ul>
<li class="chapter" data-level="6.1" data-path="functions.html"><a href="functions.html#introduction-4"><i class="fa fa-check"></i><b>6.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#quiz-3"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#outline-3"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="functions.html"><a href="functions.html#function-fundamentals"><i class="fa fa-check"></i><b>6.2</b> Function fundamentals</a><ul>
<li class="chapter" data-level="6.2.1" data-path="functions.html"><a href="functions.html#first-class-functions"><i class="fa fa-check"></i><b>6.2.1</b> First-class functions</a></li>
<li class="chapter" data-level="6.2.2" data-path="functions.html"><a href="functions.html#function-components"><i class="fa fa-check"></i><b>6.2.2</b> Function components</a></li>
<li class="chapter" data-level="6.2.3" data-path="functions.html"><a href="functions.html#primitive-functions"><i class="fa fa-check"></i><b>6.2.3</b> Primitive functions</a></li>
<li class="chapter" data-level="6.2.4" data-path="functions.html"><a href="functions.html#exercises-12"><i class="fa fa-check"></i><b>6.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="functions.html"><a href="functions.html#lexical-scoping"><i class="fa fa-check"></i><b>6.3</b> Lexical scoping</a><ul>
<li class="chapter" data-level="6.3.1" data-path="functions.html"><a href="functions.html#name-masking"><i class="fa fa-check"></i><b>6.3.1</b> Name masking</a></li>
<li class="chapter" data-level="6.3.2" data-path="functions.html"><a href="functions.html#functions-vs.variables"><i class="fa fa-check"></i><b>6.3.2</b> Functions vs. variables</a></li>
<li class="chapter" data-level="6.3.3" data-path="functions.html"><a href="functions.html#fresh-start"><i class="fa fa-check"></i><b>6.3.3</b> A fresh start</a></li>
<li class="chapter" data-level="6.3.4" data-path="functions.html"><a href="functions.html#dynamic-lookup"><i class="fa fa-check"></i><b>6.3.4</b> Dynamic lookup</a></li>
<li class="chapter" data-level="6.3.5" data-path="functions.html"><a href="functions.html#exercises-13"><i class="fa fa-check"></i><b>6.3.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="functions.html"><a href="functions.html#lazy-evaluation"><i class="fa fa-check"></i><b>6.4</b> Lazy evaluation</a><ul>
<li class="chapter" data-level="6.4.1" data-path="functions.html"><a href="functions.html#forcing-evaluation"><i class="fa fa-check"></i><b>6.4.1</b> Forcing evaluation</a></li>
<li class="chapter" data-level="6.4.2" data-path="functions.html"><a href="functions.html#promises"><i class="fa fa-check"></i><b>6.4.2</b> Promises</a></li>
<li class="chapter" data-level="6.4.3" data-path="functions.html"><a href="functions.html#default-arguments"><i class="fa fa-check"></i><b>6.4.3</b> Default arguments</a></li>
<li class="chapter" data-level="6.4.4" data-path="functions.html"><a href="functions.html#missing-arguments"><i class="fa fa-check"></i><b>6.4.4</b> Missing arguments</a></li>
<li class="chapter" data-level="6.4.5" data-path="functions.html"><a href="functions.html#exercises-14"><i class="fa fa-check"></i><b>6.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="functions.html"><a href="functions.html#fun-dot-dot-dot"><i class="fa fa-check"></i><b>6.5</b> <code>...</code> (dot-dot-dot)</a><ul>
<li class="chapter" data-level="6.5.1" data-path="functions.html"><a href="functions.html#exercises-15"><i class="fa fa-check"></i><b>6.5.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="functions.html"><a href="functions.html#exiting-a-function"><i class="fa fa-check"></i><b>6.6</b> Exiting a function</a><ul>
<li class="chapter" data-level="6.6.1" data-path="functions.html"><a href="functions.html#implicit-vs.explict-returns"><i class="fa fa-check"></i><b>6.6.1</b> Implicit vs. explict returns</a></li>
<li class="chapter" data-level="6.6.2" data-path="functions.html"><a href="functions.html#invisible-values"><i class="fa fa-check"></i><b>6.6.2</b> Invisible values</a></li>
<li class="chapter" data-level="6.6.3" data-path="functions.html"><a href="functions.html#errors"><i class="fa fa-check"></i><b>6.6.3</b> Errors</a></li>
<li class="chapter" data-level="6.6.4" data-path="functions.html"><a href="functions.html#on-exit"><i class="fa fa-check"></i><b>6.6.4</b> Exit handlers</a></li>
<li class="chapter" data-level="6.6.5" data-path="functions.html"><a href="functions.html#exercises-16"><i class="fa fa-check"></i><b>6.6.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.7" data-path="functions.html"><a href="functions.html#function-forms"><i class="fa fa-check"></i><b>6.7</b> Function forms</a><ul>
<li class="chapter" data-level="6.7.1" data-path="functions.html"><a href="functions.html#rewriting-to-prefix-form"><i class="fa fa-check"></i><b>6.7.1</b> Rewriting to prefix form</a></li>
<li class="chapter" data-level="6.7.2" data-path="functions.html"><a href="functions.html#prefix-form-prefix-form"><i class="fa fa-check"></i><b>6.7.2</b> Prefix form {prefix-form}</a></li>
<li class="chapter" data-level="6.7.3" data-path="functions.html"><a href="functions.html#infix-functions"><i class="fa fa-check"></i><b>6.7.3</b> Infix functions</a></li>
<li class="chapter" data-level="6.7.4" data-path="functions.html"><a href="functions.html#replacement-functions"><i class="fa fa-check"></i><b>6.7.4</b> Replacement functions</a></li>
<li class="chapter" data-level="6.7.5" data-path="functions.html"><a href="functions.html#special-forms"><i class="fa fa-check"></i><b>6.7.5</b> Special forms</a></li>
</ul></li>
<li class="chapter" data-level="6.8" data-path="functions.html"><a href="functions.html#invoking-a-function"><i class="fa fa-check"></i><b>6.8</b> Invoking a function</a><ul>
<li class="chapter" data-level="6.8.1" data-path="functions.html"><a href="functions.html#exercises-17"><i class="fa fa-check"></i><b>6.8.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="6.9" data-path="functions.html"><a href="functions.html#function-answers"><i class="fa fa-check"></i><b>6.9</b> Quiz answers</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="environments.html"><a href="environments.html"><i class="fa fa-check"></i><b>7</b> Environments</a><ul>
<li class="chapter" data-level="7.1" data-path="environments.html"><a href="environments.html#introduction-5"><i class="fa fa-check"></i><b>7.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#quiz-4"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#outline-4"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#prerequisites-1"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="7.2" data-path="environments.html"><a href="environments.html#env-basics"><i class="fa fa-check"></i><b>7.2</b> Environment basics</a><ul>
<li class="chapter" data-level="7.2.1" data-path="environments.html"><a href="environments.html#basics"><i class="fa fa-check"></i><b>7.2.1</b> Basics</a></li>
<li class="chapter" data-level="7.2.2" data-path="environments.html"><a href="environments.html#important-environments"><i class="fa fa-check"></i><b>7.2.2</b> Important environments</a></li>
<li class="chapter" data-level="7.2.3" data-path="environments.html"><a href="environments.html#parents"><i class="fa fa-check"></i><b>7.2.3</b> Parents</a></li>
<li class="chapter" data-level="7.2.4" data-path="environments.html"><a href="environments.html#getting-and-setting-1"><i class="fa fa-check"></i><b>7.2.4</b> Getting and setting</a></li>
<li class="chapter" data-level="7.2.5" data-path="environments.html"><a href="environments.html#finalisers"><i class="fa fa-check"></i><b>7.2.5</b> Finalisers</a></li>
<li class="chapter" data-level="7.2.6" data-path="environments.html"><a href="environments.html#advanced-bindings"><i class="fa fa-check"></i><b>7.2.6</b> Advanced bindings</a></li>
<li class="chapter" data-level="7.2.7" data-path="environments.html"><a href="environments.html#exercises-18"><i class="fa fa-check"></i><b>7.2.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="environments.html"><a href="environments.html#env-recursion"><i class="fa fa-check"></i><b>7.3</b> Recursing over environments</a><ul>
<li class="chapter" data-level="7.3.1" data-path="environments.html"><a href="environments.html#exercises-19"><i class="fa fa-check"></i><b>7.3.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="environments.html"><a href="environments.html#function-envs"><i class="fa fa-check"></i><b>7.4</b> Special environments</a><ul>
<li class="chapter" data-level="7.4.1" data-path="environments.html"><a href="environments.html#package-environments-and-the-search-path"><i class="fa fa-check"></i><b>7.4.1</b> Package environments and the search path</a></li>
<li class="chapter" data-level="7.4.2" data-path="environments.html"><a href="environments.html#the-function-environment"><i class="fa fa-check"></i><b>7.4.2</b> The function environment</a></li>
<li class="chapter" data-level="7.4.3" data-path="environments.html"><a href="environments.html#namespaces"><i class="fa fa-check"></i><b>7.4.3</b> Namespaces</a></li>
<li class="chapter" data-level="7.4.4" data-path="environments.html"><a href="environments.html#execution-environments"><i class="fa fa-check"></i><b>7.4.4</b> Execution environments</a></li>
<li class="chapter" data-level="7.4.5" data-path="environments.html"><a href="environments.html#exercises-20"><i class="fa fa-check"></i><b>7.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="environments.html"><a href="environments.html#the-call-stack"><i class="fa fa-check"></i><b>7.5</b> The call stack</a><ul>
<li class="chapter" data-level="7.5.1" data-path="environments.html"><a href="environments.html#simple-call-stacks"><i class="fa fa-check"></i><b>7.5.1</b> Simple call stacks</a></li>
<li class="chapter" data-level="7.5.2" data-path="environments.html"><a href="environments.html#lazy-evaluation-1"><i class="fa fa-check"></i><b>7.5.2</b> Lazy evaluation</a></li>
<li class="chapter" data-level="7.5.3" data-path="environments.html"><a href="environments.html#frames"><i class="fa fa-check"></i><b>7.5.3</b> Frames</a></li>
<li class="chapter" data-level="7.5.4" data-path="environments.html"><a href="environments.html#dynamic-scope"><i class="fa fa-check"></i><b>7.5.4</b> Dynamic scope</a></li>
<li class="chapter" data-level="7.5.5" data-path="environments.html"><a href="environments.html#exercises-21"><i class="fa fa-check"></i><b>7.5.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.6" data-path="environments.html"><a href="environments.html#explicit-envs"><i class="fa fa-check"></i><b>7.6</b> As data structures</a></li>
<li class="chapter" data-level="7.7" data-path="environments.html"><a href="environments.html#section-2"><i class="fa fa-check"></i><b>7.7</b> <code>&lt;&lt;-</code></a><ul>
<li class="chapter" data-level="7.7.1" data-path="environments.html"><a href="environments.html#exercises-22"><i class="fa fa-check"></i><b>7.7.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="7.8" data-path="environments.html"><a href="environments.html#env-answers"><i class="fa fa-check"></i><b>7.8</b> Quiz answers</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="conditions.html"><a href="conditions.html"><i class="fa fa-check"></i><b>8</b> Conditions</a><ul>
<li class="chapter" data-level="8.1" data-path="conditions.html"><a href="conditions.html#introduction-6"><i class="fa fa-check"></i><b>8.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#quiz-5"><i class="fa fa-check"></i>Quiz</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#overview"><i class="fa fa-check"></i>Overview</a></li>
<li class="chapter" data-level="8.1.1" data-path="conditions.html"><a href="conditions.html#prerequisites-2"><i class="fa fa-check"></i><b>8.1.1</b> Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="conditions.html"><a href="conditions.html#signalling-conditions"><i class="fa fa-check"></i><b>8.2</b> Signalling conditions</a><ul>
<li class="chapter" data-level="8.2.1" data-path="conditions.html"><a href="conditions.html#errors-1"><i class="fa fa-check"></i><b>8.2.1</b> Errors</a></li>
<li class="chapter" data-level="8.2.2" data-path="conditions.html"><a href="conditions.html#warnings"><i class="fa fa-check"></i><b>8.2.2</b> Warnings</a></li>
<li class="chapter" data-level="8.2.3" data-path="conditions.html"><a href="conditions.html#messages"><i class="fa fa-check"></i><b>8.2.3</b> Messages</a></li>
<li class="chapter" data-level="8.2.4" data-path="conditions.html"><a href="conditions.html#exercises-23"><i class="fa fa-check"></i><b>8.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="conditions.html"><a href="conditions.html#ignoring-conditions"><i class="fa fa-check"></i><b>8.3</b> Ignoring conditions</a></li>
<li class="chapter" data-level="8.4" data-path="conditions.html"><a href="conditions.html#handling-conditions"><i class="fa fa-check"></i><b>8.4</b> Handling conditions</a><ul>
<li class="chapter" data-level="8.4.1" data-path="conditions.html"><a href="conditions.html#condition-objects"><i class="fa fa-check"></i><b>8.4.1</b> Condition objects</a></li>
<li class="chapter" data-level="8.4.2" data-path="conditions.html"><a href="conditions.html#exiting-handlers"><i class="fa fa-check"></i><b>8.4.2</b> Exiting handlers</a></li>
<li class="chapter" data-level="8.4.3" data-path="conditions.html"><a href="conditions.html#calling-handlers"><i class="fa fa-check"></i><b>8.4.3</b> Calling handlers</a></li>
<li class="chapter" data-level="8.4.4" data-path="conditions.html"><a href="conditions.html#call-stacks"><i class="fa fa-check"></i><b>8.4.4</b> Call stacks</a></li>
<li class="chapter" data-level="8.4.5" data-path="conditions.html"><a href="conditions.html#exercises-24"><i class="fa fa-check"></i><b>8.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.5" data-path="conditions.html"><a href="conditions.html#custom-conditions"><i class="fa fa-check"></i><b>8.5</b> Custom conditions</a><ul>
<li class="chapter" data-level="8.5.1" data-path="conditions.html"><a href="conditions.html#motivation"><i class="fa fa-check"></i><b>8.5.1</b> Motivation</a></li>
<li class="chapter" data-level="8.5.2" data-path="conditions.html"><a href="conditions.html#signalling"><i class="fa fa-check"></i><b>8.5.2</b> Signalling</a></li>
<li class="chapter" data-level="8.5.3" data-path="conditions.html"><a href="conditions.html#handling"><i class="fa fa-check"></i><b>8.5.3</b> Handling</a></li>
<li class="chapter" data-level="8.5.4" data-path="conditions.html"><a href="conditions.html#exercises-25"><i class="fa fa-check"></i><b>8.5.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.6" data-path="conditions.html"><a href="conditions.html#condition-applications"><i class="fa fa-check"></i><b>8.6</b> Applications</a><ul>
<li class="chapter" data-level="8.6.1" data-path="conditions.html"><a href="conditions.html#failure-value"><i class="fa fa-check"></i><b>8.6.1</b> Failure value</a></li>
<li class="chapter" data-level="8.6.2" data-path="conditions.html"><a href="conditions.html#success-and-failure-values"><i class="fa fa-check"></i><b>8.6.2</b> Success and failure values</a></li>
<li class="chapter" data-level="8.6.3" data-path="conditions.html"><a href="conditions.html#resignal"><i class="fa fa-check"></i><b>8.6.3</b> Resignal</a></li>
<li class="chapter" data-level="8.6.4" data-path="conditions.html"><a href="conditions.html#record"><i class="fa fa-check"></i><b>8.6.4</b> Record</a></li>
<li class="chapter" data-level="8.6.5" data-path="conditions.html"><a href="conditions.html#no-default-behaviour"><i class="fa fa-check"></i><b>8.6.5</b> No default behaviour</a></li>
<li class="chapter" data-level="8.6.6" data-path="conditions.html"><a href="conditions.html#exercises-26"><i class="fa fa-check"></i><b>8.6.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="8.7" data-path="conditions.html"><a href="conditions.html#conditions-answers"><i class="fa fa-check"></i><b>8.7</b> Quiz answers</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="connections.html"><a href="connections.html"><i class="fa fa-check"></i><b>9</b> Connections</a><ul>
<li class="chapter" data-level="9.1" data-path="connections.html"><a href="connections.html#basics-1"><i class="fa fa-check"></i><b>9.1</b> Basics</a></li>
<li class="chapter" data-level="9.2" data-path="connections.html"><a href="connections.html#reading-and-writing-binary-data"><i class="fa fa-check"></i><b>9.2</b> Reading and writing binary data</a></li>
<li class="chapter" data-level="9.3" data-path="connections.html"><a href="connections.html#reading-and-writing-text-data"><i class="fa fa-check"></i><b>9.3</b> Reading and writing text data</a></li>
</ul></li>
<li class="part"><span><b>II Functional programming</b></span></li>
<li class="chapter" data-level="" data-path="fp.html"><a href="fp.html"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="10" data-path="functionals.html"><a href="functionals.html"><i class="fa fa-check"></i><b>10</b> Functionals</a><ul>
<li class="chapter" data-level="10.1" data-path="functionals.html"><a href="functionals.html#introduction-7"><i class="fa fa-check"></i><b>10.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="functionals.html"><a href="functionals.html#outline-5"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="functionals.html"><a href="functionals.html#prerequisites-3"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="functionals.html"><a href="functionals.html#map"><i class="fa fa-check"></i><b>10.2</b> My first functional: <code>map()</code></a><ul>
<li class="chapter" data-level="10.2.1" data-path="functionals.html"><a href="functionals.html#producing-atomic-vectors"><i class="fa fa-check"></i><b>10.2.1</b> Producing atomic vectors</a></li>
<li class="chapter" data-level="10.2.2" data-path="functionals.html"><a href="functionals.html#anonymous-functions-and-helpers"><i class="fa fa-check"></i><b>10.2.2</b> Anonymous functions and helpers</a></li>
<li class="chapter" data-level="10.2.3" data-path="functionals.html"><a href="functionals.html#passing-arguments"><i class="fa fa-check"></i><b>10.2.3</b> Passing arguments with <code>...</code></a></li>
<li class="chapter" data-level="10.2.4" data-path="functionals.html"><a href="functionals.html#argument-names"><i class="fa fa-check"></i><b>10.2.4</b> Argument names</a></li>
<li class="chapter" data-level="10.2.5" data-path="functionals.html"><a href="functionals.html#change-argument"><i class="fa fa-check"></i><b>10.2.5</b> Varying another argument</a></li>
<li class="chapter" data-level="10.2.6" data-path="functionals.html"><a href="functionals.html#exercises-27"><i class="fa fa-check"></i><b>10.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10.3" data-path="functionals.html"><a href="functionals.html#functionals-loop"><i class="fa fa-check"></i><b>10.3</b> Map variants</a><ul>
<li class="chapter" data-level="10.3.1" data-path="functionals.html"><a href="functionals.html#modify"><i class="fa fa-check"></i><b>10.3.1</b> Same type of output as input: <code>modify()</code></a></li>
<li class="chapter" data-level="10.3.2" data-path="functionals.html"><a href="functionals.html#map2"><i class="fa fa-check"></i><b>10.3.2</b> Two inputs: <code>map2()</code> and friends</a></li>
<li class="chapter" data-level="10.3.3" data-path="functionals.html"><a href="functionals.html#no-outputs-walk-and-friends"><i class="fa fa-check"></i><b>10.3.3</b> No outputs: <code>walk()</code> and friends</a></li>
<li class="chapter" data-level="10.3.4" data-path="functionals.html"><a href="functionals.html#iterating-over-values-and-indices"><i class="fa fa-check"></i><b>10.3.4</b> Iterating over values and indices</a></li>
<li class="chapter" data-level="10.3.5" data-path="functionals.html"><a href="functionals.html#pmap"><i class="fa fa-check"></i><b>10.3.5</b> Any number of inputs: <code>pmap()</code> and friends</a></li>
<li class="chapter" data-level="10.3.6" data-path="functionals.html"><a href="functionals.html#exercises-28"><i class="fa fa-check"></i><b>10.3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="functionals.html"><a href="functionals.html#reduce"><i class="fa fa-check"></i><b>10.4</b> Reduce</a><ul>
<li class="chapter" data-level="10.4.1" data-path="functionals.html"><a href="functionals.html#basics-2"><i class="fa fa-check"></i><b>10.4.1</b> Basics</a></li>
<li class="chapter" data-level="10.4.2" data-path="functionals.html"><a href="functionals.html#algebra"><i class="fa fa-check"></i><b>10.4.2</b> Algebra</a></li>
<li class="chapter" data-level="10.4.3" data-path="functionals.html"><a href="functionals.html#initialise"><i class="fa fa-check"></i><b>10.4.3</b> Initialise</a></li>
<li class="chapter" data-level="10.4.4" data-path="functionals.html"><a href="functionals.html#reduce2"><i class="fa fa-check"></i><b>10.4.4</b> reduce2</a></li>
<li class="chapter" data-level="10.4.5" data-path="functionals.html"><a href="functionals.html#accumulate"><i class="fa fa-check"></i><b>10.4.5</b> Accumulate</a></li>
<li class="chapter" data-level="10.4.6" data-path="functionals.html"><a href="functionals.html#map-reduce"><i class="fa fa-check"></i><b>10.4.6</b> Map-reduce</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="functionals.html"><a href="functionals.html#predicate-functionals"><i class="fa fa-check"></i><b>10.5</b> Predicate functionals</a><ul>
<li class="chapter" data-level="10.5.1" data-path="functionals.html"><a href="functionals.html#basics-3"><i class="fa fa-check"></i><b>10.5.1</b> Basics</a></li>
<li class="chapter" data-level="10.5.2" data-path="functionals.html"><a href="functionals.html#predicate-map"><i class="fa fa-check"></i><b>10.5.2</b> Map variants</a></li>
<li class="chapter" data-level="10.5.3" data-path="functionals.html"><a href="functionals.html#exercises-29"><i class="fa fa-check"></i><b>10.5.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="functionals.html"><a href="functionals.html#functionals-math"><i class="fa fa-check"></i><b>10.6</b> Base functionals</a><ul>
<li class="chapter" data-level="10.6.1" data-path="functionals.html"><a href="functionals.html#matrices-and-array-operations"><i class="fa fa-check"></i><b>10.6.1</b> Matrices and array operations</a></li>
<li class="chapter" data-level="10.6.2" data-path="functionals.html"><a href="functionals.html#tapply"><i class="fa fa-check"></i><b>10.6.2</b> <code>tapply()</code></a></li>
<li class="chapter" data-level="10.6.3" data-path="functionals.html"><a href="functionals.html#mathmatical"><i class="fa fa-check"></i><b>10.6.3</b> Mathmatical</a></li>
<li class="chapter" data-level="10.6.4" data-path="functionals.html"><a href="functionals.html#exercises-30"><i class="fa fa-check"></i><b>10.6.4</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="function-factories.html"><a href="function-factories.html"><i class="fa fa-check"></i><b>11</b> Function factories</a><ul>
<li class="chapter" data-level="11.1" data-path="function-factories.html"><a href="function-factories.html#introduction-8"><i class="fa fa-check"></i><b>11.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="function-factories.html"><a href="function-factories.html#outline-6"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="function-factories.html"><a href="function-factories.html#prerequisites-4"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="11.2" data-path="function-factories.html"><a href="function-factories.html#factory-fundamentals"><i class="fa fa-check"></i><b>11.2</b> Factory fundamentals</a><ul>
<li class="chapter" data-level="11.2.1" data-path="function-factories.html"><a href="function-factories.html#environments-1"><i class="fa fa-check"></i><b>11.2.1</b> Environments</a></li>
<li class="chapter" data-level="11.2.2" data-path="function-factories.html"><a href="function-factories.html#diagram-conventions"><i class="fa fa-check"></i><b>11.2.2</b> Diagram conventions</a></li>
<li class="chapter" data-level="11.2.3" data-path="function-factories.html"><a href="function-factories.html#stateful-funs"><i class="fa fa-check"></i><b>11.2.3</b> Stateful functions</a></li>
<li class="chapter" data-level="11.2.4" data-path="function-factories.html"><a href="function-factories.html#potential-pitfalls"><i class="fa fa-check"></i><b>11.2.4</b> Potential pitfalls</a></li>
<li class="chapter" data-level="11.2.5" data-path="function-factories.html"><a href="function-factories.html#exercises-31"><i class="fa fa-check"></i><b>11.2.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="function-factories.html"><a href="function-factories.html#graph-fact"><i class="fa fa-check"></i><b>11.3</b> Graphical factories</a><ul>
<li class="chapter" data-level="11.3.1" data-path="function-factories.html"><a href="function-factories.html#labelling"><i class="fa fa-check"></i><b>11.3.1</b> Labelling</a></li>
<li class="chapter" data-level="11.3.2" data-path="function-factories.html"><a href="function-factories.html#histogram-bins"><i class="fa fa-check"></i><b>11.3.2</b> Histogram bins</a></li>
<li class="chapter" data-level="11.3.3" data-path="function-factories.html"><a href="function-factories.html#ggsave"><i class="fa fa-check"></i><b>11.3.3</b> ggsave</a></li>
<li class="chapter" data-level="11.3.4" data-path="function-factories.html"><a href="function-factories.html#exercises-32"><i class="fa fa-check"></i><b>11.3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="function-factories.html"><a href="function-factories.html#stat-fact"><i class="fa fa-check"></i><b>11.4</b> Statistical factories</a><ul>
<li class="chapter" data-level="11.4.1" data-path="function-factories.html"><a href="function-factories.html#box-cox-transformation"><i class="fa fa-check"></i><b>11.4.1</b> Box-Cox transformation</a></li>
<li class="chapter" data-level="11.4.2" data-path="function-factories.html"><a href="function-factories.html#bootstrap-generators"><i class="fa fa-check"></i><b>11.4.2</b> Bootstrap generators</a></li>
<li class="chapter" data-level="11.4.3" data-path="function-factories.html"><a href="function-factories.html#MLE"><i class="fa fa-check"></i><b>11.4.3</b> Maximum likelihood estimation</a></li>
<li class="chapter" data-level="11.4.4" data-path="function-factories.html"><a href="function-factories.html#exercises-33"><i class="fa fa-check"></i><b>11.4.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="11.5" data-path="function-factories.html"><a href="function-factories.html#functional-factories"><i class="fa fa-check"></i><b>11.5</b> Function factories + functionals</a><ul>
<li class="chapter" data-level="11.5.1" data-path="function-factories.html"><a href="function-factories.html#moving-a-lists-to-the-global-environment"><i class="fa fa-check"></i><b>11.5.1</b> Moving a lists to the global environment</a></li>
<li class="chapter" data-level="11.5.2" data-path="function-factories.html"><a href="function-factories.html#another-approach"><i class="fa fa-check"></i><b>11.5.2</b> Another approach</a></li>
<li class="chapter" data-level="11.5.3" data-path="function-factories.html"><a href="function-factories.html#exercises-34"><i class="fa fa-check"></i><b>11.5.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="12" data-path="function-operators.html"><a href="function-operators.html"><i class="fa fa-check"></i><b>12</b> Function operators</a><ul>
<li class="chapter" data-level="12.1" data-path="function-operators.html"><a href="function-operators.html#introduction-9"><i class="fa fa-check"></i><b>12.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="function-operators.html"><a href="function-operators.html#outline-7"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="function-operators.html"><a href="function-operators.html#prerequisites-5"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="function-operators.html"><a href="function-operators.html#behavioural-fos"><i class="fa fa-check"></i><b>12.2</b> Behavioural FOs</a><ul>
<li class="chapter" data-level="12.2.1" data-path="function-operators.html"><a href="function-operators.html#memoisation"><i class="fa fa-check"></i><b>12.2.1</b> Memoisation</a></li>
<li class="chapter" data-level="12.2.2" data-path="function-operators.html"><a href="function-operators.html#tee"><i class="fa fa-check"></i><b>12.2.2</b> Capturing function invocations</a></li>
<li class="chapter" data-level="12.2.3" data-path="function-operators.html"><a href="function-operators.html#laziness"><i class="fa fa-check"></i><b>12.2.3</b> Laziness</a></li>
<li class="chapter" data-level="12.2.4" data-path="function-operators.html"><a href="function-operators.html#exercises-35"><i class="fa fa-check"></i><b>12.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="function-operators.html"><a href="function-operators.html#output-fos"><i class="fa fa-check"></i><b>12.3</b> Output FOs</a><ul>
<li class="chapter" data-level="12.3.1" data-path="function-operators.html"><a href="function-operators.html#minor-modifications"><i class="fa fa-check"></i><b>12.3.1</b> Minor modifications</a></li>
<li class="chapter" data-level="12.3.2" data-path="function-operators.html"><a href="function-operators.html#changing-what-a-function-does"><i class="fa fa-check"></i><b>12.3.2</b> Changing what a function does</a></li>
<li class="chapter" data-level="12.3.3" data-path="function-operators.html"><a href="function-operators.html#exercises-36"><i class="fa fa-check"></i><b>12.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="function-operators.html"><a href="function-operators.html#input-fos"><i class="fa fa-check"></i><b>12.4</b> Input FOs</a><ul>
<li class="chapter" data-level="12.4.1" data-path="function-operators.html"><a href="function-operators.html#prefilling-function-arguments-partial-function-application"><i class="fa fa-check"></i><b>12.4.1</b> Prefilling function arguments: partial function application</a></li>
<li class="chapter" data-level="12.4.2" data-path="function-operators.html"><a href="function-operators.html#changing-input-types"><i class="fa fa-check"></i><b>12.4.2</b> Changing input types</a></li>
<li class="chapter" data-level="12.4.3" data-path="function-operators.html"><a href="function-operators.html#exercises-37"><i class="fa fa-check"></i><b>12.4.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12.5" data-path="function-operators.html"><a href="function-operators.html#combining-fos"><i class="fa fa-check"></i><b>12.5</b> Combining FOs</a><ul>
<li class="chapter" data-level="12.5.1" data-path="function-operators.html"><a href="function-operators.html#function-composition"><i class="fa fa-check"></i><b>12.5.1</b> Function composition</a></li>
<li class="chapter" data-level="12.5.2" data-path="function-operators.html"><a href="function-operators.html#logical-predicates-and-boolean-algebra"><i class="fa fa-check"></i><b>12.5.2</b> Logical predicates and boolean algebra</a></li>
<li class="chapter" data-level="12.5.3" data-path="function-operators.html"><a href="function-operators.html#exercises-38"><i class="fa fa-check"></i><b>12.5.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>III Object oriented programming</b></span></li>
<li class="chapter" data-level="" data-path="oo.html"><a href="oo.html"><i class="fa fa-check"></i>Introduction</a><ul>
<li class="chapter" data-level="12.6" data-path="oo.html"><a href="oo.html#oop-systems"><i class="fa fa-check"></i><b>12.6</b> OOP Systems</a></li>
<li class="chapter" data-level="12.7" data-path="oo.html"><a href="oo.html#oop-in-r"><i class="fa fa-check"></i><b>12.7</b> OOP in R</a></li>
<li class="chapter" data-level="12.8" data-path="oo.html"><a href="oo.html#field-guide"><i class="fa fa-check"></i><b>12.8</b> Field guide</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="base-types.html"><a href="base-types.html"><i class="fa fa-check"></i><b>13</b> Base types</a><ul>
<li class="chapter" data-level="13.1" data-path="base-types.html"><a href="base-types.html#introduction-10"><i class="fa fa-check"></i><b>13.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="base-types.html"><a href="base-types.html#outline-8"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="base-types.html"><a href="base-types.html#base-objects-vs-oo-objects"><i class="fa fa-check"></i><b>13.2</b> Base objects vs OO objects</a></li>
<li class="chapter" data-level="13.3" data-path="base-types.html"><a href="base-types.html#base-types-2"><i class="fa fa-check"></i><b>13.3</b> Base types</a></li>
<li class="chapter" data-level="13.4" data-path="base-types.html"><a href="base-types.html#is-functions"><i class="fa fa-check"></i><b>13.4</b> The is functions</a><ul>
<li class="chapter" data-level="13.4.1" data-path="base-types.html"><a href="base-types.html#numeric-type"><i class="fa fa-check"></i><b>13.4.1</b> Numeric type</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="s3.html"><a href="s3.html"><i class="fa fa-check"></i><b>14</b> S3</a><ul>
<li class="chapter" data-level="14.1" data-path="s3.html"><a href="s3.html#introduction-11"><i class="fa fa-check"></i><b>14.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#outline-9"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#prerequisites-6"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="14.2" data-path="s3.html"><a href="s3.html#s3-basics"><i class="fa fa-check"></i><b>14.2</b> Basics</a><ul>
<li class="chapter" data-level="14.2.1" data-path="s3.html"><a href="s3.html#exercises-39"><i class="fa fa-check"></i><b>14.2.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14.3" data-path="s3.html"><a href="s3.html#classes"><i class="fa fa-check"></i><b>14.3</b> Classes</a><ul>
<li class="chapter" data-level="14.3.1" data-path="s3.html"><a href="s3.html#constructors"><i class="fa fa-check"></i><b>14.3.1</b> Constructors</a></li>
<li class="chapter" data-level="14.3.2" data-path="s3.html"><a href="s3.html#validators"><i class="fa fa-check"></i><b>14.3.2</b> Validators</a></li>
<li class="chapter" data-level="14.3.3" data-path="s3.html"><a href="s3.html#helpers"><i class="fa fa-check"></i><b>14.3.3</b> Helpers</a></li>
<li class="chapter" data-level="14.3.4" data-path="s3.html"><a href="s3.html#object-styles"><i class="fa fa-check"></i><b>14.3.4</b> Object styles</a></li>
<li class="chapter" data-level="14.3.5" data-path="s3.html"><a href="s3.html#exercises-40"><i class="fa fa-check"></i><b>14.3.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="s3.html"><a href="s3.html#generics-and-methods"><i class="fa fa-check"></i><b>14.4</b> Generics and methods</a><ul>
<li class="chapter" data-level="14.4.1" data-path="s3.html"><a href="s3.html#coercion"><i class="fa fa-check"></i><b>14.4.1</b> Coercion</a></li>
<li class="chapter" data-level="14.4.2" data-path="s3.html"><a href="s3.html#s3-arguments"><i class="fa fa-check"></i><b>14.4.2</b> Arguments</a></li>
<li class="chapter" data-level="14.4.3" data-path="s3.html"><a href="s3.html#exercises-41"><i class="fa fa-check"></i><b>14.4.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14.5" data-path="s3.html"><a href="s3.html#method-dispatch"><i class="fa fa-check"></i><b>14.5</b> Method dispatch</a><ul>
<li class="chapter" data-level="14.5.1" data-path="s3.html"><a href="s3.html#usemethod"><i class="fa fa-check"></i><b>14.5.1</b> <code>UseMethod()</code></a></li>
<li class="chapter" data-level="14.5.2" data-path="s3.html"><a href="s3.html#nextmethod"><i class="fa fa-check"></i><b>14.5.2</b> <code>NextMethod()</code></a></li>
<li class="chapter" data-level="14.5.3" data-path="s3.html"><a href="s3.html#exercises-42"><i class="fa fa-check"></i><b>14.5.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14.6" data-path="s3.html"><a href="s3.html#inheritance"><i class="fa fa-check"></i><b>14.6</b> Inheritance</a><ul>
<li class="chapter" data-level="14.6.1" data-path="s3.html"><a href="s3.html#constructors-1"><i class="fa fa-check"></i><b>14.6.1</b> Constructors</a></li>
<li class="chapter" data-level="14.6.2" data-path="s3.html"><a href="s3.html#coercion-1"><i class="fa fa-check"></i><b>14.6.2</b> Coercion</a></li>
<li class="chapter" data-level="14.6.3" data-path="s3.html"><a href="s3.html#methods"><i class="fa fa-check"></i><b>14.6.3</b> Methods</a></li>
<li class="chapter" data-level="14.6.4" data-path="s3.html"><a href="s3.html#exercises-43"><i class="fa fa-check"></i><b>14.6.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="14.7" data-path="s3.html"><a href="s3.html#dispatch-details"><i class="fa fa-check"></i><b>14.7</b> Dispatch details</a><ul>
<li class="chapter" data-level="14.7.1" data-path="s3.html"><a href="s3.html#environments-and-namespaces"><i class="fa fa-check"></i><b>14.7.1</b> Environments and namespaces</a></li>
<li class="chapter" data-level="14.7.2" data-path="s3.html"><a href="s3.html#s3-and-base-types"><i class="fa fa-check"></i><b>14.7.2</b> S3 and base types</a></li>
<li class="chapter" data-level="14.7.3" data-path="s3.html"><a href="s3.html#internal-generics"><i class="fa fa-check"></i><b>14.7.3</b> Internal generics</a></li>
<li class="chapter" data-level="14.7.4" data-path="s3.html"><a href="s3.html#group-generics"><i class="fa fa-check"></i><b>14.7.4</b> Group generics</a></li>
<li class="chapter" data-level="14.7.5" data-path="s3.html"><a href="s3.html#double-dispatch"><i class="fa fa-check"></i><b>14.7.5</b> Double dispatch</a></li>
<li class="chapter" data-level="14.7.6" data-path="s3.html"><a href="s3.html#exercises-44"><i class="fa fa-check"></i><b>14.7.6</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="15" data-path="s4.html"><a href="s4.html"><i class="fa fa-check"></i><b>15</b> S4</a><ul>
<li class="chapter" data-level="15.1" data-path="s4.html"><a href="s4.html#introduction-12"><i class="fa fa-check"></i><b>15.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="s4.html"><a href="s4.html#outline-10"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="s4.html"><a href="s4.html#prerequisites-7"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="15.2" data-path="s4.html"><a href="s4.html#classes-1"><i class="fa fa-check"></i><b>15.2</b> Classes</a><ul>
<li class="chapter" data-level="15.2.1" data-path="s4.html"><a href="s4.html#slots"><i class="fa fa-check"></i><b>15.2.1</b> Slots</a></li>
<li class="chapter" data-level="15.2.2" data-path="s4.html"><a href="s4.html#helper"><i class="fa fa-check"></i><b>15.2.2</b> Helper</a></li>
<li class="chapter" data-level="15.2.3" data-path="s4.html"><a href="s4.html#introspection"><i class="fa fa-check"></i><b>15.2.3</b> Introspection</a></li>
<li class="chapter" data-level="15.2.4" data-path="s4.html"><a href="s4.html#exercises-45"><i class="fa fa-check"></i><b>15.2.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15.3" data-path="s4.html"><a href="s4.html#generics-and-methods-1"><i class="fa fa-check"></i><b>15.3</b> Generics and methods</a><ul>
<li class="chapter" data-level="15.3.1" data-path="s4.html"><a href="s4.html#show-method"><i class="fa fa-check"></i><b>15.3.1</b> Show method</a></li>
<li class="chapter" data-level="15.3.2" data-path="s4.html"><a href="s4.html#accessor-methods"><i class="fa fa-check"></i><b>15.3.2</b> Accessor methods</a></li>
<li class="chapter" data-level="15.3.3" data-path="s4.html"><a href="s4.html#coercion-methods"><i class="fa fa-check"></i><b>15.3.3</b> Coercion methods</a></li>
<li class="chapter" data-level="15.3.4" data-path="s4.html"><a href="s4.html#introspection-1"><i class="fa fa-check"></i><b>15.3.4</b> Introspection</a></li>
<li class="chapter" data-level="15.3.5" data-path="s4.html"><a href="s4.html#exercises-46"><i class="fa fa-check"></i><b>15.3.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15.4" data-path="s4.html"><a href="s4.html#method-dispatch-1"><i class="fa fa-check"></i><b>15.4</b> Method dispatch</a><ul>
<li class="chapter" data-level="15.4.1" data-path="s4.html"><a href="s4.html#single-dispatch"><i class="fa fa-check"></i><b>15.4.1</b> Single dispatch</a></li>
<li class="chapter" data-level="15.4.2" data-path="s4.html"><a href="s4.html#multiple-inheritance"><i class="fa fa-check"></i><b>15.4.2</b> Multiple inheritance</a></li>
<li class="chapter" data-level="15.4.3" data-path="s4.html"><a href="s4.html#multiple-dispatch"><i class="fa fa-check"></i><b>15.4.3</b> Multiple dispatch</a></li>
<li class="chapter" data-level="15.4.4" data-path="s4.html"><a href="s4.html#multiple-dispatch-and-multiple-inheritance"><i class="fa fa-check"></i><b>15.4.4</b> Multiple dispatch and multiple inheritance</a></li>
<li class="chapter" data-level="15.4.5" data-path="s4.html"><a href="s4.html#exercises-47"><i class="fa fa-check"></i><b>15.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="15.5" data-path="s4.html"><a href="s4.html#s4-and-existing-code"><i class="fa fa-check"></i><b>15.5</b> S4 and existing code</a><ul>
<li class="chapter" data-level="15.5.1" data-path="s4.html"><a href="s4.html#classes-2"><i class="fa fa-check"></i><b>15.5.1</b> Classes</a></li>
<li class="chapter" data-level="15.5.2" data-path="s4.html"><a href="s4.html#generics"><i class="fa fa-check"></i><b>15.5.2</b> Generics</a></li>
<li class="chapter" data-level="15.5.3" data-path="s4.html"><a href="s4.html#exercises-48"><i class="fa fa-check"></i><b>15.5.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="16" data-path="R6.html"><a href="R6.html"><i class="fa fa-check"></i><b>16</b> R6</a><ul>
<li class="chapter" data-level="16.1" data-path="R6.html"><a href="R6.html#introduction-13"><i class="fa fa-check"></i><b>16.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="R6.html"><a href="R6.html#outline-11"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="R6.html"><a href="R6.html#prequisites"><i class="fa fa-check"></i>Prequisites</a></li>
</ul></li>
<li class="chapter" data-level="16.2" data-path="R6.html"><a href="R6.html#classes-and-methods"><i class="fa fa-check"></i><b>16.2</b> Classes and methods</a><ul>
<li class="chapter" data-level="16.2.1" data-path="R6.html"><a href="R6.html#method-chaining"><i class="fa fa-check"></i><b>16.2.1</b> Method chaining</a></li>
<li class="chapter" data-level="16.2.2" data-path="R6.html"><a href="R6.html#important-methods"><i class="fa fa-check"></i><b>16.2.2</b> Important methods</a></li>
<li class="chapter" data-level="16.2.3" data-path="R6.html"><a href="R6.html#adding-methods-after-creation"><i class="fa fa-check"></i><b>16.2.3</b> Adding methods after creation</a></li>
<li class="chapter" data-level="16.2.4" data-path="R6.html"><a href="R6.html#inheritance-1"><i class="fa fa-check"></i><b>16.2.4</b> Inheritance</a></li>
<li class="chapter" data-level="16.2.5" data-path="R6.html"><a href="R6.html#introspection-2"><i class="fa fa-check"></i><b>16.2.5</b> Introspection</a></li>
<li class="chapter" data-level="16.2.6" data-path="R6.html"><a href="R6.html#exercises-49"><i class="fa fa-check"></i><b>16.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="16.3" data-path="R6.html"><a href="R6.html#controlling-access"><i class="fa fa-check"></i><b>16.3</b> Controlling access</a><ul>
<li class="chapter" data-level="16.3.1" data-path="R6.html"><a href="R6.html#privacy"><i class="fa fa-check"></i><b>16.3.1</b> Privacy</a></li>
<li class="chapter" data-level="16.3.2" data-path="R6.html"><a href="R6.html#active-fields"><i class="fa fa-check"></i><b>16.3.2</b> Active fields</a></li>
<li class="chapter" data-level="16.3.3" data-path="R6.html"><a href="R6.html#exercises-50"><i class="fa fa-check"></i><b>16.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="16.4" data-path="R6.html"><a href="R6.html#reference-semantics"><i class="fa fa-check"></i><b>16.4</b> Reference semantics</a><ul>
<li class="chapter" data-level="16.4.1" data-path="R6.html"><a href="R6.html#reasoning"><i class="fa fa-check"></i><b>16.4.1</b> Reasoning</a></li>
<li class="chapter" data-level="16.4.2" data-path="R6.html"><a href="R6.html#finalizer"><i class="fa fa-check"></i><b>16.4.2</b> Finalizer</a></li>
<li class="chapter" data-level="16.4.3" data-path="R6.html"><a href="R6.html#r6-fields"><i class="fa fa-check"></i><b>16.4.3</b> R6 fields</a></li>
<li class="chapter" data-level="16.4.4" data-path="R6.html"><a href="R6.html#exercises-51"><i class="fa fa-check"></i><b>16.4.4</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="17" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html"><i class="fa fa-check"></i><b>17</b> Trade-offs</a><ul>
<li class="chapter" data-level="17.1" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#introduction-14"><i class="fa fa-check"></i><b>17.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#outline-12"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="17.2" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#s3-s4"><i class="fa fa-check"></i><b>17.2</b> S4 vs S3</a></li>
<li class="chapter" data-level="17.3" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#s3-r6"><i class="fa fa-check"></i><b>17.3</b> R6 vs S3</a><ul>
<li class="chapter" data-level="17.3.1" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#namespacing"><i class="fa fa-check"></i><b>17.3.1</b> Namespacing</a></li>
<li class="chapter" data-level="17.3.2" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#threading-state"><i class="fa fa-check"></i><b>17.3.2</b> Threading state</a></li>
<li class="chapter" data-level="17.3.3" data-path="oo-tradeoffs.html"><a href="oo-tradeoffs.html#tradeoffs-pipe"><i class="fa fa-check"></i><b>17.3.3</b> Method chaining</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>IV Metaprogramming</b></span></li>
<li class="chapter" data-level="" data-path="meta.html"><a href="meta.html"><i class="fa fa-check"></i>Introduction</a><ul>
<li class="chapter" data-level="17.3.4" data-path="meta.html"><a href="meta.html#trading-precision-for-concision"><i class="fa fa-check"></i><b>17.3.4</b> Trading precision for concision</a></li>
<li class="chapter" data-level="17.4" data-path="meta.html"><a href="meta.html#domain-specific-languages"><i class="fa fa-check"></i><b>17.4</b> Domain specific languages</a></li>
<li class="chapter" data-level="17.5" data-path="meta.html"><a href="meta.html#overview-1"><i class="fa fa-check"></i><b>17.5</b> Overview</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="expressions.html"><a href="expressions.html"><i class="fa fa-check"></i><b>18</b> Expressions</a><ul>
<li class="chapter" data-level="18.1" data-path="expressions.html"><a href="expressions.html#introduction-15"><i class="fa fa-check"></i><b>18.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="expressions.html"><a href="expressions.html#outline-13"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="expressions.html"><a href="expressions.html#prerequisites-8"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="18.2" data-path="expressions.html"><a href="expressions.html#abstract-syntax-trees"><i class="fa fa-check"></i><b>18.2</b> Abstract syntax trees</a><ul>
<li class="chapter" data-level="18.2.1" data-path="expressions.html"><a href="expressions.html#infix-vs.prefix-calls"><i class="fa fa-check"></i><b>18.2.1</b> Infix vs. prefix calls</a></li>
<li class="chapter" data-level="18.2.2" data-path="expressions.html"><a href="expressions.html#special-forms-1"><i class="fa fa-check"></i><b>18.2.2</b> Special forms</a></li>
<li class="chapter" data-level="18.2.3" data-path="expressions.html"><a href="expressions.html#function-factories-1"><i class="fa fa-check"></i><b>18.2.3</b> Function factories</a></li>
<li class="chapter" data-level="18.2.4" data-path="expressions.html"><a href="expressions.html#argument-names-1"><i class="fa fa-check"></i><b>18.2.4</b> Argument names</a></li>
<li class="chapter" data-level="18.2.5" data-path="expressions.html"><a href="expressions.html#exercises-52"><i class="fa fa-check"></i><b>18.2.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18.3" data-path="expressions.html"><a href="expressions.html#rs-grammar"><i class="fa fa-check"></i><b>18.3</b> R’s grammar</a><ul>
<li class="chapter" data-level="18.3.1" data-path="expressions.html"><a href="expressions.html#operator-precedence"><i class="fa fa-check"></i><b>18.3.1</b> Operator precedence</a></li>
<li class="chapter" data-level="18.3.2" data-path="expressions.html"><a href="expressions.html#associativity"><i class="fa fa-check"></i><b>18.3.2</b> Associativity</a></li>
<li class="chapter" data-level="18.3.3" data-path="expressions.html"><a href="expressions.html#whitespace"><i class="fa fa-check"></i><b>18.3.3</b> Whitespace</a></li>
<li class="chapter" data-level="18.3.4" data-path="expressions.html"><a href="expressions.html#exercises-53"><i class="fa fa-check"></i><b>18.3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18.4" data-path="expressions.html"><a href="expressions.html#data-structures"><i class="fa fa-check"></i><b>18.4</b> Data structures</a><ul>
<li class="chapter" data-level="18.4.1" data-path="expressions.html"><a href="expressions.html#naming-conventions"><i class="fa fa-check"></i><b>18.4.1</b> Naming conventions</a></li>
<li class="chapter" data-level="18.4.2" data-path="expressions.html"><a href="expressions.html#constants"><i class="fa fa-check"></i><b>18.4.2</b> Constants</a></li>
<li class="chapter" data-level="18.4.3" data-path="expressions.html"><a href="expressions.html#symbols"><i class="fa fa-check"></i><b>18.4.3</b> Symbols</a></li>
<li class="chapter" data-level="18.4.4" data-path="expressions.html"><a href="expressions.html#calls"><i class="fa fa-check"></i><b>18.4.4</b> Calls</a></li>
<li class="chapter" data-level="18.4.5" data-path="expressions.html"><a href="expressions.html#pairlists"><i class="fa fa-check"></i><b>18.4.5</b> Pairlists</a></li>
<li class="chapter" data-level="18.4.6" data-path="expressions.html"><a href="expressions.html#expression-objects"><i class="fa fa-check"></i><b>18.4.6</b> Expression objects</a></li>
<li class="chapter" data-level="18.4.7" data-path="expressions.html"><a href="expressions.html#exercises-54"><i class="fa fa-check"></i><b>18.4.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18.5" data-path="expressions.html"><a href="expressions.html#parsing-and-deparsing"><i class="fa fa-check"></i><b>18.5</b> Parsing and deparsing</a><ul>
<li class="chapter" data-level="18.5.1" data-path="expressions.html"><a href="expressions.html#exercises-55"><i class="fa fa-check"></i><b>18.5.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="18.6" data-path="expressions.html"><a href="expressions.html#ast-funs"><i class="fa fa-check"></i><b>18.6</b> Case study: Walking the AST with recursive functions</a><ul>
<li class="chapter" data-level="18.6.1" data-path="expressions.html"><a href="expressions.html#finding-f-and-t"><i class="fa fa-check"></i><b>18.6.1</b> Finding F and T</a></li>
<li class="chapter" data-level="18.6.2" data-path="expressions.html"><a href="expressions.html#finding-all-variables-created-by-assignment"><i class="fa fa-check"></i><b>18.6.2</b> Finding all variables created by assignment</a></li>
<li class="chapter" data-level="18.6.3" data-path="expressions.html"><a href="expressions.html#exercises-56"><i class="fa fa-check"></i><b>18.6.3</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="19" data-path="quasiquotation.html"><a href="quasiquotation.html"><i class="fa fa-check"></i><b>19</b> Quasiquotation</a><ul>
<li class="chapter" data-level="19.1" data-path="quasiquotation.html"><a href="quasiquotation.html#introduction-16"><i class="fa fa-check"></i><b>19.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#outline-14"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#prerequisites-9"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="19.2" data-path="quasiquotation.html"><a href="quasiquotation.html#motivation-1"><i class="fa fa-check"></i><b>19.2</b> Motivation</a><ul>
<li class="chapter" data-level="19.2.1" data-path="quasiquotation.html"><a href="quasiquotation.html#vocabulary"><i class="fa fa-check"></i><b>19.2.1</b> Vocabulary</a></li>
<li class="chapter" data-level="19.2.2" data-path="quasiquotation.html"><a href="quasiquotation.html#theory"><i class="fa fa-check"></i><b>19.2.2</b> Theory</a></li>
<li class="chapter" data-level="19.2.3" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-57"><i class="fa fa-check"></i><b>19.2.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19.3" data-path="quasiquotation.html"><a href="quasiquotation.html#quotation"><i class="fa fa-check"></i><b>19.3</b> Quotation</a><ul>
<li class="chapter" data-level="19.3.1" data-path="quasiquotation.html"><a href="quasiquotation.html#with-rlang"><i class="fa fa-check"></i><b>19.3.1</b> With rlang</a></li>
<li class="chapter" data-level="19.3.2" data-path="quasiquotation.html"><a href="quasiquotation.html#with-base-r"><i class="fa fa-check"></i><b>19.3.2</b> With base R</a></li>
<li class="chapter" data-level="19.3.3" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-58"><i class="fa fa-check"></i><b>19.3.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19.4" data-path="quasiquotation.html"><a href="quasiquotation.html#eval-basics"><i class="fa fa-check"></i><b>19.4</b> Evaluation</a></li>
<li class="chapter" data-level="19.5" data-path="quasiquotation.html"><a href="quasiquotation.html#unquotation"><i class="fa fa-check"></i><b>19.5</b> Unquotation</a><ul>
<li class="chapter" data-level="19.5.1" data-path="quasiquotation.html"><a href="quasiquotation.html#with-rlang-1"><i class="fa fa-check"></i><b>19.5.1</b> With rlang</a></li>
<li class="chapter" data-level="19.5.2" data-path="quasiquotation.html"><a href="quasiquotation.html#the-polite-fiction-of"><i class="fa fa-check"></i><b>19.5.2</b> The polite fiction of <code>!!</code></a></li>
<li class="chapter" data-level="19.5.3" data-path="quasiquotation.html"><a href="quasiquotation.html#unquote-base"><i class="fa fa-check"></i><b>19.5.3</b> With base R</a></li>
<li class="chapter" data-level="19.5.4" data-path="quasiquotation.html"><a href="quasiquotation.html#non-standard-asts"><i class="fa fa-check"></i><b>19.5.4</b> Non-standard ASTs</a></li>
<li class="chapter" data-level="19.5.5" data-path="quasiquotation.html"><a href="quasiquotation.html#missing-arguments-1"><i class="fa fa-check"></i><b>19.5.5</b> Missing arguments</a></li>
<li class="chapter" data-level="19.5.6" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-59"><i class="fa fa-check"></i><b>19.5.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19.6" data-path="quasiquotation.html"><a href="quasiquotation.html#quasi-case-studies"><i class="fa fa-check"></i><b>19.6</b> Case studies</a><ul>
<li class="chapter" data-level="19.6.1" data-path="quasiquotation.html"><a href="quasiquotation.html#map-reduce-to-generate-code"><i class="fa fa-check"></i><b>19.6.1</b> Map-reduce to generate code</a></li>
<li class="chapter" data-level="19.6.2" data-path="quasiquotation.html"><a href="quasiquotation.html#partition"><i class="fa fa-check"></i><b>19.6.2</b> Partition</a></li>
<li class="chapter" data-level="19.6.3" data-path="quasiquotation.html"><a href="quasiquotation.html#slicing-an-array"><i class="fa fa-check"></i><b>19.6.3</b> Slicing an array</a></li>
<li class="chapter" data-level="19.6.4" data-path="quasiquotation.html"><a href="quasiquotation.html#quasi-function"><i class="fa fa-check"></i><b>19.6.4</b> Creating functions</a></li>
<li class="chapter" data-level="19.6.5" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-60"><i class="fa fa-check"></i><b>19.6.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="19.7" data-path="quasiquotation.html"><a href="quasiquotation.html#dot-dot-dot-..."><i class="fa fa-check"></i><b>19.7</b> Dot-dot-dot (<code>...</code>)</a><ul>
<li class="chapter" data-level="19.7.1" data-path="quasiquotation.html"><a href="quasiquotation.html#do.call"><i class="fa fa-check"></i><b>19.7.1</b> <code>do.call()</code></a></li>
<li class="chapter" data-level="19.7.2" data-path="quasiquotation.html"><a href="quasiquotation.html#the-tidyverse-approach"><i class="fa fa-check"></i><b>19.7.2</b> The tidyverse approach</a></li>
<li class="chapter" data-level="19.7.3" data-path="quasiquotation.html"><a href="quasiquotation.html#list2"><i class="fa fa-check"></i><b>19.7.3</b> <code>list2()</code></a></li>
<li class="chapter" data-level="19.7.4" data-path="quasiquotation.html"><a href="quasiquotation.html#application-invoke-and-lang"><i class="fa fa-check"></i><b>19.7.4</b> Application: <code>invoke()</code> and <code>lang()</code></a></li>
<li class="chapter" data-level="19.7.5" data-path="quasiquotation.html"><a href="quasiquotation.html#other-approaches"><i class="fa fa-check"></i><b>19.7.5</b> Other approaches</a></li>
<li class="chapter" data-level="19.7.6" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-61"><i class="fa fa-check"></i><b>19.7.6</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="20" data-path="evaluation.html"><a href="evaluation.html"><i class="fa fa-check"></i><b>20</b> Evaluation</a><ul>
<li class="chapter" data-level="20.1" data-path="evaluation.html"><a href="evaluation.html#introduction-17"><i class="fa fa-check"></i><b>20.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="evaluation.html"><a href="evaluation.html#outline-15"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="evaluation.html"><a href="evaluation.html#prerequisites-10"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="20.2" data-path="evaluation.html"><a href="evaluation.html#evaluation-basics"><i class="fa fa-check"></i><b>20.2</b> Evaluation basics</a><ul>
<li class="chapter" data-level="20.2.1" data-path="evaluation.html"><a href="evaluation.html#application-local"><i class="fa fa-check"></i><b>20.2.1</b> Application: <code>local()</code></a></li>
<li class="chapter" data-level="20.2.2" data-path="evaluation.html"><a href="evaluation.html#application-source"><i class="fa fa-check"></i><b>20.2.2</b> Application: <code>source()</code></a></li>
<li class="chapter" data-level="20.2.3" data-path="evaluation.html"><a href="evaluation.html#gotcha-function"><i class="fa fa-check"></i><b>20.2.3</b> Gotcha: <code>function()</code></a></li>
<li class="chapter" data-level="20.2.4" data-path="evaluation.html"><a href="evaluation.html#eval-frame"><i class="fa fa-check"></i><b>20.2.4</b> Advanced: environments vs. frames</a></li>
<li class="chapter" data-level="20.2.5" data-path="evaluation.html"><a href="evaluation.html#base-r"><i class="fa fa-check"></i><b>20.2.5</b> Base R</a></li>
<li class="chapter" data-level="20.2.6" data-path="evaluation.html"><a href="evaluation.html#exercises-62"><i class="fa fa-check"></i><b>20.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="20.3" data-path="evaluation.html"><a href="evaluation.html#quosures"><i class="fa fa-check"></i><b>20.3</b> Quosures</a><ul>
<li class="chapter" data-level="20.3.1" data-path="evaluation.html"><a href="evaluation.html#motivation-2"><i class="fa fa-check"></i><b>20.3.1</b> Motivation</a></li>
<li class="chapter" data-level="20.3.2" data-path="evaluation.html"><a href="evaluation.html#creating-and-manipulating"><i class="fa fa-check"></i><b>20.3.2</b> Creating and manipulating</a></li>
<li class="chapter" data-level="20.3.3" data-path="evaluation.html"><a href="evaluation.html#evaluating"><i class="fa fa-check"></i><b>20.3.3</b> Evaluating</a></li>
<li class="chapter" data-level="20.3.4" data-path="evaluation.html"><a href="evaluation.html#implementation"><i class="fa fa-check"></i><b>20.3.4</b> Implementation</a></li>
<li class="chapter" data-level="20.3.5" data-path="evaluation.html"><a href="evaluation.html#when-not-to-use-quosures"><i class="fa fa-check"></i><b>20.3.5</b> When not to use quosures</a></li>
<li class="chapter" data-level="20.3.6" data-path="evaluation.html"><a href="evaluation.html#exercises-63"><i class="fa fa-check"></i><b>20.3.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="20.4" data-path="evaluation.html"><a href="evaluation.html#tidy-evaluation"><i class="fa fa-check"></i><b>20.4</b> Tidy evaluation</a><ul>
<li class="chapter" data-level="20.4.1" data-path="evaluation.html"><a href="evaluation.html#data-masks"><i class="fa fa-check"></i><b>20.4.1</b> Data masks</a></li>
<li class="chapter" data-level="20.4.2" data-path="evaluation.html"><a href="evaluation.html#subset"><i class="fa fa-check"></i><b>20.4.2</b> Application: <code>subset()</code></a></li>
<li class="chapter" data-level="20.4.3" data-path="evaluation.html"><a href="evaluation.html#application-arrange"><i class="fa fa-check"></i><b>20.4.3</b> Application: <code>arrange()</code></a></li>
<li class="chapter" data-level="20.4.4" data-path="evaluation.html"><a href="evaluation.html#ambiguity-and-pronouns"><i class="fa fa-check"></i><b>20.4.4</b> Ambiguity and pronouns</a></li>
<li class="chapter" data-level="20.4.5" data-path="evaluation.html"><a href="evaluation.html#base-subset"><i class="fa fa-check"></i><b>20.4.5</b> Base <code>subset()</code></a></li>
<li class="chapter" data-level="20.4.6" data-path="evaluation.html"><a href="evaluation.html#tidy-eval-performance"><i class="fa fa-check"></i><b>20.4.6</b> Performance</a></li>
<li class="chapter" data-level="20.4.7" data-path="evaluation.html"><a href="evaluation.html#exercises-64"><i class="fa fa-check"></i><b>20.4.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="20.5" data-path="evaluation.html"><a href="evaluation.html#wrapping-quoting-functions"><i class="fa fa-check"></i><b>20.5</b> Wrapping quoting functions</a><ul>
<li class="chapter" data-level="20.5.1" data-path="evaluation.html"><a href="evaluation.html#tidy-evaluation-1"><i class="fa fa-check"></i><b>20.5.1</b> Tidy evaluation</a></li>
<li class="chapter" data-level="20.5.2" data-path="evaluation.html"><a href="evaluation.html#base-r-1"><i class="fa fa-check"></i><b>20.5.2</b> Base R</a></li>
<li class="chapter" data-level="20.5.3" data-path="evaluation.html"><a href="evaluation.html#the-evaluation-environment"><i class="fa fa-check"></i><b>20.5.3</b> The evaluation environment</a></li>
<li class="chapter" data-level="20.5.4" data-path="evaluation.html"><a href="evaluation.html#making-formulas"><i class="fa fa-check"></i><b>20.5.4</b> Making formulas</a></li>
<li class="chapter" data-level="20.5.5" data-path="evaluation.html"><a href="evaluation.html#exercises-65"><i class="fa fa-check"></i><b>20.5.5</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="21" data-path="translation.html"><a href="translation.html"><i class="fa fa-check"></i><b>21</b> Translating R code</a><ul>
<li class="chapter" data-level="21.1" data-path="translation.html"><a href="translation.html#introduction-18"><i class="fa fa-check"></i><b>21.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="translation.html"><a href="translation.html#outline-16"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="translation.html"><a href="translation.html#prequisites-1"><i class="fa fa-check"></i>Prequisites</a></li>
</ul></li>
<li class="chapter" data-level="21.2" data-path="translation.html"><a href="translation.html#html"><i class="fa fa-check"></i><b>21.2</b> HTML</a><ul>
<li class="chapter" data-level="21.2.1" data-path="translation.html"><a href="translation.html#goal"><i class="fa fa-check"></i><b>21.2.1</b> Goal</a></li>
<li class="chapter" data-level="21.2.2" data-path="translation.html"><a href="translation.html#escaping"><i class="fa fa-check"></i><b>21.2.2</b> Escaping</a></li>
<li class="chapter" data-level="21.2.3" data-path="translation.html"><a href="translation.html#basic-tag-functions"><i class="fa fa-check"></i><b>21.2.3</b> Basic tag functions</a></li>
<li class="chapter" data-level="21.2.4" data-path="translation.html"><a href="translation.html#tag-functions"><i class="fa fa-check"></i><b>21.2.4</b> Tag functions</a></li>
<li class="chapter" data-level="21.2.5" data-path="translation.html"><a href="translation.html#processing-all-tags"><i class="fa fa-check"></i><b>21.2.5</b> Processing all tags</a></li>
<li class="chapter" data-level="21.2.6" data-path="translation.html"><a href="translation.html#exercises-66"><i class="fa fa-check"></i><b>21.2.6</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="21.3" data-path="translation.html"><a href="translation.html#latex"><i class="fa fa-check"></i><b>21.3</b> LaTeX</a><ul>
<li class="chapter" data-level="21.3.1" data-path="translation.html"><a href="translation.html#latex-mathematics"><i class="fa fa-check"></i><b>21.3.1</b> LaTeX mathematics</a></li>
<li class="chapter" data-level="21.3.2" data-path="translation.html"><a href="translation.html#goal-1"><i class="fa fa-check"></i><b>21.3.2</b> Goal</a></li>
<li class="chapter" data-level="21.3.3" data-path="translation.html"><a href="translation.html#to_math"><i class="fa fa-check"></i><b>21.3.3</b> <code>to_math</code></a></li>
<li class="chapter" data-level="21.3.4" data-path="translation.html"><a href="translation.html#known-symbols"><i class="fa fa-check"></i><b>21.3.4</b> Known symbols</a></li>
<li class="chapter" data-level="21.3.5" data-path="translation.html"><a href="translation.html#unknown-symbols"><i class="fa fa-check"></i><b>21.3.5</b> Unknown symbols</a></li>
<li class="chapter" data-level="21.3.6" data-path="translation.html"><a href="translation.html#known-functions"><i class="fa fa-check"></i><b>21.3.6</b> Known functions</a></li>
<li class="chapter" data-level="21.3.7" data-path="translation.html"><a href="translation.html#unknown-functions"><i class="fa fa-check"></i><b>21.3.7</b> Unknown functions</a></li>
<li class="chapter" data-level="21.3.8" data-path="translation.html"><a href="translation.html#exercises-67"><i class="fa fa-check"></i><b>21.3.8</b> Exercises</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>V Techniques</b></span></li>
<li class="chapter" data-level="22" data-path="debugging.html"><a href="debugging.html"><i class="fa fa-check"></i><b>22</b> Debugging</a><ul>
<li class="chapter" data-level="22.1" data-path="debugging.html"><a href="debugging.html#introduction-19"><i class="fa fa-check"></i><b>22.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="debugging.html"><a href="debugging.html#outline-17"><i class="fa fa-check"></i>Outline</a></li>
</ul></li>
<li class="chapter" data-level="22.2" data-path="debugging.html"><a href="debugging.html#debugging-techniques"><i class="fa fa-check"></i><b>22.2</b> Techniques</a></li>
<li class="chapter" data-level="22.3" data-path="debugging.html"><a href="debugging.html#debugging-tools"><i class="fa fa-check"></i><b>22.3</b> Tools</a><ul>
<li class="chapter" data-level="22.3.1" data-path="debugging.html"><a href="debugging.html#determining-the-sequence-of-calls"><i class="fa fa-check"></i><b>22.3.1</b> Determining the sequence of calls</a></li>
<li class="chapter" data-level="22.3.2" data-path="debugging.html"><a href="debugging.html#browsing-on-error"><i class="fa fa-check"></i><b>22.3.2</b> Browsing on error</a></li>
<li class="chapter" data-level="22.3.3" data-path="debugging.html"><a href="debugging.html#browsing-arbitrary-code"><i class="fa fa-check"></i><b>22.3.3</b> Browsing arbitrary code</a></li>
<li class="chapter" data-level="22.3.4" data-path="debugging.html"><a href="debugging.html#the-call-stack-traceback-where-and-recover"><i class="fa fa-check"></i><b>22.3.4</b> The call stack: <code>traceback()</code>, <code>where</code>, and <code>recover()</code></a></li>
<li class="chapter" data-level="22.3.5" data-path="debugging.html"><a href="debugging.html#other-types-of-failure"><i class="fa fa-check"></i><b>22.3.5</b> Other types of failure</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="23" data-path="performance.html"><a href="performance.html"><i class="fa fa-check"></i><b>23</b> Performance</a><ul>
<li class="chapter" data-level="23.1" data-path="performance.html"><a href="performance.html#why-is-r-slow"><i class="fa fa-check"></i><b>23.1</b> Why is R slow?</a></li>
<li class="chapter" data-level="23.2" data-path="performance.html"><a href="performance.html#microbenchmarking"><i class="fa fa-check"></i><b>23.2</b> Microbenchmarking</a><ul>
<li class="chapter" data-level="23.2.1" data-path="performance.html"><a href="performance.html#exercises-68"><i class="fa fa-check"></i><b>23.2.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="23.3" data-path="performance.html"><a href="performance.html#language-performance"><i class="fa fa-check"></i><b>23.3</b> Language performance</a><ul>
<li class="chapter" data-level="23.3.1" data-path="performance.html"><a href="performance.html#extreme-dynamism"><i class="fa fa-check"></i><b>23.3.1</b> Extreme dynamism</a></li>
<li class="chapter" data-level="23.3.2" data-path="performance.html"><a href="performance.html#name-lookup-with-mutable-environments"><i class="fa fa-check"></i><b>23.3.2</b> Name lookup with mutable environments</a></li>
<li class="chapter" data-level="23.3.3" data-path="performance.html"><a href="performance.html#lazy-evaluation-overhead"><i class="fa fa-check"></i><b>23.3.3</b> Lazy evaluation overhead</a></li>
<li class="chapter" data-level="23.3.4" data-path="performance.html"><a href="performance.html#exercises-69"><i class="fa fa-check"></i><b>23.3.4</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="23.4" data-path="performance.html"><a href="performance.html#implementation-performance"><i class="fa fa-check"></i><b>23.4</b> Implementation performance</a><ul>
<li class="chapter" data-level="23.4.1" data-path="performance.html"><a href="performance.html#extracting-a-single-value-from-a-data-frame"><i class="fa fa-check"></i><b>23.4.1</b> Extracting a single value from a data frame</a></li>
<li class="chapter" data-level="23.4.2" data-path="performance.html"><a href="performance.html#ifelse-pmin-and-pmax"><i class="fa fa-check"></i><b>23.4.2</b> <code>ifelse()</code>, <code>pmin()</code>, and <code>pmax()</code></a></li>
<li class="chapter" data-level="23.4.3" data-path="performance.html"><a href="performance.html#exercises-70"><i class="fa fa-check"></i><b>23.4.3</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="23.5" data-path="performance.html"><a href="performance.html#faster-r"><i class="fa fa-check"></i><b>23.5</b> Alternative R implementations</a></li>
</ul></li>
<li class="chapter" data-level="24" data-path="profiling.html"><a href="profiling.html"><i class="fa fa-check"></i><b>24</b> Optimising code</a><ul>
<li class="chapter" data-level="24.1" data-path="profiling.html"><a href="profiling.html#introduction-20"><i class="fa fa-check"></i><b>24.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="profiling.html"><a href="profiling.html#outline-18"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="profiling.html"><a href="profiling.html#prerequisites-11"><i class="fa fa-check"></i>Prerequisites</a></li>
</ul></li>
<li class="chapter" data-level="24.2" data-path="profiling.html"><a href="profiling.html#measure-perf"><i class="fa fa-check"></i><b>24.2</b> Measuring performance</a><ul>
<li class="chapter" data-level="24.2.1" data-path="profiling.html"><a href="profiling.html#limitations"><i class="fa fa-check"></i><b>24.2.1</b> Limitations</a></li>
</ul></li>
<li class="chapter" data-level="24.3" data-path="profiling.html"><a href="profiling.html#memory-profiling"><i class="fa fa-check"></i><b>24.3</b> Memory profiling with lineprof</a><ul>
<li class="chapter" data-level="24.3.1" data-path="profiling.html"><a href="profiling.html#exercises-71"><i class="fa fa-check"></i><b>24.3.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="24.4" data-path="profiling.html"><a href="profiling.html#improve-perf"><i class="fa fa-check"></i><b>24.4</b> Improving performance</a></li>
<li class="chapter" data-level="24.5" data-path="profiling.html"><a href="profiling.html#code-organisation"><i class="fa fa-check"></i><b>24.5</b> Code organisation</a></li>
<li class="chapter" data-level="24.6" data-path="profiling.html"><a href="profiling.html#already-solved"><i class="fa fa-check"></i><b>24.6</b> Has someone already solved the problem?</a><ul>
<li class="chapter" data-level="24.6.1" data-path="profiling.html"><a href="profiling.html#exercises-72"><i class="fa fa-check"></i><b>24.6.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="24.7" data-path="profiling.html"><a href="profiling.html#be-lazy"><i class="fa fa-check"></i><b>24.7</b> Do as little as possible</a><ul>
<li class="chapter" data-level="24.7.1" data-path="profiling.html"><a href="profiling.html#exercises-73"><i class="fa fa-check"></i><b>24.7.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="24.8" data-path="profiling.html"><a href="profiling.html#vectorise"><i class="fa fa-check"></i><b>24.8</b> Vectorise</a><ul>
<li class="chapter" data-level="24.8.1" data-path="profiling.html"><a href="profiling.html#exercises-74"><i class="fa fa-check"></i><b>24.8.1</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="24.9" data-path="profiling.html"><a href="profiling.html#avoid-copies"><i class="fa fa-check"></i><b>24.9</b> Avoid copies</a></li>
<li class="chapter" data-level="24.10" data-path="profiling.html"><a href="profiling.html#byte-code"><i class="fa fa-check"></i><b>24.10</b> Byte code compilation</a></li>
<li class="chapter" data-level="24.11" data-path="profiling.html"><a href="profiling.html#t-test"><i class="fa fa-check"></i><b>24.11</b> Case study: t-test</a></li>
<li class="chapter" data-level="24.12" data-path="profiling.html"><a href="profiling.html#parallelise"><i class="fa fa-check"></i><b>24.12</b> Parallelise</a></li>
<li class="chapter" data-level="24.13" data-path="profiling.html"><a href="profiling.html#more-techniques"><i class="fa fa-check"></i><b>24.13</b> Other techniques</a></li>
</ul></li>
<li class="chapter" data-level="25" data-path="rcpp.html"><a href="rcpp.html"><i class="fa fa-check"></i><b>25</b> Rewriting R code in C++</a><ul>
<li class="chapter" data-level="25.1" data-path="rcpp.html"><a href="rcpp.html#introduction-21"><i class="fa fa-check"></i><b>25.1</b> Introduction</a><ul>
<li class="chapter" data-level="" data-path="rcpp.html"><a href="rcpp.html#outline-19"><i class="fa fa-check"></i>Outline</a></li>
<li class="chapter" data-level="" data-path="rcpp.html"><a href="rcpp.html#prerequistes"><i class="fa fa-check"></i>Prerequistes</a></li>
</ul></li>
<li class="chapter" data-level="25.2" data-path="rcpp.html"><a href="rcpp.html#rcpp-intro"><i class="fa fa-check"></i><b>25.2</b> Getting started with C++</a><ul>
<li class="chapter" data-level="25.2.1" data-path="rcpp.html"><a href="rcpp.html#no-inputs-scalar-output"><i class="fa fa-check"></i><b>25.2.1</b> No inputs, scalar output</a></li>
<li class="chapter" data-level="25.2.2" data-path="rcpp.html"><a href="rcpp.html#scalar-input-scalar-output"><i class="fa fa-check"></i><b>25.2.2</b> Scalar input, scalar output</a></li>
<li class="chapter" data-level="25.2.3" data-path="rcpp.html"><a href="rcpp.html#vector-input-scalar-output"><i class="fa fa-check"></i><b>25.2.3</b> Vector input, scalar output</a></li>
<li class="chapter" data-level="25.2.4" data-path="rcpp.html"><a href="rcpp.html#vector-input-vector-output"><i class="fa fa-check"></i><b>25.2.4</b> Vector input, vector output</a></li>
<li class="chapter" data-level="25.2.5" data-path="rcpp.html"><a href="rcpp.html#matrix-input-vector-output"><i class="fa fa-check"></i><b>25.2.5</b> Matrix input, vector output</a></li>
<li class="chapter" data-level="25.2.6" data-path="rcpp.html"><a href="rcpp.html#sourceCpp"><i class="fa fa-check"></i><b>25.2.6</b> Using sourceCpp</a></li>
<li class="chapter" data-level="25.2.7" data-path="rcpp.html"><a href="rcpp.html#exercises-75"><i class="fa fa-check"></i><b>25.2.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="25.3" data-path="rcpp.html"><a href="rcpp.html#rcpp-classes"><i class="fa fa-check"></i><b>25.3</b> Attributes and other classes</a><ul>
<li class="chapter" data-level="25.3.1" data-path="rcpp.html"><a href="rcpp.html#lists-and-data-frames"><i class="fa fa-check"></i><b>25.3.1</b> Lists and data frames</a></li>
<li class="chapter" data-level="25.3.2" data-path="rcpp.html"><a href="rcpp.html#functions-rcpp"><i class="fa fa-check"></i><b>25.3.2</b> Functions</a></li>
<li class="chapter" data-level="25.3.3" data-path="rcpp.html"><a href="rcpp.html#other-types"><i class="fa fa-check"></i><b>25.3.3</b> Other types</a></li>
</ul></li>
<li class="chapter" data-level="25.4" data-path="rcpp.html"><a href="rcpp.html#rcpp-na"><i class="fa fa-check"></i><b>25.4</b> Missing values</a><ul>
<li class="chapter" data-level="25.4.1" data-path="rcpp.html"><a href="rcpp.html#scalars-1"><i class="fa fa-check"></i><b>25.4.1</b> Scalars</a></li>
<li class="chapter" data-level="25.4.2" data-path="rcpp.html"><a href="rcpp.html#strings"><i class="fa fa-check"></i><b>25.4.2</b> Strings</a></li>
<li class="chapter" data-level="25.4.3" data-path="rcpp.html"><a href="rcpp.html#boolean"><i class="fa fa-check"></i><b>25.4.3</b> Boolean</a></li>
<li class="chapter" data-level="25.4.4" data-path="rcpp.html"><a href="rcpp.html#vectors-rcpp"><i class="fa fa-check"></i><b>25.4.4</b> Vectors</a></li>
<li class="chapter" data-level="25.4.5" data-path="rcpp.html"><a href="rcpp.html#exercises-76"><i class="fa fa-check"></i><b>25.4.5</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="25.5" data-path="rcpp.html"><a href="rcpp.html#rcpp-sugar"><i class="fa fa-check"></i><b>25.5</b> Rcpp sugar</a><ul>
<li class="chapter" data-level="25.5.1" data-path="rcpp.html"><a href="rcpp.html#arithmetic-and-logical-operators"><i class="fa fa-check"></i><b>25.5.1</b> Arithmetic and logical operators</a></li>
<li class="chapter" data-level="25.5.2" data-path="rcpp.html"><a href="rcpp.html#logical-summary-functions"><i class="fa fa-check"></i><b>25.5.2</b> Logical summary functions</a></li>
<li class="chapter" data-level="25.5.3" data-path="rcpp.html"><a href="rcpp.html#vector-views"><i class="fa fa-check"></i><b>25.5.3</b> Vector views</a></li>
<li class="chapter" data-level="25.5.4" data-path="rcpp.html"><a href="rcpp.html#other-useful-functions"><i class="fa fa-check"></i><b>25.5.4</b> Other useful functions</a></li>
</ul></li>
<li class="chapter" data-level="25.6" data-path="rcpp.html"><a href="rcpp.html#stl"><i class="fa fa-check"></i><b>25.6</b> The STL</a><ul>
<li class="chapter" data-level="25.6.1" data-path="rcpp.html"><a href="rcpp.html#using-iterators"><i class="fa fa-check"></i><b>25.6.1</b> Using iterators</a></li>
<li class="chapter" data-level="25.6.2" data-path="rcpp.html"><a href="rcpp.html#algorithms"><i class="fa fa-check"></i><b>25.6.2</b> Algorithms</a></li>
<li class="chapter" data-level="25.6.3" data-path="rcpp.html"><a href="rcpp.html#data-structures-rcpp"><i class="fa fa-check"></i><b>25.6.3</b> Data structures</a></li>
<li class="chapter" data-level="25.6.4" data-path="rcpp.html"><a href="rcpp.html#vectors-stl"><i class="fa fa-check"></i><b>25.6.4</b> Vectors</a></li>
<li class="chapter" data-level="25.6.5" data-path="rcpp.html"><a href="rcpp.html#sets"><i class="fa fa-check"></i><b>25.6.5</b> Sets</a></li>
<li class="chapter" data-level="25.6.6" data-path="rcpp.html"><a href="rcpp.html#map-1"><i class="fa fa-check"></i><b>25.6.6</b> Map</a></li>
<li class="chapter" data-level="25.6.7" data-path="rcpp.html"><a href="rcpp.html#exercises-77"><i class="fa fa-check"></i><b>25.6.7</b> Exercises</a></li>
</ul></li>
<li class="chapter" data-level="25.7" data-path="rcpp.html"><a href="rcpp.html#rcpp-case-studies"><i class="fa fa-check"></i><b>25.7</b> Case studies</a><ul>
<li class="chapter" data-level="25.7.1" data-path="rcpp.html"><a href="rcpp.html#gibbs-sampler"><i class="fa fa-check"></i><b>25.7.1</b> Gibbs sampler</a></li>
<li class="chapter" data-level="25.7.2" data-path="rcpp.html"><a href="rcpp.html#r-vectorisation-vs.c-vectorisation"><i class="fa fa-check"></i><b>25.7.2</b> R vectorisation vs. C++ vectorisation</a></li>
</ul></li>
<li class="chapter" data-level="25.8" data-path="rcpp.html"><a href="rcpp.html#rcpp-package"><i class="fa fa-check"></i><b>25.8</b> Using Rcpp in a package</a></li>
<li class="chapter" data-level="25.9" data-path="rcpp.html"><a href="rcpp.html#rcpp-more"><i class="fa fa-check"></i><b>25.9</b> Learning more</a></li>
<li class="chapter" data-level="25.10" data-path="rcpp.html"><a href="rcpp.html#acknowledgments"><i class="fa fa-check"></i><b>25.10</b> Acknowledgments</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i>References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="evaluation" class="section level1">
<h1><span class="header-section-number">20</span> Evaluation</h1>
<div id="introduction-17" class="section level2">
<h2><span class="header-section-number">20.1</span> Introduction</h2>
<p>The user-facing opposite of quotation is unquotation: it gives the <em>user</em> the ability to selectively evaluate parts of an otherwise quoted argument. The developer-facing complement of quotation is evaluation: this gives the <em>developer</em> the ability to evaluate quoted expressions in custom environments to achieve specific goals.</p>
<p>This chapter begins with a discussion of evaluation in its purest form with <code>rlang::eval_bare()</code> which evaluates an expression in given environment. We’ll then see how these ideas are used to implement a handful of base R functions, and then learn about the similar <code>base::eval()</code>.</p>
<p>The meat of the chapter focusses on extensions needed to implement evaluation robustly. There are two big new ideas:</p>
<ul>
<li><p>We need a new data structure that captures both the expression <strong>and</strong> the
environment associated with each function argument. We call this data
structure a <strong>quosure</strong>.</p></li>
<li><p><code>base::eval()</code> supports evaluating an expression in the context of a data
frame and an environment. We formalise this idea by calling it <strong>data mask</strong>
and to resolve the ambiguity it creates, introduce the idea of data
pronouns.</p></li>
</ul>
<p>Together, quasiquotation, quosures, data masks, and pronouns form what we call <strong>tidy evaluation</strong>, or tidy eval for short. Tidy eval provides a principled approach to NSE that makes it possible to use such functions both interactively and embedded with other functions. We’ll finish off the chapter showing the basic pattern you use to wrap quasiquoting functions, and how you can adapt that pattern to base R NSE functions.</p>
<div id="outline-15" class="section level3 unnumbered">
<h3>Outline</h3>
</div>
<div id="prerequisites-10" class="section level3 unnumbered">
<h3>Prerequisites</h3>
<p>Environments play a very important big role in evaluation, so make sure you’re familiar with the basics in <a href="function-factories.html#environments-1">Environments</a>.</p>
<div class="sourceCode" id="cb802"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb802-1" data-line-number="1"><span class="kw">library</span>(rlang)</a></code></pre></div>
</div>
</div>
<div id="evaluation-basics" class="section level2">
<h2><span class="header-section-number">20.2</span> Evaluation basics</h2>
<p>In the previous chapter, we briefly mentioned <code>eval()</code>. Here, however, we’re going to start with <code>rlang::eval_bare()</code> which is the purest evocation of the idea of evaluation. The first argument, <code>expr</code> is an expression to evaluate. This will usually be either a symbol or expression:</p>
<div class="sourceCode" id="cb803"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb803-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb803-2" data-line-number="2"><span class="kw">eval_bare</span>(<span class="kw">expr</span>(x))</a>
<a class="sourceLine" id="cb803-3" data-line-number="3"><span class="co">#&gt; [1] 10</span></a>
<a class="sourceLine" id="cb803-4" data-line-number="4"></a>
<a class="sourceLine" id="cb803-5" data-line-number="5">y &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb803-6" data-line-number="6"><span class="kw">eval_bare</span>(<span class="kw">expr</span>(x <span class="op">+</span><span class="st"> </span>y))</a>
<a class="sourceLine" id="cb803-7" data-line-number="7"><span class="co">#&gt; [1] 12</span></a></code></pre></div>
<p>Everything else yields itself when evaluated:</p>
<div class="sourceCode" id="cb804"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb804-1" data-line-number="1"><span class="kw">eval_bare</span>(<span class="dv">10</span>)</a>
<a class="sourceLine" id="cb804-2" data-line-number="2"><span class="co">#&gt; [1] 10</span></a></code></pre></div>
<p>The second argument, <code>env</code>, gives the environment in which the expression should be evaluated, i.e. where should the values of <code>x</code>, <code>y</code>, and <code>+</code> be looked for? By default, this is the current environment, i.e. the calling environment of <code>eval_bare()</code>, but you can override it if you want:</p>
<div class="sourceCode" id="cb805"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb805-1" data-line-number="1"><span class="kw">eval_bare</span>(<span class="kw">expr</span>(x <span class="op">+</span><span class="st"> </span>y), <span class="kw">env</span>(<span class="dt">x =</span> <span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb805-2" data-line-number="2"><span class="co">#&gt; [1] 1002</span></a></code></pre></div>
<p>Because R looks up functions in the same way as variables, we can also override the meaning of functions. This is a very useful technique if you want to translate R code into something else, as you’ll learn about in the next chapter.</p>
<div class="sourceCode" id="cb806"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb806-1" data-line-number="1"><span class="kw">eval_bare</span>(</a>
<a class="sourceLine" id="cb806-2" data-line-number="2">  <span class="kw">expr</span>(x <span class="op">+</span><span class="st"> </span>y), </a>
<a class="sourceLine" id="cb806-3" data-line-number="3">  <span class="kw">env</span>(<span class="st">`</span><span class="dt">+</span><span class="st">`</span> =<span class="st"> </span><span class="cf">function</span>(x, y) <span class="kw">paste0</span>(x, <span class="st">&quot; + &quot;</span>, y))</a>
<a class="sourceLine" id="cb806-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb806-5" data-line-number="5"><span class="co">#&gt; [1] &quot;10 + 2&quot;</span></a></code></pre></div>
<p>Note that the first argument to <code>eval_bare()</code> (and to <code>base::eval()</code>) is evaluated, not quoted. This can lead to confusing results if you forget to quote the input:</p>
<div class="sourceCode" id="cb807"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb807-1" data-line-number="1"><span class="kw">eval_bare</span>(x <span class="op">+</span><span class="st"> </span>y)</a>
<a class="sourceLine" id="cb807-2" data-line-number="2"><span class="co">#&gt; [1] 12</span></a>
<a class="sourceLine" id="cb807-3" data-line-number="3"><span class="kw">eval_bare</span>(x <span class="op">+</span><span class="st"> </span>y, <span class="kw">env</span>(<span class="dt">x =</span> <span class="dv">1000</span>))</a>
<a class="sourceLine" id="cb807-4" data-line-number="4"><span class="co">#&gt; [1] 12</span></a></code></pre></div>
<p>Now that you’ve seen the basics, let’s explore some applications. We’ll focus primarily on base R functions that you might have used before; now you can learn how they work. To focus on the underlying principles, we’ll extract out their essence, and rewrite to use rlang functions. Once you’ve seen some applications, we’ll circle back and talk about more about <code>base::eval()</code>.</p>
<div id="application-local" class="section level3">
<h3><span class="header-section-number">20.2.1</span> Application: <code>local()</code></h3>
<p>Sometimes you want to perform a chunk of calculation that creates a bunch of intermediate variables. The intermediate variables have no long-term use and could be quite large, so you’d rather not keep them around. One approach is to clean up after yourself using <code>rm()</code>; another approach is to wrap the code in a function, and just call it once. A more elegant approach is to use <code>local()</code>:</p>
<div class="sourceCode" id="cb808"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb808-1" data-line-number="1"><span class="co"># Clean up variables created earlier</span></a>
<a class="sourceLine" id="cb808-2" data-line-number="2"><span class="kw">rm</span>(x, y)</a>
<a class="sourceLine" id="cb808-3" data-line-number="3"></a>
<a class="sourceLine" id="cb808-4" data-line-number="4">foo &lt;-<span class="st"> </span><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb808-5" data-line-number="5">  x &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb808-6" data-line-number="6">  y &lt;-<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb808-7" data-line-number="7">  x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb808-8" data-line-number="8">})</a>
<a class="sourceLine" id="cb808-9" data-line-number="9"></a>
<a class="sourceLine" id="cb808-10" data-line-number="10">foo</a>
<a class="sourceLine" id="cb808-11" data-line-number="11"><span class="co">#&gt; [1] 210</span></a>
<a class="sourceLine" id="cb808-12" data-line-number="12">x</a>
<a class="sourceLine" id="cb808-13" data-line-number="13"><span class="co">#&gt; Error in eval(expr, envir, enclos):</span></a>
<a class="sourceLine" id="cb808-14" data-line-number="14"><span class="co">#&gt;   object &#39;x&#39; not found</span></a>
<a class="sourceLine" id="cb808-15" data-line-number="15">y</a>
<a class="sourceLine" id="cb808-16" data-line-number="16"><span class="co">#&gt; Error in eval(expr, envir, enclos):</span></a>
<a class="sourceLine" id="cb808-17" data-line-number="17"><span class="co">#&gt;   object &#39;y&#39; not found</span></a></code></pre></div>
<p>The essence of <code>local()</code> is quite simple. We capture the input expression, and create a new environment in which to evaluate it. This inherits from the caller environment so it can access the current lexical scope, but any intermediate variables will be GC’d once the function has returned.</p>
<div class="sourceCode" id="cb809"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb809-1" data-line-number="1">local2 &lt;-<span class="st"> </span><span class="cf">function</span>(expr) {</a>
<a class="sourceLine" id="cb809-2" data-line-number="2">  env &lt;-<span class="st"> </span><span class="kw">child_env</span>(<span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb809-3" data-line-number="3">  <span class="kw">eval_bare</span>(<span class="kw">enexpr</span>(expr), env)</a>
<a class="sourceLine" id="cb809-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb809-5" data-line-number="5"></a>
<a class="sourceLine" id="cb809-6" data-line-number="6">foo &lt;-<span class="st"> </span><span class="kw">local2</span>({</a>
<a class="sourceLine" id="cb809-7" data-line-number="7">  x &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb809-8" data-line-number="8">  y &lt;-<span class="st"> </span><span class="dv">200</span></a>
<a class="sourceLine" id="cb809-9" data-line-number="9">  x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb809-10" data-line-number="10">})</a>
<a class="sourceLine" id="cb809-11" data-line-number="11"></a>
<a class="sourceLine" id="cb809-12" data-line-number="12">foo</a>
<a class="sourceLine" id="cb809-13" data-line-number="13"><span class="co">#&gt; [1] 210</span></a>
<a class="sourceLine" id="cb809-14" data-line-number="14">x</a>
<a class="sourceLine" id="cb809-15" data-line-number="15"><span class="co">#&gt; Error in eval(expr, envir, enclos):</span></a>
<a class="sourceLine" id="cb809-16" data-line-number="16"><span class="co">#&gt;   object &#39;x&#39; not found</span></a>
<a class="sourceLine" id="cb809-17" data-line-number="17">y</a>
<a class="sourceLine" id="cb809-18" data-line-number="18"><span class="co">#&gt; Error in eval(expr, envir, enclos):</span></a>
<a class="sourceLine" id="cb809-19" data-line-number="19"><span class="co">#&gt;   object &#39;y&#39; not found</span></a></code></pre></div>
<p>Understanding how <code>base::local()</code> works is harder, as it uses <code>eval()</code> and <code>substitute()</code> together in rather complicated ways. Figuring out exactly what’s going on is good practice if you really want to understand the subtleties of <code>substitute()</code> and the base <code>eval()</code> functions, so is included in the exercises below.</p>
</div>
<div id="application-source" class="section level3">
<h3><span class="header-section-number">20.2.2</span> Application: <code>source()</code></h3>
<p>We can create a simple version of <code>source()</code> by combining <code>parse_expr()</code> and <code>eval_bare()</code>. We read in the file from disk, use <code>parse_expr()</code> to parse the string into a list of expressions, and then use <code>eval_bare()</code> to evaluate each component in turn. This version evaluates the code in the caller environment, and invisibly returns the result of the last expression in the file like <code>source()</code>. </p>
<div class="sourceCode" id="cb810"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb810-1" data-line-number="1">source2 &lt;-<span class="st"> </span><span class="cf">function</span>(path, <span class="dt">env =</span> <span class="kw">caller_env</span>()) {</a>
<a class="sourceLine" id="cb810-2" data-line-number="2">  file &lt;-<span class="st"> </span><span class="kw">paste</span>(<span class="kw">readLines</span>(path, <span class="dt">warn =</span> <span class="ot">FALSE</span>), <span class="dt">collapse =</span> <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</a>
<a class="sourceLine" id="cb810-3" data-line-number="3">  exprs &lt;-<span class="st"> </span><span class="kw">parse_exprs</span>(file)</a>
<a class="sourceLine" id="cb810-4" data-line-number="4"></a>
<a class="sourceLine" id="cb810-5" data-line-number="5">  res &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb810-6" data-line-number="6">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(exprs)) {</a>
<a class="sourceLine" id="cb810-7" data-line-number="7">    res &lt;-<span class="st"> </span><span class="kw">eval_bare</span>(exprs[[i]], env)</a>
<a class="sourceLine" id="cb810-8" data-line-number="8">  }</a>
<a class="sourceLine" id="cb810-9" data-line-number="9">  </a>
<a class="sourceLine" id="cb810-10" data-line-number="10">  <span class="kw">invisible</span>(res)</a>
<a class="sourceLine" id="cb810-11" data-line-number="11">}</a></code></pre></div>
<p>The real <code>source()</code> is considerably more complicated because it can <code>echo</code> input and output, and has many other settings that control its behaviour.</p>
</div>
<div id="gotcha-function" class="section level3">
<h3><span class="header-section-number">20.2.3</span> Gotcha: <code>function()</code></h3>
<p>There’s one small gotcha that you should be aware of if you’re using <code>eval_bare()</code> and <code>expr()</code> to generate functions:</p>
<div class="sourceCode" id="cb811"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb811-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb811-2" data-line-number="2">y &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb811-3" data-line-number="3">f &lt;-<span class="st"> </span><span class="kw">eval_bare</span>(<span class="kw">expr</span>(<span class="cf">function</span>(x, y) <span class="op">!!</span>x <span class="op">+</span><span class="st"> </span><span class="op">!!</span>y))</a>
<a class="sourceLine" id="cb811-4" data-line-number="4">f</a>
<a class="sourceLine" id="cb811-5" data-line-number="5"><span class="co">#&gt; function(x, y) !!x + !!y</span></a></code></pre></div>
<p>This function doesn’t look like it will work, but it does:</p>
<div class="sourceCode" id="cb812"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb812-1" data-line-number="1"><span class="kw">f</span>()</a>
<a class="sourceLine" id="cb812-2" data-line-number="2"><span class="co">#&gt; [1] 30</span></a></code></pre></div>
<p>This is because, if available, functions print their <code>srcref</code>. The source reference is a base R feature that doesn’t know about quasiquotation. To work around this problem, I recommend using <code>new_function()</code> as shown in the previous chapter. Alternatively, you can remove the <code>srcref</code> attribute:</p>
<div class="sourceCode" id="cb813"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb813-1" data-line-number="1"><span class="kw">attr</span>(f, <span class="st">&quot;srcref&quot;</span>) &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb813-2" data-line-number="2">f</a>
<a class="sourceLine" id="cb813-3" data-line-number="3"><span class="co">#&gt; function (x, y) </span></a>
<a class="sourceLine" id="cb813-4" data-line-number="4"><span class="co">#&gt; 10 + 20</span></a></code></pre></div>
</div>
<div id="eval-frame" class="section level3">
<h3><span class="header-section-number">20.2.4</span> Advanced: environments vs. frames</h3>
<p><span class="todo">Frame look up from environment</span></p>
<div class="sourceCode" id="cb814"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb814-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="kw">g</span>()</a>
<a class="sourceLine" id="cb814-2" data-line-number="2">g &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="kw">h</span>()</a>
<a class="sourceLine" id="cb814-3" data-line-number="3">h &lt;-<span class="st"> </span><span class="cf">function</span>() <span class="kw">eval</span>(<span class="kw">expr</span>(lobstr<span class="op">::</span><span class="kw">cst</span>()), <span class="kw">caller_env</span>(<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb814-4" data-line-number="4"><span class="kw">f</span>()</a>
<a class="sourceLine" id="cb814-5" data-line-number="5"><span class="co">#&gt; █</span></a>
<a class="sourceLine" id="cb814-6" data-line-number="6"><span class="co">#&gt; └─f()</span></a>
<a class="sourceLine" id="cb814-7" data-line-number="7"><span class="co">#&gt;   ├─g()</span></a>
<a class="sourceLine" id="cb814-8" data-line-number="8"><span class="co">#&gt;   │ └─h()</span></a>
<a class="sourceLine" id="cb814-9" data-line-number="9"><span class="co">#&gt;   │   └─eval(expr(lobstr::cst()), caller_env(2))</span></a>
<a class="sourceLine" id="cb814-10" data-line-number="10"><span class="co">#&gt;   │     └─eval(expr(lobstr::cst()), caller_env(2))</span></a>
<a class="sourceLine" id="cb814-11" data-line-number="11"><span class="co">#&gt;   └─lobstr::cst()</span></a></code></pre></div>
</div>
<div id="base-r" class="section level3">
<h3><span class="header-section-number">20.2.5</span> Base R</h3>
<p>The base function equivalent to <code>eval_bare()</code> is the two-argument form of <code>eval()</code>: <code>eval(expr, envir)</code>:</p>
<div class="sourceCode" id="cb815"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb815-1" data-line-number="1"><span class="kw">eval</span>(<span class="kw">expr</span>(x <span class="op">+</span><span class="st"> </span>y), <span class="kw">env</span>(<span class="dt">x =</span> <span class="dv">1000</span>, <span class="dt">y =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb815-2" data-line-number="2"><span class="co">#&gt; [1] 1001</span></a></code></pre></div>
<p>The final argument, <code>enclos</code> provides support for data masks, which you’ll learn about in <a href="evaluation.html#tidy-evaluation-1">tidy evaluation</a>.</p>
<p><code>eval()</code> is paired with two helper functions:</p>
<ul>
<li><p><code>evalq(x, env)</code> quotes its first argument, and is hence a shortcut for
<code>eval(quote(x), env)</code>.</p></li>
<li><p><code>eval.parent(expr, n)</code> is shortcut for <code>eval(expr, env = parent.frame(n))</code>.</p></li>
</ul>
<p><code>base::eval()</code> has special behaviour for expression <strong>objects</strong>, evaluating each component in turn. This makes for a very compact implementation of <code>source2()</code> because <code>base::parse()</code> also returns an expression object:</p>
<div class="sourceCode" id="cb816"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb816-1" data-line-number="1">source3 &lt;-<span class="st"> </span><span class="cf">function</span>(file, <span class="dt">env =</span> <span class="kw">parent.frame</span>()) {</a>
<a class="sourceLine" id="cb816-2" data-line-number="2">  lines &lt;-<span class="st"> </span><span class="kw">parse</span>(file)</a>
<a class="sourceLine" id="cb816-3" data-line-number="3">  res &lt;-<span class="st"> </span><span class="kw">eval</span>(lines, <span class="dt">envir =</span> env)</a>
<a class="sourceLine" id="cb816-4" data-line-number="4">  <span class="kw">invisible</span>(res)</a>
<a class="sourceLine" id="cb816-5" data-line-number="5">}</a></code></pre></div>
<p>While <code>source3()</code> is considerably more concise than <code>source2()</code>, this one use case is the strongest argument for expression objects, and overall we don’t believe this one benefit outweighs the cost of introducing a new data structure. That’s why this book has renegated expression objects to a secondary role.</p>
</div>
<div id="exercises-62" class="section level3">
<h3><span class="header-section-number">20.2.6</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>Carefully read the documentation for <code>source()</code>. What environment does it
use by default? What if you supply <code>local = TRUE</code>? How do you provide
a custom argument?</p></li>
<li><p>Predict the results of the following lines of code:</p>
<div class="sourceCode" id="cb817"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb817-1" data-line-number="1"><span class="kw">eval</span>(<span class="kw">quote</span>(<span class="kw">eval</span>(<span class="kw">quote</span>(<span class="kw">eval</span>(<span class="kw">quote</span>(<span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>))))))</a>
<a class="sourceLine" id="cb817-2" data-line-number="2"><span class="kw">eval</span>(<span class="kw">eval</span>(<span class="kw">quote</span>(<span class="kw">eval</span>(<span class="kw">quote</span>(<span class="kw">eval</span>(<span class="kw">quote</span>(<span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)))))))</a>
<a class="sourceLine" id="cb817-3" data-line-number="3"><span class="kw">quote</span>(<span class="kw">eval</span>(<span class="kw">quote</span>(<span class="kw">eval</span>(<span class="kw">quote</span>(<span class="kw">eval</span>(<span class="kw">quote</span>(<span class="dv">2</span> <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)))))))</a></code></pre></div></li>
<li><p>Write an equivalent to <code>get()</code> using <code>sym()</code> and <code>eval_bare()</code>. Write an
equivalent to <code>assign()</code> using <code>sym()</code>, <code>expr()</code>, and <code>eval_bare()</code>.
(Don’t worry about the multiple ways of choosing an environment that
<code>get()</code> and <code>assign()</code> support; assume that the user supplies it
explicitly.)</p>
<div class="sourceCode" id="cb818"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb818-1" data-line-number="1"><span class="co"># name is a string</span></a>
<a class="sourceLine" id="cb818-2" data-line-number="2">get2 &lt;-<span class="st"> </span><span class="cf">function</span>(name, env) {}</a>
<a class="sourceLine" id="cb818-3" data-line-number="3">assign2 &lt;-<span class="st"> </span><span class="cf">function</span>(name, value, env) {}</a></code></pre></div></li>
<li><p>Modify <code>source2()</code> so it returns the result of <em>every</em> expression,
not just the last one. Can you eliminate the for loop?</p></li>
<li><p>The code generated by <code>source2()</code> lacks source references. Read
the source code for <code>sys.source()</code> and the help for <code>srcfilecopy()</code>,
then modify <code>source2()</code> to preserve source references. You can
test your code by sourcing a function that contains a comment. If
successful, when you look at the function, you’ll see the comment and
not just the source code.</p></li>
<li><p>We can make <code>base::local()</code> slightly easier to understand by spreading
out over multiple lines:</p>
<div class="sourceCode" id="cb819"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb819-1" data-line-number="1">local3 &lt;-<span class="st"> </span><span class="cf">function</span>(expr, <span class="dt">envir =</span> <span class="kw">new.env</span>()) {</a>
<a class="sourceLine" id="cb819-2" data-line-number="2">  call &lt;-<span class="st"> </span><span class="kw">substitute</span>(<span class="kw">eval</span>(<span class="kw">quote</span>(expr), envir))</a>
<a class="sourceLine" id="cb819-3" data-line-number="3">  <span class="kw">eval</span>(call, <span class="dt">envir =</span> <span class="kw">parent.frame</span>())</a>
<a class="sourceLine" id="cb819-4" data-line-number="4">}</a></code></pre></div>
<p>Explain how <code>local()</code> works in words. (Hint: you might want to <code>print(call)</code>
to help understand what <code>substitute()</code> is doing, and read the documentation
to remind yourself what environment <code>new.env()</code> will inherit from.)</p></li>
</ol>
</div>
</div>
<div id="quosures" class="section level2">
<h2><span class="header-section-number">20.3</span> Quosures</h2>
<p>The simplest form of evaluation combines an expression and an environment. This coupling is so important that we need a data structure that can hold both pieces: we need a <strong>quosure</strong>, a portmanteau of quoting and closure. In this section, you’ll learn about why quosures are important, how to create and manipulate them, and a little about how they are implemented. We’ll finish off by discussing the few cases where you should work with expressions rather than quosures.</p>
<div id="motivation-2" class="section level3">
<h3><span class="header-section-number">20.3.1</span> Motivation</h3>
<p>Quosures are important when the distance between capturing and evaluating an expression grows. Take this simple, if somewhat contrived example:</p>
<div class="sourceCode" id="cb820"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb820-1" data-line-number="1">foo &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb820-2" data-line-number="2">  y &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb820-3" data-line-number="3">  x &lt;-<span class="st"> </span><span class="kw">enexpr</span>(x)</a>
<a class="sourceLine" id="cb820-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb820-5" data-line-number="5">  <span class="kw">eval_bare</span>(x)</a>
<a class="sourceLine" id="cb820-6" data-line-number="6">}</a></code></pre></div>
<p>It appears to work for simple cases:</p>
<div class="sourceCode" id="cb821"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb821-1" data-line-number="1">z &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb821-2" data-line-number="2"><span class="kw">foo</span>(z <span class="op">*</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb821-3" data-line-number="3"><span class="co">#&gt; [1] 200</span></a></code></pre></div>
<p>But if our expression uses <code>y</code> it will find the wrong one:</p>
<div class="sourceCode" id="cb822"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb822-1" data-line-number="1">y &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb822-2" data-line-number="2"><span class="kw">foo</span>(y <span class="op">*</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb822-3" data-line-number="3"><span class="co">#&gt; [1] 200</span></a></code></pre></div>
<p>We could fix this by manually specifying the correct environment:</p>
<div class="sourceCode" id="cb823"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb823-1" data-line-number="1">foo2 &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb823-2" data-line-number="2">  y &lt;-<span class="st"> </span><span class="dv">100</span></a>
<a class="sourceLine" id="cb823-3" data-line-number="3">  x &lt;-<span class="st"> </span><span class="kw">enexpr</span>(x)</a>
<a class="sourceLine" id="cb823-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb823-5" data-line-number="5">  <span class="kw">eval_bare</span>(x, <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb823-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb823-7" data-line-number="7"></a>
<a class="sourceLine" id="cb823-8" data-line-number="8">y &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb823-9" data-line-number="9"><span class="kw">foo2</span>(y <span class="op">*</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb823-10" data-line-number="10"><span class="co">#&gt; [1] 20</span></a></code></pre></div>
<p>That works for this simple case, but does not generalise well. Take this more complicated example that uses <code>...</code>. Each argument to <code>f()</code> needs to be evaluated in a different environment:</p>
<div class="sourceCode" id="cb824"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb824-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb824-2" data-line-number="2">  x &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb824-3" data-line-number="3">  <span class="kw">g</span>(..., <span class="dt">x =</span> x)</a>
<a class="sourceLine" id="cb824-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb824-5" data-line-number="5"></a>
<a class="sourceLine" id="cb824-6" data-line-number="6">g &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb824-7" data-line-number="7">  x &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb824-8" data-line-number="8">  <span class="kw">h</span>(..., <span class="dt">x =</span> x)</a>
<a class="sourceLine" id="cb824-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb824-10" data-line-number="10"></a>
<a class="sourceLine" id="cb824-11" data-line-number="11">h &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb824-12" data-line-number="12">  exprs &lt;-<span class="st"> </span><span class="kw">enexprs</span>(...)</a>
<a class="sourceLine" id="cb824-13" data-line-number="13">  purrr<span class="op">::</span><span class="kw">map_dbl</span>(exprs, eval_bare, <span class="dt">env =</span> <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb824-14" data-line-number="14">}</a>
<a class="sourceLine" id="cb824-15" data-line-number="15"></a>
<a class="sourceLine" id="cb824-16" data-line-number="16">x &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb824-17" data-line-number="17"><span class="kw">f</span>(<span class="dt">x =</span> x)</a>
<a class="sourceLine" id="cb824-18" data-line-number="18"><span class="co">#&gt; x x x </span></a>
<a class="sourceLine" id="cb824-19" data-line-number="19"><span class="co">#&gt; 2 2 2</span></a></code></pre></div>
<p>We can overcome this problem by using two new tools that you’ll learn about shortly: we capture with <code>enquos()</code> instead of <code>enexprs()</code>, and evaluate with <code>eval_tidy()</code> instead of <code>eval_bare()</code>:</p>
<div class="sourceCode" id="cb825"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb825-1" data-line-number="1">h &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb825-2" data-line-number="2">  exprs &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)</a>
<a class="sourceLine" id="cb825-3" data-line-number="3">  purrr<span class="op">::</span><span class="kw">map_dbl</span>(exprs, eval_tidy)</a>
<a class="sourceLine" id="cb825-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb825-5" data-line-number="5"></a>
<a class="sourceLine" id="cb825-6" data-line-number="6">x &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb825-7" data-line-number="7"><span class="kw">f</span>(<span class="dt">x =</span> x)</a>
<a class="sourceLine" id="cb825-8" data-line-number="8"><span class="co">#&gt; x x x </span></a>
<a class="sourceLine" id="cb825-9" data-line-number="9"><span class="co">#&gt; 0 1 2</span></a></code></pre></div>
<p>This ensures that each expression is evaluated in the correct environment.</p>
</div>
<div id="creating-and-manipulating" class="section level3">
<h3><span class="header-section-number">20.3.2</span> Creating and manipulating</h3>
<p>Each of the <code>expr()</code> functions that you learned about in the previous chapter has an equivalent <code>quo()</code> function that creates a quosure:</p>
<ul>
<li><p>Use <code>quo()</code> and <code>quos()</code> to capture your expressions.</p>
<div class="sourceCode" id="cb826"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb826-1" data-line-number="1"><span class="kw">quo</span>(x <span class="op">+</span><span class="st"> </span>y <span class="op">+</span><span class="st"> </span>z)</a>
<a class="sourceLine" id="cb826-2" data-line-number="2"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb826-3" data-line-number="3"><span class="co">#&gt;   expr: ^x + y + z</span></a>
<a class="sourceLine" id="cb826-4" data-line-number="4"><span class="co">#&gt;   env:  global</span></a>
<a class="sourceLine" id="cb826-5" data-line-number="5"><span class="kw">quos</span>(x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, y <span class="op">+</span><span class="st"> </span><span class="dv">2</span>)</a>
<a class="sourceLine" id="cb826-6" data-line-number="6"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb826-7" data-line-number="7"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb826-8" data-line-number="8"><span class="co">#&gt;   expr: ^x + 1</span></a>
<a class="sourceLine" id="cb826-9" data-line-number="9"><span class="co">#&gt;   env:  global</span></a>
<a class="sourceLine" id="cb826-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb826-11" data-line-number="11"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb826-12" data-line-number="12"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb826-13" data-line-number="13"><span class="co">#&gt;   expr: ^y + 2</span></a>
<a class="sourceLine" id="cb826-14" data-line-number="14"><span class="co">#&gt;   env:  global</span></a></code></pre></div></li>
<li><p>Use <code>enquo()</code> and <code>enquos()</code> to capture user-supplied expressions.</p>
<div class="sourceCode" id="cb827"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb827-1" data-line-number="1">foo &lt;-<span class="st"> </span><span class="cf">function</span>(x) <span class="kw">enquo</span>(x)</a>
<a class="sourceLine" id="cb827-2" data-line-number="2"><span class="kw">foo</span>(a <span class="op">+</span><span class="st"> </span>b)</a>
<a class="sourceLine" id="cb827-3" data-line-number="3"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb827-4" data-line-number="4"><span class="co">#&gt;   expr: ^a + b</span></a>
<a class="sourceLine" id="cb827-5" data-line-number="5"><span class="co">#&gt;   env:  global</span></a></code></pre></div></li>
</ul>
<p>Note how quosures are printed: each quosure starts with <code>^</code>. This is a signal that you’re looking at something special, and is useful if you unquote a quosure inside another quosure. In the console, each quosure gets a different colour to help remind you that it has a different environment attached to it.</p>
<div class="sourceCode" id="cb828"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb828-1" data-line-number="1">q2 &lt;-<span class="st"> </span><span class="kw">quo</span>(x <span class="op">+</span><span class="st"> </span><span class="op">!!</span>x)</a>
<a class="sourceLine" id="cb828-2" data-line-number="2">q2</a>
<a class="sourceLine" id="cb828-3" data-line-number="3"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb828-4" data-line-number="4"><span class="co">#&gt;   expr: ^x + 0</span></a>
<a class="sourceLine" id="cb828-5" data-line-number="5"><span class="co">#&gt;   env:  global</span></a></code></pre></div>
<p>Finally, you can use <code>new_quosure()</code> to create a quosure from its components: an expression and an environment.</p>
<div class="sourceCode" id="cb829"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb829-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">new_quosure</span>(<span class="kw">expr</span>(x <span class="op">+</span><span class="st"> </span>y), <span class="kw">env</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb829-2" data-line-number="2">x</a>
<a class="sourceLine" id="cb829-3" data-line-number="3"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb829-4" data-line-number="4"><span class="co">#&gt;   expr: ^x + y</span></a>
<a class="sourceLine" id="cb829-5" data-line-number="5"><span class="co">#&gt;   env:  0x7fc58eac0410</span></a></code></pre></div>
<p>If you need to turn a quosure into text for output to the console you can use <code>quo_name()</code>, <code>quo_label()</code>, or <code>quo_text()</code>. <code>quo_name()</code> and <code>quo_label()</code> are guaranteed to be short; <code>quo_expr()</code> may span multiple lines.</p>
<div class="sourceCode" id="cb830"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb830-1" data-line-number="1">y &lt;-<span class="st"> </span><span class="kw">quo</span>(<span class="kw">long_function_name</span>(</a>
<a class="sourceLine" id="cb830-2" data-line-number="2">  <span class="dt">argument_1 =</span> long_argument_value,</a>
<a class="sourceLine" id="cb830-3" data-line-number="3">  <span class="dt">argument_2 =</span> long_argument_value,</a>
<a class="sourceLine" id="cb830-4" data-line-number="4">  <span class="dt">argument_3 =</span> long_argument_value,</a>
<a class="sourceLine" id="cb830-5" data-line-number="5">  <span class="dt">argument_4 =</span> long_argument_value</a>
<a class="sourceLine" id="cb830-6" data-line-number="6">))</a>
<a class="sourceLine" id="cb830-7" data-line-number="7"><span class="kw">quo_name</span>(y)   <span class="co"># e.g. for data frames</span></a>
<a class="sourceLine" id="cb830-8" data-line-number="8"><span class="co">#&gt; [1] &quot;long_function_name(...)&quot;</span></a>
<a class="sourceLine" id="cb830-9" data-line-number="9"><span class="kw">quo_label</span>(y)  <span class="co"># e.g. for error messages</span></a>
<a class="sourceLine" id="cb830-10" data-line-number="10"><span class="co">#&gt; [1] &quot;`long_function_name(...)`&quot;</span></a>
<a class="sourceLine" id="cb830-11" data-line-number="11"><span class="kw">quo_text</span>(y)   <span class="co"># for longer messages</span></a>
<a class="sourceLine" id="cb830-12" data-line-number="12"><span class="co">#&gt; [1] &quot;long_function_name(argument_1 = long_argument_value, argument_2 = long_argument_value, \n    argument_3 = long_argument_value, argument_4 = long_argument_value)&quot;</span></a></code></pre></div>
</div>
<div id="evaluating" class="section level3">
<h3><span class="header-section-number">20.3.3</span> Evaluating</h3>
<p>You can evaluate a quosure with <code>eval_tidy()</code>:</p>
<div class="sourceCode" id="cb831"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb831-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="kw">new_quosure</span>(<span class="kw">expr</span>(x <span class="op">+</span><span class="st"> </span>y), <span class="kw">env</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb831-2" data-line-number="2"><span class="kw">eval_tidy</span>(x)</a>
<a class="sourceLine" id="cb831-3" data-line-number="3"><span class="co">#&gt; [1] 11</span></a></code></pre></div>
<p>And you can extract its components with the <code>quo_get_</code> helpers:</p>
<div class="sourceCode" id="cb832"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb832-1" data-line-number="1"><span class="kw">quo_get_env</span>(x)</a>
<a class="sourceLine" id="cb832-2" data-line-number="2"><span class="co">#&gt; &lt;environment: 0x7fc58ef0cdf0&gt;</span></a>
<a class="sourceLine" id="cb832-3" data-line-number="3"><span class="kw">quo_get_expr</span>(x)</a>
<a class="sourceLine" id="cb832-4" data-line-number="4"><span class="co">#&gt; x + y</span></a></code></pre></div>
<p>For this simple case, <code>eval_tidy()</code> is basically a wrapper around <code>eval_bare()</code>. In the next section, you’ll learn about the <code>data</code> argument which makes <code>eval_tidy()</code> particularly powerful.</p>
<div class="sourceCode" id="cb833"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb833-1" data-line-number="1"><span class="kw">eval_bare</span>(<span class="kw">quo_get_expr</span>(x), <span class="kw">quo_get_env</span>(x))</a>
<a class="sourceLine" id="cb833-2" data-line-number="2"><span class="co">#&gt; [1] 11</span></a></code></pre></div>
</div>
<div id="implementation" class="section level3">
<h3><span class="header-section-number">20.3.4</span> Implementation</h3>
<p></p>
<p>Quosures rely on R’s internal representation of function arguments as a special type of object called a <strong>promise</strong>. A promise captures the expression needed to compute the value and the environment in which to compute it. You’re not normally aware of promises because the first time you access a promise its code is evaluated in its environment, yielding a value. This is what powers lazy evaluation. You cannot manipulate promises with R code. Promises are like a quantum state: any attempt to inspect them with R code will force an immediate evaluation, making the promise disappear. To work around this, rlang manipulates promises with C code, reifying them into an R object that you can work with.</p>
<p>There is one big difference between promises and quosures. A promise is evaluated once, when you access it for the first time. Every time you access it subsequently it will return the same value. A quosure must be evaluated explicitly, and each evaluation is independent of the previous evaluations.</p>
<div class="sourceCode" id="cb834"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb834-1" data-line-number="1"><span class="co"># The argument x is evaluated once, then reused</span></a>
<a class="sourceLine" id="cb834-2" data-line-number="2">foo &lt;-<span class="st"> </span><span class="cf">function</span>(x_arg) {</a>
<a class="sourceLine" id="cb834-3" data-line-number="3">  <span class="kw">list</span>(x_arg, x_arg)</a>
<a class="sourceLine" id="cb834-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb834-5" data-line-number="5"><span class="kw">foo</span>(<span class="kw">runif</span>(<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb834-6" data-line-number="6"><span class="co">#&gt; [[1]]</span></a>
<a class="sourceLine" id="cb834-7" data-line-number="7"><span class="co">#&gt; [1] 0.0808 0.8343 0.6008</span></a>
<a class="sourceLine" id="cb834-8" data-line-number="8"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb834-9" data-line-number="9"><span class="co">#&gt; [[2]]</span></a>
<a class="sourceLine" id="cb834-10" data-line-number="10"><span class="co">#&gt; [1] 0.0808 0.8343 0.6008</span></a>
<a class="sourceLine" id="cb834-11" data-line-number="11"></a>
<a class="sourceLine" id="cb834-12" data-line-number="12"><span class="co"># The quosure x is evaluated afresh each time</span></a>
<a class="sourceLine" id="cb834-13" data-line-number="13">x_quo &lt;-<span class="st"> </span><span class="kw">quo</span>(<span class="kw">runif</span>(<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb834-14" data-line-number="14"><span class="kw">eval_tidy</span>(x_quo)</a>
<a class="sourceLine" id="cb834-15" data-line-number="15"><span class="co">#&gt; [1] 0.1572 0.0074 0.4664</span></a>
<a class="sourceLine" id="cb834-16" data-line-number="16"><span class="kw">eval_tidy</span>(x_quo)</a>
<a class="sourceLine" id="cb834-17" data-line-number="17"><span class="co">#&gt; [1] 0.498 0.290 0.733</span></a></code></pre></div>
<p>Quosures are inspired by R’s formulas, <code>~</code>, which, like quosures, capture both the expression and its environment:</p>
<div class="sourceCode" id="cb835"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb835-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="er">~</span><span class="kw">runif</span>(<span class="dv">3</span>)</a>
<a class="sourceLine" id="cb835-2" data-line-number="2">f</a>
<a class="sourceLine" id="cb835-3" data-line-number="3"><span class="co">#&gt; ~runif(3)</span></a>
<a class="sourceLine" id="cb835-4" data-line-number="4"></a>
<a class="sourceLine" id="cb835-5" data-line-number="5"><span class="kw">str</span>(f)</a>
<a class="sourceLine" id="cb835-6" data-line-number="6"><span class="co">#&gt; Class &#39;formula&#39;  language ~runif(3)</span></a>
<a class="sourceLine" id="cb835-7" data-line-number="7"><span class="co">#&gt;   ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt;</span></a></code></pre></div>
<p>Initial versions of rlang used formulas instead of quosures, as an attractive feature of <code>~</code> is that it provides quoting with a single keystroke. Unfortunately, however, there is no way to add quasiquotation to <code>~</code>, so we decided to use a new function, <code>quo()</code>, instead.</p>
</div>
<div id="when-not-to-use-quosures" class="section level3">
<h3><span class="header-section-number">20.3.5</span> When not to use quosures</h3>
<p>Almost all quoting functions should capture quosures rather than expressions, and you should default to using <code>enquo()</code> and <code>enquos()</code> to capture arguments from the user. You should only use expressions if you have explicitly decided that the environment is not important. This tends to happen in three main cases:</p>
<ul>
<li><p>In code generation, such as you saw in <a href="quasiquotation.html#slicing-an-array">Slicing an array</a>.</p></li>
<li><p>When you are wrapping a NSE function that doesn’t use quosures.
We’ll disucss this in detail in the case study at the end of the chapter.</p></li>
<li><p>When you have carefully created a self-contained expression using
unquoting. For example, instead of this quosure:</p>
<div class="sourceCode" id="cb836"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb836-1" data-line-number="1">base &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb836-2" data-line-number="2"><span class="kw">quo</span>(<span class="kw">log</span>(x, <span class="dt">base =</span> base))</a>
<a class="sourceLine" id="cb836-3" data-line-number="3"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb836-4" data-line-number="4"><span class="co">#&gt;   expr: ^log(x, base = base)</span></a>
<a class="sourceLine" id="cb836-5" data-line-number="5"><span class="co">#&gt;   env:  global</span></a></code></pre></div>
<p>You could create this self-contained expression:</p>
<div class="sourceCode" id="cb837"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb837-1" data-line-number="1"><span class="kw">expr</span>(<span class="kw">log</span>(x, <span class="dt">base =</span> <span class="op">!!</span>base))</a>
<a class="sourceLine" id="cb837-2" data-line-number="2"><span class="co">#&gt; log(x, base = 2)</span></a></code></pre></div>
<p>(Assuming that <code>x</code> will be supplied in some other way)</p></li>
</ul>
</div>
<div id="exercises-63" class="section level3">
<h3><span class="header-section-number">20.3.6</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>Predict what evaluating each of the following quosures will return.</p>
<div class="sourceCode" id="cb838"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb838-1" data-line-number="1">q1 &lt;-<span class="st"> </span><span class="kw">new_quosure</span>(<span class="kw">expr</span>(x), <span class="kw">env</span>(<span class="dt">x =</span> <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb838-2" data-line-number="2">q1</a>
<a class="sourceLine" id="cb838-3" data-line-number="3"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb838-4" data-line-number="4"><span class="co">#&gt;   expr: ^x</span></a>
<a class="sourceLine" id="cb838-5" data-line-number="5"><span class="co">#&gt;   env:  0x7fc588fba470</span></a>
<a class="sourceLine" id="cb838-6" data-line-number="6"></a>
<a class="sourceLine" id="cb838-7" data-line-number="7">q2 &lt;-<span class="st"> </span><span class="kw">new_quosure</span>(<span class="kw">expr</span>(x <span class="op">+</span><span class="st"> </span><span class="op">!!</span>q1), <span class="kw">env</span>(<span class="dt">x =</span> <span class="dv">10</span>))</a>
<a class="sourceLine" id="cb838-8" data-line-number="8">q2</a>
<a class="sourceLine" id="cb838-9" data-line-number="9"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb838-10" data-line-number="10"><span class="co">#&gt;   expr: ^x + (^x)</span></a>
<a class="sourceLine" id="cb838-11" data-line-number="11"><span class="co">#&gt;   env:  0x7fc588e18050</span></a>
<a class="sourceLine" id="cb838-12" data-line-number="12"></a>
<a class="sourceLine" id="cb838-13" data-line-number="13">q3 &lt;-<span class="st"> </span><span class="kw">new_quosure</span>(<span class="kw">expr</span>(x <span class="op">+</span><span class="st"> </span><span class="op">!!</span>q2), <span class="kw">env</span>(<span class="dt">x =</span> <span class="dv">100</span>))</a>
<a class="sourceLine" id="cb838-14" data-line-number="14">q3</a>
<a class="sourceLine" id="cb838-15" data-line-number="15"><span class="co">#&gt; &lt;quosure&gt;</span></a>
<a class="sourceLine" id="cb838-16" data-line-number="16"><span class="co">#&gt;   expr: ^x + (^x + (^x))</span></a>
<a class="sourceLine" id="cb838-17" data-line-number="17"><span class="co">#&gt;   env:  0x7fc58d246dc8</span></a></code></pre></div></li>
<li><p>Write a function <code>enenv()</code> that captures the environment associated
with an argument.</p></li>
</ol>
</div>
</div>
<div id="tidy-evaluation" class="section level2">
<h2><span class="header-section-number">20.4</span> Tidy evaluation</h2>
<p>In the previous section, you learned how to capture quosures, why they are important, and the basics of <code>eval_tidy()</code>. In this section, we’ll go deep on <code>eval_tidy()</code> and talk more generally about the ideas of <strong>tidy evaluation</strong>. There are two big new concepts:</p>
<ul>
<li><p>A <strong>data mask</strong> is a data frame where the evaluated code will look first for
variable definitions.</p></li>
<li><p>A data mask introduces ambiguity, so to remove that ambiguity when necessary
we introduce <strong>pronouns</strong>.</p></li>
</ul>
<p>We’ll explore tidy evaluation in the context of <code>base::subset()</code>, because it’s a simple yet powerful function that encapsulates one of the central ideas that makes R so elegant for data analysis. Once we’ve seen the tidy implementation, we’ll return to the base R implementation, learn how it works, and explore the limitations that make <code>subset()</code> suitable only for interactive usage.</p>
<div id="data-masks" class="section level3">
<h3><span class="header-section-number">20.4.1</span> Data masks</h3>
<p>In the previous section, you learned that <code>eval_tidy()</code> is basically a wrapper around <code>eval_bare()</code> when evaluating a quosure. The real power of <code>eval_tidy()</code> comes with the second argument: <code>data</code>.<a href="#fn43" class="footnote-ref" id="fnref43"><sup>43</sup></a> This lets you set up a <strong>data mask</strong>, where variables in the environment are potentially masked by variables in a data frame. This allows you to mingle variables from the environment and variables from a data frame:</p>
<div class="sourceCode" id="cb839"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb839-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb839-2" data-line-number="2">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">y =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>)</a>
<a class="sourceLine" id="cb839-3" data-line-number="3">q1 &lt;-<span class="st"> </span><span class="kw">quo</span>(x <span class="op">*</span><span class="st"> </span>y)</a>
<a class="sourceLine" id="cb839-4" data-line-number="4"></a>
<a class="sourceLine" id="cb839-5" data-line-number="5"><span class="kw">eval_tidy</span>(q1, df)</a>
<a class="sourceLine" id="cb839-6" data-line-number="6"><span class="co">#&gt;  [1]  10  20  30  40  50  60  70  80  90 100</span></a></code></pre></div>
<p>The data mask is the key idea that powers base functions like <code>with()</code>, <code>subset()</code> and <code>transform()</code>, and that is used throughout tidyverse, in packages like dplyr.</p>
<p>How does this work? Unlike environments, data frames don’t have parents, so we can effectively turn it into an environment using the environment of the quosure as its parent. The above code is basically equivalent to:</p>
<div class="sourceCode" id="cb840"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb840-1" data-line-number="1">df_env &lt;-<span class="st"> </span><span class="kw">as_environment</span>(df, <span class="dt">parent =</span> <span class="kw">quo_get_env</span>(q1))</a>
<a class="sourceLine" id="cb840-2" data-line-number="2">q2 &lt;-<span class="st"> </span><span class="kw">quo_set_env</span>(q1, df_env)</a>
<a class="sourceLine" id="cb840-3" data-line-number="3"></a>
<a class="sourceLine" id="cb840-4" data-line-number="4"><span class="kw">eval_tidy</span>(q2)</a>
<a class="sourceLine" id="cb840-5" data-line-number="5"><span class="co">#&gt;  [1]  10  20  30  40  50  60  70  80  90 100</span></a></code></pre></div>
<p><code>base::eval()</code> has similar functionality. If the 2nd argument is a data frame it becomes a data mask, and you provide the environment in the 3rd argument:</p>
<div class="sourceCode" id="cb841"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb841-1" data-line-number="1"><span class="kw">eval</span>(<span class="kw">quo_get_expr</span>(q1), df, <span class="kw">quo_get_env</span>(q1))</a>
<a class="sourceLine" id="cb841-2" data-line-number="2"><span class="co">#&gt;  [1]  10  20  30  40  50  60  70  80  90 100</span></a></code></pre></div>
</div>
<div id="subset" class="section level3">
<h3><span class="header-section-number">20.4.2</span> Application: <code>subset()</code></h3>
<p>To see why the data mask is so useful, lets implement our own version of <code>subset()</code>. If you haven’t used it before, <code>subset()</code> (like <code>dplyr::filter()</code>), provides a convenient way of selecting rows of a data frame using an expression that is evaluated in the context of the data frame. It allows you to subset without repeatedly referring to the name of the data frame:</p>
<div class="sourceCode" id="cb842"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb842-1" data-line-number="1">sample_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">a =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">5</span>, <span class="dt">b =</span> <span class="dv">5</span><span class="op">:</span><span class="dv">1</span>, <span class="dt">c =</span> <span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">4</span>, <span class="dv">1</span>))</a>
<a class="sourceLine" id="cb842-2" data-line-number="2"></a>
<a class="sourceLine" id="cb842-3" data-line-number="3"><span class="co"># Shorthand for sample_df[sample_df$a &gt;= 4, ]</span></a>
<a class="sourceLine" id="cb842-4" data-line-number="4"><span class="kw">subset</span>(sample_df, a <span class="op">&gt;=</span><span class="st"> </span><span class="dv">4</span>)</a>
<a class="sourceLine" id="cb842-5" data-line-number="5"><span class="co">#&gt;   a b c</span></a>
<a class="sourceLine" id="cb842-6" data-line-number="6"><span class="co">#&gt; 4 4 2 4</span></a>
<a class="sourceLine" id="cb842-7" data-line-number="7"><span class="co">#&gt; 5 5 1 1</span></a>
<a class="sourceLine" id="cb842-8" data-line-number="8"></a>
<a class="sourceLine" id="cb842-9" data-line-number="9"><span class="co"># Shorthand for sample_df[sample_df$b == sample_df$c, ]</span></a>
<a class="sourceLine" id="cb842-10" data-line-number="10"><span class="kw">subset</span>(sample_df, b <span class="op">==</span><span class="st"> </span>c)</a>
<a class="sourceLine" id="cb842-11" data-line-number="11"><span class="co">#&gt;   a b c</span></a>
<a class="sourceLine" id="cb842-12" data-line-number="12"><span class="co">#&gt; 1 1 5 5</span></a>
<a class="sourceLine" id="cb842-13" data-line-number="13"><span class="co">#&gt; 5 5 1 1</span></a></code></pre></div>
<p>The core of our version of <code>subset()</code>, <code>subset2()</code>, is quite simple. It takes two arguments: a data frame, <code>df</code>, and an expression, <code>rows</code>. We evaluate <code>rows</code> using <code>df</code> as a data mask, then use the results to subset the data frame with <code>[</code>. I’ve included a very simple check to ensure the result is a logical vector; real code should do more work to create an informative error.</p>
<div class="sourceCode" id="cb843"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb843-1" data-line-number="1">subset2 &lt;-<span class="st"> </span><span class="cf">function</span>(df, rows) {</a>
<a class="sourceLine" id="cb843-2" data-line-number="2">  rows &lt;-<span class="st"> </span><span class="kw">enquo</span>(rows)</a>
<a class="sourceLine" id="cb843-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb843-4" data-line-number="4">  rows_val &lt;-<span class="st"> </span><span class="kw">eval_tidy</span>(rows, df)</a>
<a class="sourceLine" id="cb843-5" data-line-number="5">  <span class="kw">stopifnot</span>(<span class="kw">is.logical</span>(rows_val))</a>
<a class="sourceLine" id="cb843-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb843-7" data-line-number="7">  df[rows_val, , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb843-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb843-9" data-line-number="9"></a>
<a class="sourceLine" id="cb843-10" data-line-number="10"><span class="kw">subset2</span>(sample_df, b <span class="op">==</span><span class="st"> </span>c)</a>
<a class="sourceLine" id="cb843-11" data-line-number="11"><span class="co">#&gt;   a b c</span></a>
<a class="sourceLine" id="cb843-12" data-line-number="12"><span class="co">#&gt; 1 1 5 5</span></a>
<a class="sourceLine" id="cb843-13" data-line-number="13"><span class="co">#&gt; 5 5 1 1</span></a></code></pre></div>
</div>
<div id="application-arrange" class="section level3">
<h3><span class="header-section-number">20.4.3</span> Application: <code>arrange()</code></h3>
<p>A slightly more complicated exercise is to implement the heart of <code>dplyr::arrange()</code>. The goal of <code>arrange()</code> is to allow you to sort a data frame by multiple variables, each evaluated in the context of the data frame. This is more challenging than <code>subset()</code> because we want to arrange by multiple variables captured in <code>...</code>.</p>
<div class="sourceCode" id="cb844"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb844-1" data-line-number="1">arrange2 &lt;-<span class="st"> </span><span class="cf">function</span>(.df, ..., <span class="dt">.na.last =</span> <span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb844-2" data-line-number="2">  <span class="co"># Capture all dots</span></a>
<a class="sourceLine" id="cb844-3" data-line-number="3">  args &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)</a>
<a class="sourceLine" id="cb844-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb844-5" data-line-number="5">  <span class="co"># Create a call to order, using `!!!` to splice in the </span></a>
<a class="sourceLine" id="cb844-6" data-line-number="6">  <span class="co"># individual expressions, and `!!` to splice in na.last</span></a>
<a class="sourceLine" id="cb844-7" data-line-number="7">  order_call &lt;-<span class="st"> </span><span class="kw">quo</span>(<span class="kw">order</span>(<span class="op">!!!</span>args, <span class="dt">na.last =</span> <span class="op">!!</span>.na.last))</a>
<a class="sourceLine" id="cb844-8" data-line-number="8">  </a>
<a class="sourceLine" id="cb844-9" data-line-number="9">  <span class="co"># Evaluate the call to order with </span></a>
<a class="sourceLine" id="cb844-10" data-line-number="10">  ord &lt;-<span class="st"> </span><span class="kw">eval_tidy</span>(order_call, .df)</a>
<a class="sourceLine" id="cb844-11" data-line-number="11">  </a>
<a class="sourceLine" id="cb844-12" data-line-number="12">  .df[ord, , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb844-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb844-14" data-line-number="14"></a>
<a class="sourceLine" id="cb844-15" data-line-number="15">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>), <span class="dt">y =</span> <span class="kw">runif</span>(<span class="dv">3</span>))</a>
<a class="sourceLine" id="cb844-16" data-line-number="16"></a>
<a class="sourceLine" id="cb844-17" data-line-number="17"><span class="kw">arrange2</span>(df, x)</a>
<a class="sourceLine" id="cb844-18" data-line-number="18"><span class="co">#&gt;   x     y</span></a>
<a class="sourceLine" id="cb844-19" data-line-number="19"><span class="co">#&gt; 3 1 0.175</span></a>
<a class="sourceLine" id="cb844-20" data-line-number="20"><span class="co">#&gt; 1 2 0.773</span></a>
<a class="sourceLine" id="cb844-21" data-line-number="21"><span class="co">#&gt; 2 3 0.875</span></a>
<a class="sourceLine" id="cb844-22" data-line-number="22"><span class="kw">arrange2</span>(df, <span class="op">-</span>y)</a>
<a class="sourceLine" id="cb844-23" data-line-number="23"><span class="co">#&gt;   x     y</span></a>
<a class="sourceLine" id="cb844-24" data-line-number="24"><span class="co">#&gt; 2 3 0.875</span></a>
<a class="sourceLine" id="cb844-25" data-line-number="25"><span class="co">#&gt; 1 2 0.773</span></a>
<a class="sourceLine" id="cb844-26" data-line-number="26"><span class="co">#&gt; 3 1 0.175</span></a></code></pre></div>
</div>
<div id="ambiguity-and-pronouns" class="section level3">
<h3><span class="header-section-number">20.4.4</span> Ambiguity and pronouns</h3>
<p>One of the downsides of the data mask is that it introduces ambiguity: when you say <code>x</code>, are you refering to a variable in the data or in the environment? This ambiguity is ok when doing interactive data analysis because you are familiar with the data, and if there are problems, you’ll spot them quickly because you are looking at the data frequently. However, ambiguity becomes a problem when you start programming with functions that use tidy evaluation. For example, take this simple wrapper:</p>
<div class="sourceCode" id="cb845"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb845-1" data-line-number="1">threshold_x &lt;-<span class="st"> </span><span class="cf">function</span>(df, val) {</a>
<a class="sourceLine" id="cb845-2" data-line-number="2">  <span class="kw">subset2</span>(df, x <span class="op">&gt;=</span><span class="st"> </span>val)</a>
<a class="sourceLine" id="cb845-3" data-line-number="3">}</a></code></pre></div>
<p>This function can silently return an incorrect result in two situations:</p>
<ul>
<li><p>If <code>df</code> does not contain a variable called <code>x</code> and <code>x</code> exists in the
calling environment, <code>threshold_x()</code> will silently return an incorrect
result:</p>
<div class="sourceCode" id="cb846"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb846-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb846-2" data-line-number="2">no_x &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">y =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb846-3" data-line-number="3"><span class="kw">threshold_x</span>(no_x, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb846-4" data-line-number="4"><span class="co">#&gt;   y</span></a>
<a class="sourceLine" id="cb846-5" data-line-number="5"><span class="co">#&gt; 1 1</span></a>
<a class="sourceLine" id="cb846-6" data-line-number="6"><span class="co">#&gt; 2 2</span></a>
<a class="sourceLine" id="cb846-7" data-line-number="7"><span class="co">#&gt; 3 3</span></a></code></pre></div></li>
<li><p>If <code>df</code> contains a variable called <code>val</code>, the function will always return
an incorrect answer:</p>
<div class="sourceCode" id="cb847"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb847-1" data-line-number="1">has_val &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">val =</span> <span class="dv">9</span><span class="op">:</span><span class="dv">11</span>)</a>
<a class="sourceLine" id="cb847-2" data-line-number="2"><span class="kw">threshold_x</span>(has_val, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb847-3" data-line-number="3"><span class="co">#&gt; [1] x   val</span></a>
<a class="sourceLine" id="cb847-4" data-line-number="4"><span class="co">#&gt; &lt;0 rows&gt; (or 0-length row.names)</span></a></code></pre></div></li>
</ul>
<p>These failure modes arise because tidy evaluation is ambiguous: each variable can be found in <strong>either</strong> the data mask <strong>or</strong> the environment. To make this function work we need to remove that ambiguity and ensure that <code>x</code> is always found in the data and <code>val</code> in the environment. To make this possible <code>eval_tidy()</code> provides <code>.data</code> and <code>.env</code> pronouns:</p>
<div class="sourceCode" id="cb848"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb848-1" data-line-number="1">threshold_x &lt;-<span class="st"> </span><span class="cf">function</span>(df, val) {</a>
<a class="sourceLine" id="cb848-2" data-line-number="2">  <span class="kw">subset2</span>(df, .data<span class="op">$</span>x <span class="op">&gt;=</span><span class="st"> </span>.env<span class="op">$</span>val)</a>
<a class="sourceLine" id="cb848-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb848-4" data-line-number="4"></a>
<a class="sourceLine" id="cb848-5" data-line-number="5">x &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb848-6" data-line-number="6"><span class="kw">threshold_x</span>(no_x, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb848-7" data-line-number="7"><span class="co">#&gt; Error: Column `x` not found in `.data`</span></a>
<a class="sourceLine" id="cb848-8" data-line-number="8"><span class="kw">threshold_x</span>(has_val, <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb848-9" data-line-number="9"><span class="co">#&gt;   x val</span></a>
<a class="sourceLine" id="cb848-10" data-line-number="10"><span class="co">#&gt; 2 2  10</span></a>
<a class="sourceLine" id="cb848-11" data-line-number="11"><span class="co">#&gt; 3 3  11</span></a></code></pre></div>
<p>(NB: unlike indexing an ordinary list or environment with <code>$</code>, these pronouns will throw an error if the variable is not found)</p>
<p>Generally, whenever you use the <code>.env</code> pronoun, you can use unquoting instead:</p>
<div class="sourceCode" id="cb849"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb849-1" data-line-number="1">threshold_x &lt;-<span class="st"> </span><span class="cf">function</span>(df, val) {</a>
<a class="sourceLine" id="cb849-2" data-line-number="2">  <span class="kw">subset2</span>(df, .data<span class="op">$</span>x <span class="op">&gt;=</span><span class="st"> </span><span class="op">!!</span>val)</a>
<a class="sourceLine" id="cb849-3" data-line-number="3">}</a></code></pre></div>
<p>There are subtle differences in when <code>val</code> is evaluated. If you unquote, <code>val</code> will be evaluated by <code>enquo()</code>; if you use a pronoun, <code>val</code> will be evaluated by <code>eval_tidy()</code>. These differences are usually unimportant, so pick the form that looks most natural.</p>
<p>What if we generalise <code>threshold_x()</code> slightly so that the user can pick the variable used for thresholding. There are two basic approaches. Both start by capturing a <em>symbol</em>:</p>
<div class="sourceCode" id="cb850"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb850-1" data-line-number="1">threshold_var1 &lt;-<span class="st"> </span><span class="cf">function</span>(df, var, val) {</a>
<a class="sourceLine" id="cb850-2" data-line-number="2">  var &lt;-<span class="st"> </span><span class="kw">ensym</span>(var)</a>
<a class="sourceLine" id="cb850-3" data-line-number="3">  <span class="kw">subset2</span>(df, <span class="st">`</span><span class="dt">$</span><span class="st">`</span>(.data, <span class="op">!!</span>var) <span class="op">&gt;=</span><span class="st"> </span><span class="op">!!</span>val)</a>
<a class="sourceLine" id="cb850-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb850-5" data-line-number="5"></a>
<a class="sourceLine" id="cb850-6" data-line-number="6">threshold_var2 &lt;-<span class="st"> </span><span class="cf">function</span>(df, var, val) {</a>
<a class="sourceLine" id="cb850-7" data-line-number="7">  var &lt;-<span class="st"> </span><span class="kw">as.character</span>(<span class="kw">ensym</span>(var))</a>
<a class="sourceLine" id="cb850-8" data-line-number="8">  <span class="kw">subset2</span>(df, .data[[var]] <span class="op">&gt;=</span><span class="st"> </span><span class="op">!!</span>val)</a>
<a class="sourceLine" id="cb850-9" data-line-number="9">}</a></code></pre></div>
<p>In <code>threshold_var1</code> we need to use the prefix form of <code>$</code>, because <code>.data$!!var</code> is not valid R syntax. Alternatively, we can convert the symbol to a string, and use <code>[[</code>.</p>
<p>Note that it is not always the responsibility of the function author to avoid ambiguity. Imagine we generalise further to allow thresholding based on any expression:</p>
<div class="sourceCode" id="cb851"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb851-1" data-line-number="1">threshold_expr &lt;-<span class="st"> </span><span class="cf">function</span>(df, expr, val) {</a>
<a class="sourceLine" id="cb851-2" data-line-number="2">  expr &lt;-<span class="st"> </span><span class="kw">enquo</span>(expr)</a>
<a class="sourceLine" id="cb851-3" data-line-number="3">  <span class="kw">subset2</span>(df, <span class="op">!!</span>expr <span class="op">&gt;=</span><span class="st"> </span><span class="op">!!</span>val)</a>
<a class="sourceLine" id="cb851-4" data-line-number="4">}</a></code></pre></div>
<p>There’s no way to ensure that <code>expr</code> is only evaluated in the data, and even if you could, you wouldn’t want to because the data does not include any functions. For this function, it’s the user’s responsibility to avoid ambiguity. As a function author it’s your responsibility to avoid ambiguity with any expressions that you create; it’s the users responsibility to avoid ambiguity in expressions that they create.</p>
<p>Now that you’ve seen data masks and pronouns in action, we’ll return to <code>base::subset()</code> to learn about its limitations.</p>
</div>
<div id="base-subset" class="section level3">
<h3><span class="header-section-number">20.4.5</span> Base <code>subset()</code></h3>
<p>The documentation of <code>subset()</code> includes the following warning:</p>
<blockquote>
<p>This is a convenience function intended for use interactively. For
programming it is better to use the standard subsetting functions like <code>[</code>,
and in particular the non-standard evaluation of argument <code>subset</code> can have
unanticipated consequences.</p>
</blockquote>
<p>Why is <code>subset()</code> dangerous for programming and how does tidy evaluation help us avoid those dangers? First, lets implement the key parts of <code>subset()</code> using base R, following the same structure as <code>subset2()</code>. We convert <code>enquo()</code> to <code>substitute()</code> and <code>eval_tidy()</code> to <code>eval()</code>. We also need to supply a backup environment to <code>eval()</code>. There’s no way to access the environment associated with an argument in base R, so we take the best approximation: the caller environment (aka parent frame).</p>
<div class="sourceCode" id="cb852"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb852-1" data-line-number="1">subset_base &lt;-<span class="st"> </span><span class="cf">function</span>(data, rows) {</a>
<a class="sourceLine" id="cb852-2" data-line-number="2">  rows &lt;-<span class="st"> </span><span class="kw">substitute</span>(rows)</a>
<a class="sourceLine" id="cb852-3" data-line-number="3">  </a>
<a class="sourceLine" id="cb852-4" data-line-number="4">  rows_val &lt;-<span class="st"> </span><span class="kw">eval</span>(rows, data, <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb852-5" data-line-number="5">  <span class="kw">stopifnot</span>(<span class="kw">is.logical</span>(rows_val))</a>
<a class="sourceLine" id="cb852-6" data-line-number="6">  </a>
<a class="sourceLine" id="cb852-7" data-line-number="7">  data[rows_val, , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb852-8" data-line-number="8">}</a></code></pre></div>
<p>There are three problems with this implementation:</p>
<ul>
<li><p><code>subset()</code> doesn’t support unquoting, so wrapping the function is hard.
First, you use <code>substitute()</code> to capture the complete expression, then
you evaluate it. Because <code>substitute()</code> doesn’t use a syntactic marker for
unquoting, it is hard to see exactly what’s happening here.</p>
<div class="sourceCode" id="cb853"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb853-1" data-line-number="1">f1a &lt;-<span class="st"> </span><span class="cf">function</span>(df, expr) {</a>
<a class="sourceLine" id="cb853-2" data-line-number="2">  call &lt;-<span class="st"> </span><span class="kw">substitute</span>(<span class="kw">subset</span>(df, expr))</a>
<a class="sourceLine" id="cb853-3" data-line-number="3">  <span class="kw">eval</span>(call, <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb853-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb853-5" data-line-number="5"></a>
<a class="sourceLine" id="cb853-6" data-line-number="6">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">y =</span> <span class="dv">3</span><span class="op">:</span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb853-7" data-line-number="7"><span class="kw">f1a</span>(df, x <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb853-8" data-line-number="8"><span class="co">#&gt;   x y</span></a>
<a class="sourceLine" id="cb853-9" data-line-number="9"><span class="co">#&gt; 1 1 3</span></a></code></pre></div>
<p>I think the tidy evaluation equivalent is easier to understand because the
quoting and unquoting is explicit:</p>
<div class="sourceCode" id="cb854"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb854-1" data-line-number="1">f1b &lt;-<span class="st"> </span><span class="cf">function</span>(df, expr) {</a>
<a class="sourceLine" id="cb854-2" data-line-number="2">  expr &lt;-<span class="st"> </span><span class="kw">enquo</span>(expr)</a>
<a class="sourceLine" id="cb854-3" data-line-number="3">  <span class="kw">subset2</span>(df, <span class="op">!!</span>expr)</a>
<a class="sourceLine" id="cb854-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb854-5" data-line-number="5"><span class="kw">f1b</span>(df, x <span class="op">==</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb854-6" data-line-number="6"><span class="co">#&gt;   x y</span></a>
<a class="sourceLine" id="cb854-7" data-line-number="7"><span class="co">#&gt; 1 1 3</span></a></code></pre></div></li>
<li><p><code>base::subset()</code> always evaluates <code>rows</code> in the parent frame, but if <code>...</code>
has been used, then the expression might need to be evaluated elsewhere:</p>
<div class="sourceCode" id="cb855"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb855-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(df, ...) {</a>
<a class="sourceLine" id="cb855-2" data-line-number="2">  xval &lt;-<span class="st"> </span><span class="dv">3</span></a>
<a class="sourceLine" id="cb855-3" data-line-number="3">  <span class="kw">subset</span>(df, ...)</a>
<a class="sourceLine" id="cb855-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb855-5" data-line-number="5"></a>
<a class="sourceLine" id="cb855-6" data-line-number="6">xval &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb855-7" data-line-number="7"><span class="kw">f</span>(df, x <span class="op">==</span><span class="st"> </span>xval)</a>
<a class="sourceLine" id="cb855-8" data-line-number="8"><span class="co">#&gt;   x y</span></a>
<a class="sourceLine" id="cb855-9" data-line-number="9"><span class="co">#&gt; 3 3 1</span></a></code></pre></div>
<p>Because <code>enquo()</code> captures the environment of the argument as well as its
expression, this is not a problem with <code>subset2()</code>:</p>
<div class="sourceCode" id="cb856"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb856-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(df, ...) {</a>
<a class="sourceLine" id="cb856-2" data-line-number="2">  xval &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb856-3" data-line-number="3">  <span class="kw">subset2</span>(df, ...)</a>
<a class="sourceLine" id="cb856-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb856-5" data-line-number="5"></a>
<a class="sourceLine" id="cb856-6" data-line-number="6">xval &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb856-7" data-line-number="7"><span class="kw">f</span>(df, x <span class="op">==</span><span class="st"> </span>xval)</a>
<a class="sourceLine" id="cb856-8" data-line-number="8"><span class="co">#&gt;   x y</span></a>
<a class="sourceLine" id="cb856-9" data-line-number="9"><span class="co">#&gt; 1 1 3</span></a></code></pre></div></li>
<li><p>Finally, <code>eval()</code> doesn’t provide any pronouns so there’s no way to write
a safe version of <code>threshold_x()</code>.</p></li>
</ul>
<p>You might wonder if all this rigamorale is worth it when you can just use <code>[</code>. Firstly, it seems unappealing to have functions that can only be used safely in an interactive context. That would mean that every interactive function needs to be paired with function suitable for programing. Secondly, even the simple <code>subset()</code> function provides two useful features compared to <code>[</code>:</p>
<ul>
<li>It sets <code>drop = FALSE</code> by default, so it’s guaranteed to return a data frame</li>
<li>It drops rows where the condition evaluates to <code>NA</code>.</li>
</ul>
<p>That means <code>subset(df, x == y)</code> is not equivalent to <code>df[x == y,]</code> as you might expect. Instead, it is equivalent to <code>df[x == y &amp; !is.na(x == y), , drop = FALSE]</code>: that’s a lot more typing!</p>
</div>
<div id="tidy-eval-performance" class="section level3">
<h3><span class="header-section-number">20.4.6</span> Performance</h3>
<p>Note that there is some performance overhead when evaluating a quosure compared to evaluating an expression:</p>
<div class="sourceCode" id="cb857"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb857-1" data-line-number="1">n &lt;-<span class="st"> </span><span class="dv">1000</span></a>
<a class="sourceLine" id="cb857-2" data-line-number="2">x1 &lt;-<span class="st"> </span><span class="kw">expr</span>(<span class="kw">runif</span>(n))</a>
<a class="sourceLine" id="cb857-3" data-line-number="3">e1 &lt;-<span class="st"> </span><span class="kw">globalenv</span>()</a>
<a class="sourceLine" id="cb857-4" data-line-number="4">q1 &lt;-<span class="st"> </span><span class="kw">quo</span>(<span class="kw">runif</span>(n))</a>
<a class="sourceLine" id="cb857-5" data-line-number="5"></a>
<a class="sourceLine" id="cb857-6" data-line-number="6">microbenchmark<span class="op">::</span><span class="kw">microbenchmark</span>(</a>
<a class="sourceLine" id="cb857-7" data-line-number="7">  <span class="kw">runif</span>(n),</a>
<a class="sourceLine" id="cb857-8" data-line-number="8">  <span class="kw">eval_bare</span>(x1, e1),</a>
<a class="sourceLine" id="cb857-9" data-line-number="9">  <span class="kw">eval_tidy</span>(q1),</a>
<a class="sourceLine" id="cb857-10" data-line-number="10">  <span class="kw">eval_tidy</span>(q1, mtcars)</a>
<a class="sourceLine" id="cb857-11" data-line-number="11">)</a>
<a class="sourceLine" id="cb857-12" data-line-number="12"><span class="co">#&gt; Unit: microseconds</span></a>
<a class="sourceLine" id="cb857-13" data-line-number="13"><span class="co">#&gt;                   expr  min   lq mean median   uq   max neval</span></a>
<a class="sourceLine" id="cb857-14" data-line-number="14"><span class="co">#&gt;               runif(n) 26.9 28.5 34.1   32.1 34.9  85.5   100</span></a>
<a class="sourceLine" id="cb857-15" data-line-number="15"><span class="co">#&gt;      eval_bare(x1, e1) 27.5 31.7 35.6   34.8 36.2  86.9   100</span></a>
<a class="sourceLine" id="cb857-16" data-line-number="16"><span class="co">#&gt;          eval_tidy(q1) 29.5 31.9 36.2   34.8 38.3  74.2   100</span></a>
<a class="sourceLine" id="cb857-17" data-line-number="17"><span class="co">#&gt;  eval_tidy(q1, mtcars) 32.3 36.0 42.9   39.5 42.1 332.9   100</span></a></code></pre></div>
<p>However, most of the overhead is due to setting up the data mask so if you need to evaluate code repeatedly, it’s a good idea to define the data mask once then reuse it. This considerably reduces the overhead, with a small change in behaviour: if the code being evaluated creates objects in the “current” environment, those objects will persist across calls.</p>
<div class="sourceCode" id="cb858"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb858-1" data-line-number="1">d_mtcars &lt;-<span class="st"> </span><span class="kw">as_data_mask</span>(mtcars)</a>
<a class="sourceLine" id="cb858-2" data-line-number="2"></a>
<a class="sourceLine" id="cb858-3" data-line-number="3">microbenchmark<span class="op">::</span><span class="kw">microbenchmark</span>(</a>
<a class="sourceLine" id="cb858-4" data-line-number="4">  <span class="kw">as_data_mask</span>(mtcars), </a>
<a class="sourceLine" id="cb858-5" data-line-number="5">  <span class="kw">eval_tidy</span>(q1, mtcars),</a>
<a class="sourceLine" id="cb858-6" data-line-number="6">  <span class="kw">eval_tidy</span>(q1, d_mtcars)</a>
<a class="sourceLine" id="cb858-7" data-line-number="7">)</a>
<a class="sourceLine" id="cb858-8" data-line-number="8"><span class="co">#&gt; Unit: microseconds</span></a>
<a class="sourceLine" id="cb858-9" data-line-number="9"><span class="co">#&gt;                     expr   min    lq  mean median    uq  max neval</span></a>
<a class="sourceLine" id="cb858-10" data-line-number="10"><span class="co">#&gt;     as_data_mask(mtcars)  4.01  4.56  5.25   5.02  5.58 21.8   100</span></a>
<a class="sourceLine" id="cb858-11" data-line-number="11"><span class="co">#&gt;    eval_tidy(q1, mtcars) 31.55 32.97 35.40  34.46 37.59 46.4   100</span></a>
<a class="sourceLine" id="cb858-12" data-line-number="12"><span class="co">#&gt;  eval_tidy(q1, d_mtcars) 28.03 29.07 30.75  30.22 32.64 38.5   100</span></a></code></pre></div>
</div>
<div id="exercises-64" class="section level3">
<h3><span class="header-section-number">20.4.7</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>Improve <code>subset2()</code> to make it more like <code>base::subset()</code>:</p>
<ul>
<li>Drop rows where <code>subset</code> evaluates to <code>NA</code>.</li>
<li>Give a clear error message if <code>subset</code> doesn’t yield a logical vector.</li>
<li>What happens if <code>subset</code> yields a vector that’s not the same as the
number rows in <code>data</code>? What do you think should happen?</li>
</ul></li>
<li><p>The third argument in <code>base::subset()</code> allows you to select variables. It
treats variable names as if they were positions. This allows you to do
things like <code>subset(mtcars, , -cyl)</code> to drop the cylinder variable, or
<code>subset(mtcars, , disp:drat)</code> to select all the variables between <code>disp</code>
and <code>drat</code>. How does this work? I’ve made this easier to understand by
extracting it out into its own function that uses tidy evaluation.</p>
<div class="sourceCode" id="cb859"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb859-1" data-line-number="1">select &lt;-<span class="st"> </span><span class="cf">function</span>(df, vars) {</a>
<a class="sourceLine" id="cb859-2" data-line-number="2">  vars &lt;-<span class="st"> </span><span class="kw">enexpr</span>(vars)</a>
<a class="sourceLine" id="cb859-3" data-line-number="3">  var_pos &lt;-<span class="st"> </span><span class="kw">set_names</span>(<span class="kw">as.list</span>(<span class="kw">seq_along</span>(df)), <span class="kw">names</span>(df))</a>
<a class="sourceLine" id="cb859-4" data-line-number="4"></a>
<a class="sourceLine" id="cb859-5" data-line-number="5">  cols &lt;-<span class="st"> </span><span class="kw">eval_tidy</span>(vars, var_pos)</a>
<a class="sourceLine" id="cb859-6" data-line-number="6">  df[, cols, drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb859-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb859-8" data-line-number="8"><span class="kw">select</span>(mtcars, <span class="op">-</span>cyl)</a></code></pre></div></li>
<li><p>Here’s an alternative implementation of <code>arrange()</code>:</p>
<div class="sourceCode" id="cb860"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb860-1" data-line-number="1">invoke &lt;-<span class="st"> </span><span class="cf">function</span>(fun, ...) <span class="kw">do.call</span>(fun, <span class="kw">dots_list</span>(...))</a>
<a class="sourceLine" id="cb860-2" data-line-number="2">arrange3 &lt;-<span class="st"> </span><span class="cf">function</span>(.data, ..., <span class="dt">.na.last =</span> <span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb860-3" data-line-number="3">  args &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)</a>
<a class="sourceLine" id="cb860-4" data-line-number="4"></a>
<a class="sourceLine" id="cb860-5" data-line-number="5">  ords &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">map</span>(args, eval_tidy, <span class="dt">data =</span> .data)</a>
<a class="sourceLine" id="cb860-6" data-line-number="6">  ord &lt;-<span class="st"> </span><span class="kw">invoke</span>(order, <span class="op">!!!</span>ords, <span class="dt">na.last =</span> .na.last)</a>
<a class="sourceLine" id="cb860-7" data-line-number="7"></a>
<a class="sourceLine" id="cb860-8" data-line-number="8">  .data[ord, , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb860-9" data-line-number="9">}</a></code></pre></div>
<p>Describe the primary difference in approach compared to the function
defined in the text.</p>
<p>One advantage of this approach is that you could check each element
of <code>...</code> to make sure that input is correct. What property should each
element of <code>ords</code> have?</p></li>
<li><p>Here’s an alternative implementation of <code>subset2()</code>:</p>
<div class="sourceCode" id="cb861"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb861-1" data-line-number="1">subset3 &lt;-<span class="st"> </span><span class="cf">function</span>(data, rows) {</a>
<a class="sourceLine" id="cb861-2" data-line-number="2">  <span class="kw">eval_tidy</span>(<span class="kw">quo</span>(data[<span class="op">!!</span><span class="kw">enquo</span>(rows), , <span class="dt">drop =</span> <span class="ot">FALSE</span>]), <span class="dt">data =</span> data)</a>
<a class="sourceLine" id="cb861-3" data-line-number="3">}</a></code></pre></div>
<p>Use intermediate variables to make the function easier to understand, then
explain how this approach differs to the approach in the text.</p></li>
<li><p>Implement a form of <code>arrange()</code> where you can request a variable to be
sorted in descending order using named arguments:</p>
<div class="sourceCode" id="cb862"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb862-1" data-line-number="1"><span class="kw">arrange</span>(mtcars, cyl, <span class="dt">desc =</span> mpg, vs)</a></code></pre></div>
<p>(Hint: The <code>decreasing</code> argument to <code>order()</code> will not help you. Instead,
look at the definition of <code>dplyr::desc()</code>, and read the help for <code>xtfrm()</code>.)</p></li>
<li><p>Why do you not need to worry about ambiguous argument names with <code>...</code> in
<code>arrange()</code>? Why is it a good idea to use the <code>.</code> prefix anyway?</p></li>
<li><p>What does <code>transform()</code> do? Read the documentation. How does it work?
Read the source code for <code>transform.data.frame()</code>. What does
<code>substitute(list(...))</code> do?</p></li>
<li><p>Use tidy evaluation to implement your own version of <code>transform()</code>.
Extend it so that a calculation can refer to variables created by
transform, i.e. make this work:</p>
<div class="sourceCode" id="cb863"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb863-1" data-line-number="1">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a>
<a class="sourceLine" id="cb863-2" data-line-number="2"><span class="kw">transform</span>(df, <span class="dt">x1 =</span> x <span class="op">+</span><span class="st"> </span><span class="dv">1</span>, <span class="dt">x2 =</span> x1 <span class="op">+</span><span class="st"> </span><span class="dv">1</span>)</a>
<a class="sourceLine" id="cb863-3" data-line-number="3"><span class="co">#&gt; Error in x1 + 1:</span></a>
<a class="sourceLine" id="cb863-4" data-line-number="4"><span class="co">#&gt;   non-numeric argument to binary operator</span></a></code></pre></div></li>
<li><p>What does <code>with()</code> do? How does it work? Read the source code for
<code>with.default()</code>. What does <code>within()</code> do? How does it work? Read the
source code for <code>within.data.frame()</code>. Why is the code so much more
complex than <code>with()</code>?</p></li>
<li><p>Implement a version of <code>within.data.frame()</code> that uses tidy evaluation.
Read the documentation and make sure that you understand what <code>within()</code>
does, then read the source code.</p></li>
</ol>
</div>
</div>
<div id="wrapping-quoting-functions" class="section level2">
<h2><span class="header-section-number">20.5</span> Wrapping quoting functions</h2>
<p>Now we have all the tools we need to wrap a quoting function inside another function, regardless of whether the quoting function uses tidy evaluation or base R. This is important because it allows you to reduce duplication by turning repeated code into functions. It’s straightforward to do this for evaluated arguments; now you’ll learn the techniques that allow you to wrap quoted arguments.</p>
<div id="tidy-evaluation-1" class="section level3">
<h3><span class="header-section-number">20.5.1</span> Tidy evaluation</h3>
<p>If you need to wrap a function that quasi-quotes one of its arguments, it’s simple to wrap. You just need to quote and unquote. Take this repeat code:</p>
<div class="sourceCode" id="cb864"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb864-1" data-line-number="1">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(x1) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(y1))</a>
<a class="sourceLine" id="cb864-2" data-line-number="2">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(x2) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(y2))</a>
<a class="sourceLine" id="cb864-3" data-line-number="3">df <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">group_by</span>(x3) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(y3))</a></code></pre></div>
<p>If no arguments were quoted, we could remove the duplication with:</p>
<div class="sourceCode" id="cb865"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb865-1" data-line-number="1">grouped_mean &lt;-<span class="st"> </span><span class="cf">function</span>(df, group_var, summary_var) {</a>
<a class="sourceLine" id="cb865-2" data-line-number="2">  df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb865-3" data-line-number="3"><span class="st">    </span><span class="kw">group_by</span>(group_var) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb865-4" data-line-number="4"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(summary_var))</a>
<a class="sourceLine" id="cb865-5" data-line-number="5">}</a></code></pre></div>
<p>However, both <code>group_by()</code> and <code>summarise()</code> quote their second and subsequent arguments. That means we need to quote <code>group_var</code> and <code>summary_var</code> and then unquote when we call <code>group_by()</code> and <code>summarise()</code>:</p>
<div class="sourceCode" id="cb866"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb866-1" data-line-number="1">grouped_mean &lt;-<span class="st"> </span><span class="cf">function</span>(df, group_var, summary_var) {</a>
<a class="sourceLine" id="cb866-2" data-line-number="2">  group_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(group_var)</a>
<a class="sourceLine" id="cb866-3" data-line-number="3">  summary_var &lt;-<span class="st"> </span><span class="kw">enquo</span>(summary_var)</a>
<a class="sourceLine" id="cb866-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb866-5" data-line-number="5">  df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb866-6" data-line-number="6"><span class="st">    </span><span class="kw">group_by</span>(<span class="op">!!</span>group_var) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb866-7" data-line-number="7"><span class="st">    </span><span class="kw">summarise</span>(<span class="dt">mean =</span> <span class="kw">mean</span>(<span class="op">!!</span>summary_var))</a>
<a class="sourceLine" id="cb866-8" data-line-number="8">}</a></code></pre></div>
<p>Just remember that quoting is infectious, so whenever you call a quoting function you need to quote and then unquote.</p>
</div>
<div id="base-r-1" class="section level3">
<h3><span class="header-section-number">20.5.2</span> Base R</h3>
<p>Unfortunately, things are bit more complex if you want to wrap a base R function that quotes an argument. We can no longer rely on tidy evaluation everywhere, because the semantics of NSE functions are not quite rich enough, but we can use it to generate a mostly correct solution. The wrappers that we create can be used interactively, but can not in turn be easily wrapped. This makes them useful for reducing duplication in your analysis code, but not suitable for inclusion in a package.</p>
<p>We’ll focus on wrapping models because this is a common need, and illustrates the spectrum of challenges you’ll need to overcome for any other base funtion. Let’s start with a very simple wrapper around <code>lm()</code>:</p>
<div class="sourceCode" id="cb867"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb867-1" data-line-number="1">lm2 &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data) {</a>
<a class="sourceLine" id="cb867-2" data-line-number="2">  <span class="kw">lm</span>(formula, data)</a>
<a class="sourceLine" id="cb867-3" data-line-number="3">}</a></code></pre></div>
<p>This wrapper works, but is suboptimal because <code>lm()</code> captures its call, and displays it when printing:</p>
<div class="sourceCode" id="cb868"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb868-1" data-line-number="1"><span class="kw">lm2</span>(mpg <span class="op">~</span><span class="st"> </span>disp, mtcars)</a>
<a class="sourceLine" id="cb868-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb868-3" data-line-number="3"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb868-4" data-line-number="4"><span class="co">#&gt; lm(formula = formula, data = data)</span></a>
<a class="sourceLine" id="cb868-5" data-line-number="5"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb868-6" data-line-number="6"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb868-7" data-line-number="7"><span class="co">#&gt; (Intercept)         disp  </span></a>
<a class="sourceLine" id="cb868-8" data-line-number="8"><span class="co">#&gt;     29.5999      -0.0412</span></a></code></pre></div>
<p>This is important because this call is the chief way that you see the model specification when printing the model. To overcome this problem, we need to capture the arguments, create the call to <code>lm()</code> using unquoting, then evaluate that call:</p>
<div class="sourceCode" id="cb869"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb869-1" data-line-number="1">lm3 &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data) {</a>
<a class="sourceLine" id="cb869-2" data-line-number="2">  formula &lt;-<span class="st"> </span><span class="kw">enexpr</span>(formula)</a>
<a class="sourceLine" id="cb869-3" data-line-number="3">  data &lt;-<span class="st"> </span><span class="kw">enexpr</span>(data)</a>
<a class="sourceLine" id="cb869-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb869-5" data-line-number="5">  lm_call &lt;-<span class="st"> </span><span class="kw">expr</span>(<span class="kw">lm</span>(<span class="op">!!</span>formula, <span class="dt">data =</span> <span class="op">!!</span>data))</a>
<a class="sourceLine" id="cb869-6" data-line-number="6">  <span class="kw">eval_bare</span>(lm_call, <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb869-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb869-8" data-line-number="8"><span class="kw">lm3</span>(mpg <span class="op">~</span><span class="st"> </span>disp, mtcars)<span class="op">$</span>call</a>
<a class="sourceLine" id="cb869-9" data-line-number="9"><span class="co">#&gt; lm(formula = mpg ~ disp, data = mtcars)</span></a></code></pre></div>
<p>Note that we manually supply an evaluation environment, <code>caller_env()</code>. We’ll discuss that in more detail shortly.</p>
<p>Note that this technique works for all the arguments, even those that use NSE, like <code>subset()</code>:</p>
<div class="sourceCode" id="cb870"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb870-1" data-line-number="1">lm4 &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, <span class="dt">subset =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb870-2" data-line-number="2">  formula &lt;-<span class="st"> </span><span class="kw">enexpr</span>(formula)</a>
<a class="sourceLine" id="cb870-3" data-line-number="3">  data &lt;-<span class="st"> </span><span class="kw">enexpr</span>(data)</a>
<a class="sourceLine" id="cb870-4" data-line-number="4">  subset &lt;-<span class="st"> </span><span class="kw">enexpr</span>(subset)</a>
<a class="sourceLine" id="cb870-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb870-6" data-line-number="6">  lm_call &lt;-<span class="st"> </span><span class="kw">expr</span>(<span class="kw">lm</span>(<span class="op">!!</span>formula, <span class="dt">data =</span> <span class="op">!!</span>data, <span class="dt">subset =</span> <span class="op">!!</span>subset))</a>
<a class="sourceLine" id="cb870-7" data-line-number="7">  <span class="kw">eval_bare</span>(lm_call, <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb870-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb870-9" data-line-number="9"><span class="kw">coef</span>(<span class="kw">lm4</span>(mpg <span class="op">~</span><span class="st"> </span>disp, mtcars))</a>
<a class="sourceLine" id="cb870-10" data-line-number="10"><span class="co">#&gt; (Intercept)        disp </span></a>
<a class="sourceLine" id="cb870-11" data-line-number="11"><span class="co">#&gt;     29.5999     -0.0412</span></a>
<a class="sourceLine" id="cb870-12" data-line-number="12"><span class="kw">coef</span>(<span class="kw">lm4</span>(mpg <span class="op">~</span><span class="st"> </span>disp, mtcars, <span class="dt">subset =</span> cyl <span class="op">==</span><span class="st"> </span><span class="dv">4</span>))</a>
<a class="sourceLine" id="cb870-13" data-line-number="13"><span class="co">#&gt; (Intercept)        disp </span></a>
<a class="sourceLine" id="cb870-14" data-line-number="14"><span class="co">#&gt;      40.872      -0.135</span></a></code></pre></div>
<p>Note that I’ve supplied a default argument to <code>subset</code>. I think this is good practice because it clearly indicates that <code>subset</code> is optional: arguments with no default are usually required. <code>NULL</code> has two nice properties here:</p>
<ol style="list-style-type: decimal">
<li><p><code>lm()</code> already knows how to handle <code>subset = NULL</code>: it treats it the
same way as a missing <code>subset</code>.</p></li>
<li><p><code>expr(NULL)</code> is <code>NULL</code>; which makes it easier to detect programmatically.</p></li>
</ol>
<p>However, the current approach has one small downside: <code>subset = NULL</code> is shown in the call.</p>
<div class="sourceCode" id="cb871"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb871-1" data-line-number="1"><span class="kw">lm4</span>(mpg <span class="op">~</span><span class="st"> </span>disp, mtcars)<span class="op">$</span>call</a>
<a class="sourceLine" id="cb871-2" data-line-number="2"><span class="co">#&gt; lm(formula = mpg ~ disp, data = mtcars, subset = NULL)</span></a></code></pre></div>
<p>It’s possible, if a little more work, to generate a call where <code>subset</code> is simply absent. There are two tricks needed to do this:</p>
<ol style="list-style-type: decimal">
<li><p>We use the <code>%||%</code> helper to replace a <code>NULL</code> subset with <code>missing_arg()</code>.</p></li>
<li><p>We use <code>maybe_missing()</code> in <code>expr()</code>: if we don’t do that the
essential weirdness of the missing argument crops up and generates an error.</p></li>
</ol>
<p>This leads to <code>lm5()</code>:</p>
<div class="sourceCode" id="cb872"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb872-1" data-line-number="1">lm5 &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, <span class="dt">subset =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb872-2" data-line-number="2">  formula &lt;-<span class="st"> </span><span class="kw">enexpr</span>(formula)</a>
<a class="sourceLine" id="cb872-3" data-line-number="3">  data &lt;-<span class="st"> </span><span class="kw">enexpr</span>(data)</a>
<a class="sourceLine" id="cb872-4" data-line-number="4">  subset &lt;-<span class="st"> </span><span class="kw">enexpr</span>(subset) <span class="op">%||%</span><span class="st"> </span><span class="kw">missing_arg</span>()</a>
<a class="sourceLine" id="cb872-5" data-line-number="5">  </a>
<a class="sourceLine" id="cb872-6" data-line-number="6">  lm_call &lt;-<span class="st"> </span><span class="kw">expr</span>(<span class="kw">lm</span>(<span class="op">!!</span>formula, <span class="dt">data =</span> <span class="op">!!</span>data, <span class="dt">subset =</span> <span class="op">!!</span><span class="kw">maybe_missing</span>(subset)))</a>
<a class="sourceLine" id="cb872-7" data-line-number="7">  <span class="kw">eval_bare</span>(lm_call, <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb872-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb872-9" data-line-number="9"><span class="kw">lm5</span>(mpg <span class="op">~</span><span class="st"> </span>disp, mtcars)<span class="op">$</span>call</a>
<a class="sourceLine" id="cb872-10" data-line-number="10"><span class="co">#&gt; lm(formula = mpg ~ disp, data = mtcars)</span></a></code></pre></div>
<p>Note that all these wrappers have one small advantage over <code>lm()</code>: we can use unquoting.</p>
<div class="sourceCode" id="cb873"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb873-1" data-line-number="1">f &lt;-<span class="st"> </span>mpg <span class="op">~</span><span class="st"> </span>disp</a>
<a class="sourceLine" id="cb873-2" data-line-number="2"><span class="kw">lm5</span>(<span class="op">!!</span>f, mtcars)<span class="op">$</span>call</a>
<a class="sourceLine" id="cb873-3" data-line-number="3"><span class="co">#&gt; lm(formula = mpg ~ disp, data = mtcars)</span></a>
<a class="sourceLine" id="cb873-4" data-line-number="4"></a>
<a class="sourceLine" id="cb873-5" data-line-number="5">resp &lt;-<span class="st"> </span><span class="kw">expr</span>(mpg)</a>
<a class="sourceLine" id="cb873-6" data-line-number="6"><span class="kw">lm5</span>(<span class="op">!!</span>resp <span class="op">~</span><span class="st"> </span>disp, mtcars)<span class="op">$</span>call</a>
<a class="sourceLine" id="cb873-7" data-line-number="7"><span class="co">#&gt; lm(formula = mpg ~ disp, data = mtcars)</span></a></code></pre></div>
</div>
<div id="the-evaluation-environment" class="section level3">
<h3><span class="header-section-number">20.5.3</span> The evaluation environment</h3>
<p>What if you want to mingle objects supplied by the user with objects that you create in the function? For example, imagine you want to make an auto-bootstrapping version of <code>lm()</code>. You might write it like this:</p>
<div class="sourceCode" id="cb874"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb874-1" data-line-number="1">boot_lm0 &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data) {</a>
<a class="sourceLine" id="cb874-2" data-line-number="2">  formula &lt;-<span class="st"> </span><span class="kw">enexpr</span>(formula)</a>
<a class="sourceLine" id="cb874-3" data-line-number="3">  boot_data &lt;-<span class="st"> </span>data[<span class="kw">sample</span>(<span class="kw">nrow</span>(data), <span class="dt">replace =</span> <span class="ot">TRUE</span>), , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb874-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb874-5" data-line-number="5">  lm_call &lt;-<span class="st"> </span><span class="kw">expr</span>(<span class="kw">lm</span>(<span class="op">!!</span>formula, <span class="dt">data =</span> boot_data))</a>
<a class="sourceLine" id="cb874-6" data-line-number="6">  <span class="kw">eval_bare</span>(lm_call, <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb874-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb874-8" data-line-number="8"></a>
<a class="sourceLine" id="cb874-9" data-line-number="9">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">y =</span> <span class="dv">5</span> <span class="op">+</span><span class="st"> </span><span class="dv">3</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) <span class="op">+</span><span class="st"> </span><span class="kw">rnorm</span>(<span class="dv">10</span>))</a>
<a class="sourceLine" id="cb874-10" data-line-number="10"><span class="kw">boot_lm0</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> df)</a>
<a class="sourceLine" id="cb874-11" data-line-number="11"><span class="co">#&gt; Error in is.data.frame(data):</span></a>
<a class="sourceLine" id="cb874-12" data-line-number="12"><span class="co">#&gt;   object &#39;boot_data&#39; not found</span></a></code></pre></div>
<p>Why doesn’t this code work? It’s because we’re evaluating <code>lm_call</code> in the caller environment, but <code>boot_data</code> exists in the execution environment. We could instead evaluate in the execution environment of <code>boot_lm0()</code>, but there’s no guarantee that <code>formula</code> could be evaluated in that environment.</p>
<p>There are two basic ways to overcome this challenge:</p>
<ol style="list-style-type: decimal">
<li><p>Unquote the data frame into the call. This means that no look up has
to occur, but has all the problems of inlining expressions. For modelling
functions this means that captured call is suboptimal:</p>
<div class="sourceCode" id="cb875"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb875-1" data-line-number="1">boot_lm1 &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data) {</a>
<a class="sourceLine" id="cb875-2" data-line-number="2">  formula &lt;-<span class="st"> </span><span class="kw">enexpr</span>(formula)</a>
<a class="sourceLine" id="cb875-3" data-line-number="3">  boot_data &lt;-<span class="st"> </span>data[<span class="kw">sample</span>(<span class="kw">nrow</span>(data), <span class="dt">replace =</span> <span class="ot">TRUE</span>), , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb875-4" data-line-number="4"></a>
<a class="sourceLine" id="cb875-5" data-line-number="5">  lm_call &lt;-<span class="st"> </span><span class="kw">expr</span>(<span class="kw">lm</span>(<span class="op">!!</span>formula, <span class="dt">data =</span> <span class="op">!!</span>boot_data))</a>
<a class="sourceLine" id="cb875-6" data-line-number="6">  <span class="kw">eval_bare</span>(lm_call, <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb875-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb875-8" data-line-number="8"><span class="kw">boot_lm1</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> df)<span class="op">$</span>call</a>
<a class="sourceLine" id="cb875-9" data-line-number="9"><span class="co">#&gt; lm(formula = y ~ x, data = list(x = c(3L, 6L, 7L, 9L, 9L, 9L, </span></a>
<a class="sourceLine" id="cb875-10" data-line-number="10"><span class="co">#&gt; 4L, 1L, 7L, 3L), y = c(14.6648781752736, 22.1126241808277, 25.9200218389642, </span></a>
<a class="sourceLine" id="cb875-11" data-line-number="11"><span class="co">#&gt; 33.1201105917209, 33.1201105917209, 33.1201105917209, 17.4530448354519, </span></a>
<a class="sourceLine" id="cb875-12" data-line-number="12"><span class="co">#&gt; 7.91010669552239, 25.9200218389642, 14.6648781752736)))</span></a></code></pre></div></li>
<li><p>Alternatively you can create a new environment that inherits from the
caller, and you can bind variables that you’ve created inside the
function to that environment.</p>
<div class="sourceCode" id="cb876"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb876-1" data-line-number="1">boot_lm2 &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data) {</a>
<a class="sourceLine" id="cb876-2" data-line-number="2">  formula &lt;-<span class="st"> </span><span class="kw">enexpr</span>(formula)</a>
<a class="sourceLine" id="cb876-3" data-line-number="3">  boot_data &lt;-<span class="st"> </span>data[<span class="kw">sample</span>(<span class="kw">nrow</span>(data), <span class="dt">replace =</span> <span class="ot">TRUE</span>), , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb876-4" data-line-number="4"></a>
<a class="sourceLine" id="cb876-5" data-line-number="5">  lm_env &lt;-<span class="st"> </span><span class="kw">child_env</span>(<span class="kw">caller_env</span>(), <span class="dt">boot_data =</span> boot_data)</a>
<a class="sourceLine" id="cb876-6" data-line-number="6">  lm_call &lt;-<span class="st"> </span><span class="kw">expr</span>(<span class="kw">lm</span>(<span class="op">!!</span>formula, <span class="dt">data =</span> boot_data))</a>
<a class="sourceLine" id="cb876-7" data-line-number="7">  <span class="kw">eval_bare</span>(lm_call, lm_env)</a>
<a class="sourceLine" id="cb876-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb876-9" data-line-number="9"><span class="kw">boot_lm2</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> df)</a>
<a class="sourceLine" id="cb876-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb876-11" data-line-number="11"><span class="co">#&gt; Call:</span></a>
<a class="sourceLine" id="cb876-12" data-line-number="12"><span class="co">#&gt; lm(formula = y ~ x, data = boot_data)</span></a>
<a class="sourceLine" id="cb876-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb876-14" data-line-number="14"><span class="co">#&gt; Coefficients:</span></a>
<a class="sourceLine" id="cb876-15" data-line-number="15"><span class="co">#&gt; (Intercept)            x  </span></a>
<a class="sourceLine" id="cb876-16" data-line-number="16"><span class="co">#&gt;        5.12         2.88</span></a></code></pre></div></li>
</ol>
</div>
<div id="making-formulas" class="section level3">
<h3><span class="header-section-number">20.5.4</span> Making formulas</h3>
<p>One final aspect to wrapping modelling functions is generating formulas. You just need to learn about one small wrinkle and then you can use the techniques you learned in <a href="quasiquotation.html#quotation">Quotation</a>. Formulas print the same when evaluated and unevaluated:</p>
<div class="sourceCode" id="cb877"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb877-1" data-line-number="1">y <span class="op">~</span><span class="st"> </span>x</a>
<a class="sourceLine" id="cb877-2" data-line-number="2"><span class="co">#&gt; y ~ x</span></a>
<a class="sourceLine" id="cb877-3" data-line-number="3"><span class="kw">expr</span>(y <span class="op">~</span><span class="st"> </span>x)</a>
<a class="sourceLine" id="cb877-4" data-line-number="4"><span class="co">#&gt; y ~ x</span></a></code></pre></div>
<p>Instead, check the class to make sure you have an actual formula:</p>
<div class="sourceCode" id="cb878"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb878-1" data-line-number="1"><span class="kw">class</span>(y <span class="op">~</span><span class="st"> </span>x)</a>
<a class="sourceLine" id="cb878-2" data-line-number="2"><span class="co">#&gt; [1] &quot;formula&quot;</span></a>
<a class="sourceLine" id="cb878-3" data-line-number="3"><span class="kw">class</span>(<span class="kw">expr</span>(y <span class="op">~</span><span class="st"> </span>x))</a>
<a class="sourceLine" id="cb878-4" data-line-number="4"><span class="co">#&gt; [1] &quot;call&quot;</span></a>
<a class="sourceLine" id="cb878-5" data-line-number="5"><span class="kw">class</span>(<span class="kw">eval_bare</span>(<span class="kw">expr</span>(y <span class="op">~</span><span class="st"> </span>x)))</a>
<a class="sourceLine" id="cb878-6" data-line-number="6"><span class="co">#&gt; [1] &quot;formula&quot;</span></a></code></pre></div>
<p>Once you understand this, you can generate formulas with unquoting and <code>reduce()</code>. Just remember to evaluate the result before returning it. Like in another base NSE wrapper, you should use <code>caller_env()</code> as the evaluation environment.</p>
<p>Here’s a simple example that generates a formula by combining a response variable with a set of predictors.</p>
<div class="sourceCode" id="cb879"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb879-1" data-line-number="1">build_formula &lt;-<span class="st"> </span><span class="cf">function</span>(resp, ...) {</a>
<a class="sourceLine" id="cb879-2" data-line-number="2">  resp &lt;-<span class="st"> </span><span class="kw">enexpr</span>(resp)</a>
<a class="sourceLine" id="cb879-3" data-line-number="3">  preds &lt;-<span class="st"> </span><span class="kw">enexprs</span>(...)</a>
<a class="sourceLine" id="cb879-4" data-line-number="4">  </a>
<a class="sourceLine" id="cb879-5" data-line-number="5">  pred_sum &lt;-<span class="st"> </span>purrr<span class="op">::</span><span class="kw">reduce</span>(preds, <span class="op">~</span><span class="st"> </span><span class="kw">expr</span>(<span class="op">!!</span>.x <span class="op">+</span><span class="st"> </span><span class="op">!!</span>.y))</a>
<a class="sourceLine" id="cb879-6" data-line-number="6">  <span class="kw">eval_bare</span>(<span class="kw">expr</span>(<span class="op">!!</span>resp <span class="op">~</span><span class="st"> </span><span class="op">!!</span>pred_sum), <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb879-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb879-8" data-line-number="8"><span class="kw">build_formula</span>(y, a, b, c)</a>
<a class="sourceLine" id="cb879-9" data-line-number="9"><span class="co">#&gt; y ~ a + b + c</span></a></code></pre></div>
</div>
<div id="exercises-65" class="section level3">
<h3><span class="header-section-number">20.5.5</span> Exercises</h3>
<ol style="list-style-type: decimal">
<li><p>When model building, typically the response and data are relatively
constant while you rapidly experiment with different predictors. Write a
small wrapper that allows you to reduce duplication in this situation.</p>
<div class="sourceCode" id="cb880"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb880-1" data-line-number="1">pred_mpg &lt;-<span class="st"> </span><span class="cf">function</span>(resp, ...) {</a>
<a class="sourceLine" id="cb880-2" data-line-number="2"></a>
<a class="sourceLine" id="cb880-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb880-4" data-line-number="4"><span class="kw">pred_mpg</span>(<span class="op">~</span><span class="st"> </span>disp)</a>
<a class="sourceLine" id="cb880-5" data-line-number="5"><span class="kw">pred_mpg</span>(<span class="op">~</span><span class="st"> </span><span class="kw">I</span>(<span class="dv">1</span> <span class="op">/</span><span class="st"> </span>disp))</a>
<a class="sourceLine" id="cb880-6" data-line-number="6"><span class="kw">pred_mpg</span>(<span class="op">~</span><span class="st"> </span>disp <span class="op">*</span><span class="st"> </span>cyl)</a></code></pre></div></li>
<li><p>Another way to way to write <code>boot_lm()</code> would be to include the
boostrapping expression (<code>data[sample(nrow(data), replace = TRUE), , drop = FALSE]</code>)
in the data argument. Implement that approach. What are the advantages?
What are the disadvantages?</p></li>
<li><p>To make these functions some what more robust, instead of always using
the <code>caller_env()</code> we could capture a quosure, and then use its environment.
However, if there are multiple arguments, they might be associated with
different environments. Write a function that takes a list of quosures,
and returns the common environment, if they have one, or otherwise throws
an error.</p></li>
<li><p>Write a function that takes a data frame and a list of formulas,
fitting a linear model with each formula, generating a useful model call.</p></li>
<li><p>Create a formula generation function that allows you to optionally
supply a transformation function (e.g. <code>log()</code>) to the response or
the predictors.</p></li>
</ol>

</div>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="43">
<li id="fn43"><p><code>eval_tidy()</code> has a <code>env</code> argument, but you only need this if you pass an expression to the first arugment.<a href="evaluation.html#fnref43" class="footnote-back">↩</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="quasiquotation.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="translation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/hadley/adv-r/edit/master/Evaluation.Rmd",
"text": "Edit"
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:" && /^https?:/.test(src))
      src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
